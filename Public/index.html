<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Deli Sandwich 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
  />

  <style>
    /* ---------- Base Layout ---------- */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: "Nunito Sans", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: #0f172a;
      color: #111827;
    }

    body {
      position: relative;
    }

    /* ---------- Map + Views ---------- */
    #mapView {
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    #map {
      position: fixed;
      inset: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 1;
    }

    .leaflet-container {
      width: 100vw !important;
      height: 100vh !important;
    }

    /* ---------- Logo ---------- */
    #logo {
      position: fixed;
      top: 16px;
      left: 16px;
      height: 60px;
      z-index: 2000;
      pointer-events: none; /* float above map, never affect layout */
    }

    /* ---------- Dashboard Toggle & View Switcher ---------- */
    #dashboardToggle {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 2001;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.5);
    }

    #viewSwitcher {
      position: fixed;
      top: 16px;
      right: 140px;
      z-index: 2001;
      display: inline-flex;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.5);
    }

    #viewSwitcher button {
      border: none;
      background: transparent;
      color: #e5e7eb;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    #viewSwitcher button.active {
      background: #f97316;
      color: #111827;
      font-weight: 600;
    }

    /* ---------- Dashboard Panel ---------- */
    #dashboard {
      position: fixed;
      top: 90px;
      left: 16px;
      right: 16px;
      z-index: 1500;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 10px 14px;
      padding: 10px 14px;
      background: rgba(249, 250, 251, 0.97);
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(6px);
    }

    #dashboard.hidden {
      display: none !important;
    }

    #dashboard > div {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    #dashboard label {
      font-weight: 600;
      color: #374151;
    }

    #dashboard select,
    #dashboard input[type="date"] {
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      min-width: 120px;
    }

    #dashboard .status-checkbox {
      font-size: 12px;
      color: #374151;
    }

    #dashboard .status-checkbox input {
      margin-right: 3px;
    }

    #dashboard button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #dashboard button:hover {
      background: #0f172a;
    }

    .dashboard-actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .dashboard-secondary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* CSV Upload bar small styling */
    #csvUploadBar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    #uploadStatus {
      font-size: 12px;
    }

    /* ---------- Stats + Daily Queue + Legend ---------- */
    #statsSummary {
      position: fixed;
      bottom: 20px;
      left: 16px;
      z-index: 1400;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.92);
      color: #e5e7eb;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.65);
    }

    #pinCount {
      position: fixed;
      bottom: 60px;
      left: 16px;
      z-index: 1400;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.65);
    }

    #dailyQueuePanel {
      position: fixed;
      top: 90px;
      right: 16px;
      width: 280px;
      max-height: calc(100vh - 120px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1400;
      border-radius: 14px;
      background: rgba(248, 250, 252, 0.97);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.5);
    }

    #dailyQueuePanel header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    #dailyQueuePanel header button.close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }

    #dailyQueuePanel > div {
      padding: 8px 12px;
    }

    #dailyQueueList {
      list-style: none;
      margin: 0;
      padding: 0 0 8px 0;
      overflow-y: auto;
      max-height: 200px;
      font-size: 12px;
    }

    #dailyQueueList li {
      padding: 4px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    #legend {
      position: fixed;
      bottom: 20px;
      right: 16px;
      z-index: 1400;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(248, 250, 252, 0.98);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.5);
      font-size: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-color {
      width: 16px;
      height: 24px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    /* ---------- Presentation Overlay ---------- */
    .presentation-overlay {
      position: fixed;
      inset: 0;
      z-index: 1600;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
    }

    .presentation-overlay.hidden {
      display: none;
    }

    .presentation-inner {
      position: relative;
      max-width: 1100px;
      width: 100%;
      max-height: 100%;
      overflow: auto;
      padding: 24px 24px 20px;
      border-radius: 18px;
      background: #020617;
      color: #e5e7eb;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .presentation-close {
      position: absolute;
      top: 12px;
      right: 12px;
      border: none;
      background: transparent;
      font-size: 18px;
      color: #9ca3af;
      cursor: pointer;
    }

    .presentation-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 4px;
      color: #f9fafb;
    }

    .presentation-subtitle {
      font-size: 13px;
      font-weight: 500;
      margin: 0 0 12px;
      color: #9ca3af;
    }

    .presentation-ai {
      margin-bottom: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .presentation-ai-kpis {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 10px;
      font-size: 12px;
      color: #e5e7eb;
    }

    .presentation-ai-narrative {
      margin-top: 6px;
      font-size: 12px;
      color: #94a3b8;
      line-height: 1.5;
    }

    .presentation-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-start;
    }

    .pipeline-funnel {
      flex: 1 1 220px;
      display: flex;
      flex-direction: column-reverse;
      gap: 6px;
    }

    .funnel-band {
      border-radius: 999px;
      overflow: hidden;
      background: rgba(15, 23, 42, 1);
      border: 1px solid rgba(75, 85, 99, 0.8);
    }

    .funnel-band-inner {
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #e5e7eb;
    }

    .funnel-cold .funnel-band-inner {
      background: linear-gradient(to right, #0f172a, #1d4ed8);
    }

    .funnel-followup .funnel-band-inner {
      background: linear-gradient(to right, #0f172a, #fbbf24);
    }

    .funnel-warm .funnel-band-inner {
      background: linear-gradient(to right, #0f172a, #fb923c);
    }

    .funnel-hot .funnel-band-inner {
      background: linear-gradient(to right, #0f172a, #ef4444);
    }

    .funnel-converted .funnel-band-inner {
      background: linear-gradient(to right, #0f172a, #22c55e);
    }

    .pipeline-legend {
      flex: 1 1 260px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }

    .legend-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .legend-emoji {
      font-size: 18px;
      line-height: 1;
    }

    .legend-text {
      flex: 1;
    }

    .legend-title {
      font-size: 12px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .legend-notes-line {
      height: 1px;
      margin: 3px 0;
      background: rgba(148, 163, 184, 0.6);
    }

    .legend-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .presentation-trophy-panel {
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: 14px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .trophy-header-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }

    .trophy-title-wrap {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .trophy-emoji {
      font-size: 22px;
    }

    .trophy-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .trophy-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .trophy-kpi-label {
      display: block;
      font-size: 11px;
      color: #9ca3af;
    }

    .trophy-kpi-value {
      font-size: 18px;
      font-weight: 700;
      color: #22c55e;
    }

    .trophy-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .trophy-win-empty {
      font-size: 11px;
      color: #9ca3af;
    }

    .presentation-icp-panel {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 14px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 12px;
    }

    .icp-header {
      margin-bottom: 8px;
    }

    .icp-title {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 13px;
    }

    .icp-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .icp-tiles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    /* ---------- List View ---------- */
    #listView {
      position: absolute;
      inset: 0;
      background: #f3f4f6;
      display: none;
      z-index: 10;
      overflow: hidden;
      font-size: 13px;
      color: #111827;
    }

    #listView.show {
      display: block;
    }

    #listToolbar {
      position: sticky;
      top: 0;
      z-index: 11;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 8px 12px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.05);
    }

    #listToolbar input[type="search"] {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      min-width: 220px;
      font-size: 13px;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip .icon {
      font-size: 14px;
    }

    .chip.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    #listContent {
      height: calc(100vh - 52px);
      overflow: auto;
    }

    #leadTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #ffffff;
    }

    #leadTable thead {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    #leadTable th,
    #leadTable td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    #leadTable tbody tr {
      cursor: pointer;
    }

    #leadTable tbody tr:hover {
      background: #f3f4f6;
    }

    #leadCount {
      padding: 8px 12px;
      font-size: 12px;
      color: #4b5563;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }

    /* ---------- Slide-in Account 360 ---------- */
    .slide-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 380px;
      max-width: 100%;
      height: 100vh;
      background: #ffffff;
      box-shadow: -10px 0 25px rgba(15, 23, 42, 0.45);
      transform: translateX(100%);
      transition: transform 0.2s ease-out;
      z-index: 1800;
      overflow: auto;
      padding: 12px;
      font-size: 13px;
    }

    .slide-panel.open {
      transform: translateX(0);
    }

    /* ---------- Add Lead Modal ---------- */
    #addLeadModalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1900;
    }

    #addLeadModalOverlay.open {
      display: flex;
    }

    #addLeadModal {
      width: 400px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
      font-size: 13px;
    }

    #addLeadModal h2 {
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 700;
    }

    #addLeadForm label {
      display: block;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 2px;
      font-size: 12px;
    }

    #addLeadForm input,
    #addLeadForm select,
    #addLeadForm textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      box-sizing: border-box;
    }

    #addLeadForm textarea {
      min-height: 60px;
      resize: vertical;
    }

    #addLeadModalActions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* ---------- Toast ---------- */
    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2200;
      padding: 8px 12px;
      border-radius: 999px;
      background: #111827;
      color: #f9fafb;
      font-size: 13px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.7);
      display: none;
    }

    #toast.show {
      display: inline-block;
    }

    /* Responsive tweaks */
    @media (max-width: 900px) {
      #dashboard {
        top: 84px;
        left: 8px;
        right: 8px;
      }

      #dailyQueuePanel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Logo -->
  <img
    id="logo"
    src="images/Deli_Sandwich_Logo_Large.png"
    alt="Deli Sandwich Logo"
  />

  <!-- Map / List / Hide Controls -->
  <button
    id="dashboardToggle"
    title="Toggle Dashboard (Shift+D)"
    aria-pressed="true"
  >
    Hide Controls
  </button>

  <div id="viewSwitcher" role="tablist" aria-label="View Switcher">
    <button
      id="btnMapView"
      class="active"
      role="tab"
      aria-selected="true"
    >
      Map
    </button>
    <button id="btnListView" role="tab" aria-selected="false">
      List
    </button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <!-- Filters row -->
    <div>
      <label for="tagFilter">Tags:</label>
      <select id="tagFilter">
        <option value="All">All</option>
      </select>
    </div>
    <div>
      <label for="typeFilter">Type:</label>
      <select id="typeFilter">
        <option value="All">All</option>
      </select>
    </div>
    <div>
      <label for="cadenceFilter">Cadence:</label>
      <select id="cadenceFilter">
        <option value="All">All</option>
      </select>
    </div>
    <div>
      <label for="stateFilter">State:</label>
      <select id="stateFilter">
        <option value="All">All</option>
      </select>
    </div>
    <div>
      <label>Status:</label>
      <label class="status-checkbox"
        ><input type="checkbox" value="Hot" checked /> Hot</label
      >
      <label class="status-checkbox"
        ><input type="checkbox" value="Warm" checked /> Warm</label
      >
      <label class="status-checkbox"
        ><input type="checkbox" value="Cold" checked /> Cold</label
      >
      <label class="status-checkbox"
        ><input type="checkbox" value="Follow-Up" checked /> Follow-Up</label
      >
      <label class="status-checkbox"
        ><input type="checkbox" value="Converted" checked /> Converted</label
      >
      <label class="status-checkbox"
        ><input type="checkbox" value="Research" checked /> Research</label
      >
      <label class="status-checkbox"
        ><input type="checkbox" value="Unspecified" checked />
        Unspecified</label
      >
    </div>
    <div>
      <label for="startDate">From:</label>
      <input id="startDate" type="date" />
      <label for="endDate">To:</label>
      <input id="endDate" type="date" />
    </div>

    <!-- Main actions -->
    <div class="dashboard-actions-row">
      <button id="launchPresentation">Launch Presentation Mode</button>
      <button id="exportDailyList">Daily List</button>
      <button id="resetFilters">Reset Filters</button>
    </div>

    <!-- Secondary actions -->
    <div class="dashboard-secondary-row">
      <button
        id="openSummaryBtn"
        type="button"
      >
        üìä Open Today‚Äôs Summary
      </button>
      <button id="startMyDayBtn" type="button">
        üöÄ Start My Day
      </button>
      <button id="startMyDayEventBtn" type="button">
        üéØ Start My Day (Event Mode)
      </button>
      <button id="startMyDayAFPBtn" type="button">
        üèü AFP Event Mode
      </button>
      <button id="addLeadBtn" type="button">
        ‚ûï Add Lead
      </button>
    </div>

    <!-- CSV Upload -->
    <div id="csvUploadBar">
      <button
        id="uploadCsvBtn"
        type="button"
        style="
          padding: 6px 10px;
          border-radius: 999px;
          border: 1px solid #d1d5db;
          background: #ffffff;
          cursor: pointer;
        "
      >
        üì§ Upload CSV
      </button>
      <input
        id="csvInput"
        type="file"
        accept=".csv"
        style="display: none"
      />
      <span
        id="uploadStatus"
        style="display: none; margin-left: 8px"
      ></span>
      <button
        id="deleteFilteredLeadsBtn"
        type="button"
        style="
          padding: 6px 10px;
          border-radius: 999px;
          border: 1px solid #fecaca;
          background: #fee2e2;
          color: #b91c1c;
          cursor: pointer;
        "
      >
        üóë Delete Filtered Leads
      </button>
    </div>
  </div>

  <!-- Map View -->
  <div id="mapView">
    <div id="map"></div>

    <!-- Presentation Mode Overlay -->
    <div
      id="presentation-overlay"
      class="presentation-overlay hidden"
    >
      <div class="presentation-inner">
        <button
          id="presentation-close"
          class="presentation-close"
        >
          ‚úñ
        </button>

        <h1 class="presentation-title">
          Current Pipeline (<span id="pipeline_total">0</span>
          Prospects)
        </h1>
        <h2 class="presentation-subtitle">
          <span id="pipeline_range">Date Range</span>
        </h2>

        <!-- Mini AI Summary -->
        <div class="presentation-ai">
          <div class="presentation-ai-kpis">
            <span id="ai_summary_line1"
              >üéØ Waiting for data‚Ä¶</span
            >
            <span id="ai_summary_line2"
              >üìà ‚Äî upgrades | üìâ ‚Äî downgrades</span
            >
            <span id="ai_summary_line3"
              >üî• Strongest: ‚Äî | Weakest: ‚Äî</span
            >
          </div>
          <div
            class="presentation-ai-narrative"
            id="ai_summary_narrative"
          >
            Presentation insights will appear here once a date range
            is applied.
          </div>
        </div>

        <div class="presentation-layout">
          <!-- Funnel -->
          <div class="pipeline-funnel">
            <div
              class="funnel-band funnel-cold"
              data-status="Cold"
            >
              <div class="funnel-band-inner">
                <span
                  class="funnel-count"
                  id="funnel_cold"
                  >0</span
                >
                <span
                  class="funnel-percent"
                  id="funnel_cold_pct"
                  >0%</span
                >
              </div>
            </div>

            <div
              class="funnel-band funnel-followup"
              data-status="Follow-Up"
            >
              <div class="funnel-band-inner">
                <span
                  class="funnel-count"
                  id="funnel_followup"
                  >0</span
                >
                <span
                  class="funnel-percent"
                  id="funnel_followup_pct"
                  >0%</span
                >
              </div>
            </div>

            <div
              class="funnel-band funnel-warm"
              data-status="Warm"
            >
              <div class="funnel-band-inner">
                <span
                  class="funnel-count"
                  id="funnel_warm"
                  >0</span
                >
                <span
                  class="funnel-percent"
                  id="funnel_warm_pct"
                  >0%</span
                >
              </div>
            </div>

            <div
              class="funnel-band funnel-hot"
              data-status="Hot"
            >
              <div class="funnel-band-inner">
                <span
                  class="funnel-count"
                  id="funnel_hot"
                  >0</span
                >
                <span
                  class="funnel-percent"
                  id="funnel_hot_pct"
                  >0%</span
                >
              </div>
            </div>

            <div
              class="funnel-band funnel-converted"
              data-status="Converted"
            >
              <div class="funnel-band-inner">
                <span
                  class="funnel-count"
                  id="funnel_converted"
                  >0</span
                >
                <span
                  class="funnel-percent"
                  id="funnel_converted_pct"
                  >0%</span
                >
              </div>
            </div>
          </div>

          <!-- Legend / AI Notes -->
          <div class="pipeline-legend">
            <div class="legend-row">
              <div class="legend-emoji">üßä</div>
              <div class="legend-text">
                <div class="legend-title">Cold Leads</div>
                <div class="legend-notes-line"></div>
                <div
                  class="legend-subtitle"
                  id="ai_note_cold_presentation"
                >
                  Notes on Cold Leads
                </div>
              </div>
            </div>

            <div class="legend-row">
              <div class="legend-emoji">‚è≥</div>
              <div class="legend-text">
                <div class="legend-title">Follow-Up Leads</div>
                <div class="legend-notes-line"></div>
                <div
                  class="legend-subtitle"
                  id="ai_note_followup_presentation"
                >
                  Notes on Follow-Up Leads
                </div>
              </div>
            </div>

            <div class="legend-row">
              <div class="legend-emoji">üåû</div>
              <div class="legend-text">
                <div class="legend-title">Warm Leads</div>
                <div class="legend-notes-line"></div>
                <div
                  class="legend-subtitle"
                  id="ai_note_warm_presentation"
                >
                  Notes on Warm Leads
                </div>
              </div>
            </div>

            <div class="legend-row">
              <div class="legend-emoji">üî•</div>
              <div class="legend-text">
                <div class="legend-title">Hot Leads</div>
                <div class="legend-notes-line"></div>
                <div
                  class="legend-subtitle"
                  id="ai_note_hot_presentation"
                >
                  Notes on Hot Leads
                </div>
              </div>
            </div>

            <div class="legend-row">
              <div class="legend-emoji">üèÜ</div>
              <div class="legend-text">
                <div class="legend-title">Converted</div>
                <div class="legend-notes-line"></div>
                <div
                  class="legend-subtitle"
                  id="ai_note_converted_presentation"
                >
                  Notes on Converted Leads
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Converted-only Trophy Panel -->
        <div class="presentation-trophy-panel">
          <div class="trophy-header-row">
            <div class="trophy-title-wrap">
              <span class="trophy-emoji">üèÜ</span>
              <div>
                <div class="trophy-title">
                  Converted Pipeline Highlights
                </div>
                <div class="trophy-subtitle">
                  Wins in this filtered range
                </div>
              </div>
            </div>
            <div class="trophy-kpi">
              <span class="trophy-kpi-label">Converted leads</span>
              <span
                class="trophy-kpi-value"
                id="trophy_converted_total"
                >‚Äî</span
              >
            </div>
          </div>

          <div class="trophy-section">
            <div class="trophy-section-title">Top wins</div>
            <div
              id="trophy_top_wins"
              class="trophy-win-list"
            >
              <div class="trophy-win-empty">
                No converted wins in this view yet.
              </div>
            </div>
          </div>

          <div class="trophy-section">
            <div class="trophy-section-title">Insight</div>
            <div
              id="trophy_insight"
              class="trophy-insight-text"
            >
              Converted insights will appear here once you have
              wins in this window.
            </div>
          </div>
        </div>

        <!-- ICP Panel -->
        <div class="presentation-icp-panel">
          <div class="icp-header">
            <div class="icp-title">ICP Vertical Breakdown</div>
            <div class="icp-subtitle">
              How your core Finexio verticals are converting in this
              window.
            </div>
          </div>
          <div class="icp-tiles" id="icp_tiles">
            <!-- filled by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Stats / Pin Count / Daily Queue / Legend -->
    <div id="statsSummary">Status Breakdown: (loading...)</div>
    <div id="pinCount">Displaying 0 of 0 leads</div>

    <div id="dailyQueuePanel">
      <header>
        <h3 id="dailyQueueTitle">Daily Queue</h3>
        <button
          id="dailyQueueClose"
          class="close"
          title="Hide Daily Queue"
        >
          √ó
        </button>
      </header>
      <div style="font-size: 12px; color: #4b5563; margin-bottom: 4px">
        Auto-selected batch of leads for today‚Äôs activity.
      </div>
      <ul id="dailyQueueList">
        <!-- filled by JS -->
      </ul>
    </div>

    <div id="legend">
      <div class="legend-item">
        <div
          class="legend-color"
          style="background-image: url('images/marker-icon-green.png')"
        ></div>
        <span>Converted</span>
      </div>
      <div class="legend-item">
        <div
          class="legend-color"
          style="background-image: url('images/marker-icon-red.png')"
        ></div>
        <span>Hot</span>
      </div>
      <div class="legend-item">
        <div
          class="legend-color"
          style="background-image: url('images/marker-icon-orange.png')"
        ></div>
        <span>Warm</span>
      </div>
      <div class="legend-item">
        <div
          class="legend-color"
          style="background-image: url('images/marker-icon-yellow.png')"
        ></div>
        <span>Follow-Up</span>
      </div>
      <div class="legend-item">
        <div
          class="legend-color"
          style="background-image: url('images/marker-icon-blue.png')"
        ></div>
        <span>Cold</span>
      </div>
      <div class="legend-item">
        <div
          class="legend-color"
          style="background-image: url('images/marker-icon-grey.png')"
        ></div>
        <span>Research / Unspecified</span>
      </div>
    </div>
  </div>

  <!-- List View -->
  <div id="listView" aria-label="Lead List">
    <div id="listToolbar">
      <!-- Search -->
      <input
        id="listSearch"
        type="search"
        placeholder="Search name, company, city, state, tags‚Ä¶"
        aria-label="Search"
      />
      <!-- Tag-only filter -->
      <input
        id="listTagFilter"
        type="search"
        placeholder="Filter by tag‚Ä¶"
        aria-label="Filter by tag"
      />

      <!-- Status chips -->
      <div id="listStatusChips">
        <button
          class="chip active"
          data-status="Converted"
          type="button"
        >
          <span class="icon">üèÜ</span> Converted
        </button>
        <button
          class="chip active"
          data-status="Hot"
          type="button"
        >
          <span class="icon">üî•</span> Hot
        </button>
        <button
          class="chip active"
          data-status="Warm"
          type="button"
        >
          <span class="icon">üåû</span> Warm
        </button>
        <button
          class="chip active"
          data-status="Cold"
          type="button"
        >
          <span class="icon">üßä</span> Cold
        </button>
        <button
          class="chip active"
          data-status="Follow-Up"
          type="button"
        >
          <span class="icon">‚è≥</span> Follow-Up
        </button>
        <button
          class="chip active"
          data-status="Research"
          type="button"
        >
          <span class="icon">üîç</span> Research
        </button>
        <button
          class="chip active"
          data-status="Unspecified"
          type="button"
        >
          <span class="icon">‚ùì</span> Unspecified
        </button>
      </div>
    </div>

    <div id="listContent">
      <table id="leadTable">
        <thead id="leadThead">
          <tr id="leadHeaderRow"></tr>
        </thead>
        <tbody id="leadTbody"></tbody>
      </table>
    </div>
    <div id="leadCount">0 leads</div>
  </div>

  <!-- Account 360¬∞ slide-in panel -->
  <div id="account360Panel" class="slide-panel"></div>

  <!-- Add Lead Modal -->
  <div id="addLeadModalOverlay">
    <div id="addLeadModal">
      <h2>Add Lead</h2>
      <form id="addLeadForm">
        <label for="addLeadName">Name</label>
        <input id="addLeadName" name="name" type="text" />

        <label for="addLeadCompany">Company</label>
        <input id="addLeadCompany" name="company" type="text" />

        <label for="addLeadCity">City</label>
        <input id="addLeadCity" name="city" type="text" />

        <label for="addLeadState">State</label>
        <input id="addLeadState" name="state" type="text" />

        <label for="addLeadTags">Tags (comma separated)</label>
        <input id="addLeadTags" name="tags" type="text" />

        <label for="addLeadCadence">Cadence</label>
        <input id="addLeadCadence" name="cadence" type="text" />

        <label for="addLeadStatus">Status</label>
        <select id="addLeadStatus" name="status">
          <option value="Hot">Hot</option>
          <option value="Warm">Warm</option>
          <option value="Cold">Cold</option>
          <option value="Follow-Up">Follow-Up</option>
          <option value="Converted">Converted</option>
          <option value="Research">Research</option>
          <option value="Unspecified" selected>
            Unspecified
          </option>
        </select>

        <label for="addLeadNotes">Notes</label>
        <textarea id="addLeadNotes" name="notes"></textarea>

        <label for="addLeadWebsite">Website</label>
        <input id="addLeadWebsite" name="website" type="url" />

        <div id="addLeadModalActions">
          <button
            type="button"
            id="cancelAddLeadBtn"
            style="
              background: #e5e7eb;
              color: #111827;
              border-radius: 999px;
              padding: 6px 12px;
              border: none;
            "
          >
            Cancel
          </button>
          <button
            type="submit"
            style="
              background: #111827;
              color: #f9fafb;
              border-radius: 999px;
              padding: 6px 12px;
              border: none;
            "
          >
            Save Lead
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- App Logic -->
  <script src="leads.js" defer></script>

  <!-- Inline wiring scripts -->
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      const mapView = $("mapView");
      const listView = $("listView");
      const dashboard = $("dashboard");
      const logo = $("logo");
      const dashTgl = $("dashboardToggle");
      const btnMap = $("btnMapView");
      const btnList = $("btnListView");

      function setView(mode) {
        const isMap = mode === "map";

        if (mapView) {
          mapView.style.display = isMap ? "block" : "none";
        }
        if (listView) {
          listView.classList.toggle("show", !isMap);
        }

        if (btnMap) btnMap.classList.toggle("active", isMap);
        if (btnList) btnList.classList.toggle("active", !isMap);

        if (logo) {
          logo.style.display = isMap ? "" : "none";
        }

        if (dashboard) {
          dashboard.classList.remove("hidden");
          dashboard.style.display = isMap ? "flex" : "none";
        }

        if (dashTgl) {
          const hidden = !isMap || !dashboard || dashboard.style.display === "none";
          dashTgl.textContent = hidden ? "Show Controls" : "Hide Controls";
          dashTgl.setAttribute("aria-pressed", (!hidden).toString());
        }
      }

      btnMap && btnMap.addEventListener("click", () => setView("map"));
      btnList && btnList.addEventListener("click", () => setView("list"));

      // Start in map view
      setView("map");

      // Hide Controls button only affects dashboard in Map view
      dashTgl &&
        dashTgl.addEventListener("click", () => {
          if (!dashboard || !mapView) return;

          const inMapView = mapView.style.display !== "none";
          if (!inMapView) return;

          const currentlyHidden =
            dashboard.style.display === "none" ||
            dashboard.classList.contains("hidden");
          const nowHidden = !currentlyHidden;

          dashboard.style.display = nowHidden ? "none" : "flex";
          dashboard.classList.toggle("hidden", nowHidden);

          dashTgl.textContent = nowHidden ? "Show Controls" : "Hide Controls";
          dashTgl.setAttribute("aria-pressed", (!nowHidden).toString());
        });

      // Daily Queue close button
      const dqClose = $("dailyQueueClose");
      const dqPanel = $("dailyQueuePanel");
      dqClose &&
        dqClose.addEventListener("click", () => {
          if (dqPanel) dqPanel.style.display = "none";
        });

      // Toast helper
      const toastEl = $("toast");
      function showToast(msg, ms = 2500) {
        if (!toastEl) return;
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), ms);
      }

      // CSV upload wiring
      const uploadBtn = $("uploadCsvBtn");
      const fileInput = $("csvInput");
      const uploadStatus = $("uploadStatus");

      if (uploadBtn && fileInput && uploadStatus) {
        uploadBtn.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;

          uploadStatus.style.display = "inline";
          uploadStatus.textContent = "Uploading‚Ä¶";
          uploadStatus.style.color = "#6b7280";

          try {
            const fd = new FormData();
            fd.append("file", file, file.name);

            const resp = await fetch("/import/csv", {
              method: "POST",
              body: fd,
            });

            if (!resp.ok) throw new Error("Upload failed");

            const data = await resp.json().catch(() => ({}));
            uploadStatus.textContent = data.message || "Upload complete.";
            uploadStatus.style.color = "#16a34a";
            showToast("CSV imported successfully");
          } catch (err) {
            console.error(err);
            uploadStatus.textContent = "Upload failed.";
            uploadStatus.style.color = "#b91c1c";
            showToast("CSV upload failed", 3500);
          } finally {
            fileInput.value = "";
          }
        });
      }

      // Add Lead modal wiring (markup only; leads.js can hook deeper)
      const addLeadBtn = $("addLeadBtn");
      const addLeadModalOverlay = $("addLeadModalOverlay");
      const cancelAddLeadBtn = $("cancelAddLeadBtn");
      const addLeadForm = $("addLeadForm");

      function closeAddLeadModal() {
        addLeadModalOverlay &&
          addLeadModalOverlay.classList.remove("open");
      }

      addLeadBtn &&
        addLeadBtn.addEventListener("click", () => {
          addLeadModalOverlay &&
            addLeadModalOverlay.classList.add("open");
        });

      cancelAddLeadBtn &&
        cancelAddLeadBtn.addEventListener("click", (e) => {
          e.preventDefault();
          closeAddLeadModal();
        });

      addLeadModalOverlay &&
        addLeadModalOverlay.addEventListener("click", (e) => {
          if (e.target === addLeadModalOverlay) {
            closeAddLeadModal();
          }
        });

      addLeadForm &&
        addLeadForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          // let leads.js handle full logic if it overrides this
          showToast("Submitting lead‚Ä¶");
        });

      // Presentation overlay close
      const presOverlay = document.getElementById(
        "presentation-overlay"
      );
      const presClose = document.getElementById(
        "presentation-close"
      );
      presClose &&
        presClose.addEventListener("click", () => {
          if (presOverlay)
            presOverlay.classList.add("hidden");
        });

      // Expose a thin helper so leads.js can open presentation
      window.openPresentationOverlay = function () {
        if (presOverlay)
          presOverlay.classList.remove("hidden");
      };

      // Open Today‚Äôs Summary (frontend redirect only; backend route already exists)
      const openSummaryBtn = $("openSummaryBtn");
      if (openSummaryBtn) {
        openSummaryBtn.addEventListener("click", () => {
          window.location.href = "/summary?range=today";
        });
      }

      // Start My Day buttons ‚Äì basic redirects (your backend routes can refine)
      const startMyDayBtn = $("startMyDayBtn");
      const startMyDayEventBtn = $("startMyDayEventBtn");
      const startMyDayAFPBtn = $("startMyDayAFPBtn");

      startMyDayBtn &&
        startMyDayBtn.addEventListener("click", () => {
          window.location.href = "/daily-queue?mode=standard";
        });

      startMyDayEventBtn &&
        startMyDayEventBtn.addEventListener("click", () => {
          window.location.href = "/daily-queue?mode=event";
        });

      startMyDayAFPBtn &&
        startMyDayAFPBtn.addEventListener("click", () => {
          window.location.href = "/daily-queue?mode=afp";
        });

      // Simple list status chip toggle ‚Äì actual filtering lives in leads.js
      const listToolbar = document.getElementById("listToolbar");
      if (listToolbar) {
        listToolbar.addEventListener("click", (e) => {
          const chip = e.target.closest(".chip");
          if (!chip) return;
          chip.classList.toggle("active");
        });
      }

      // Global stubs so existing code calling these won't crash
      window.autoGeocodeMissing =
        window.autoGeocodeMissing || function () {};
    })();
  </script>
</body>
</html>
