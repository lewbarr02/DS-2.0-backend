<!DOCTYPE html>
<html>
  <head>
    <title>Deli Sandwich</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="images/favicon.png" rel="icon" type="image/png"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600&display=swap" rel="stylesheet"/>
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet"/>
    <link href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" rel="stylesheet"/>
    <link href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" rel="stylesheet"/>
    <style>
/* --- BASE RESET --- */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;                /* prevents the white strip */
  font-family: 'Nunito Sans', sans-serif;
}

/* --- MAP AREA (final, full-bleed) --- */
#mapView {               /* wrapper becomes neutral */
  position: relative;    /* ‚úÖ create a predictable stacking context */
  z-index: 0;
}


#map {                   /* the map itself owns the viewport */
  position: fixed;
  inset: 0;              /* top:0; right:0; bottom:0; left:0 */
  height: 100%;
  width: 100%;
  z-index: 0;            /* ‚úÖ keep map behind UI */
}



#mapView.hidden { display: none; }

      /* --- DASHBOARD (existing) --- */
      #dashboard {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 18px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        z-index: 1001;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      #dashboard.hidden { display: none; }
      #dashboard label { font-weight: bold; margin-right: 5px; }
      #dashboard select, #dashboard input[type="date"] { padding: 4px 8px; font-size: 14px; }
      #dashboard .status-checkbox { margin-right: 10px; }
      #dashboard button {
        padding: 6px 12px; font-size: 14px; background: #444; color: white;
        border: none; border-radius: 6px; cursor: pointer;
      }

      /* Dashboard toggle (existing) */
      #dashboardToggle {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1101;
        background: #444;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 14px;
      }

      /* --- MAP LEGEND & STATS (existing) --- */
      #legend {
        position: absolute; bottom: 20px; right: 20px;
        background: white; padding: 10px 14px; border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); z-index: 1000; font-size: 14px;
      }
      .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
      .legend-color { width: 16px; height: 24px; margin-right: 8px; background-size: contain; background-repeat: no-repeat; background-position: center; }

      #statsSummary {
        position: absolute; bottom: 50px; left: 10px; background: white; padding: 10px;
        border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.2); font-size: 14px; z-index: 1000;
      }
	  
	  #statsSummary .status-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

#statsSummary .status-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  background: #f3f4f6;
  font-size: 13px;
}

#statsSummary .status-chip span.icon {
  font-size: 16px;
}

#statsSummary .status-chip strong {
  margin-left: auto;
}

	  
      #pinCount {
        position: absolute; bottom: 10px; left: 10px; background: white; padding: 6px 10px;
        border-radius: 6px; box-shadow: 0 0 6px rgba(0,0,0,0.2); font-size: 14px; z-index: 1000;
      }

      /* Logo (existing) */
      #logo { position: absolute; top: -122px; left: 10px; height: 400px; z-index: 2000; pointer-events: none; }


/* Overlay container ‚Äì dark mode */
.presentation-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  align-items: flex-start;      /* top-align instead of dead-center */
  justify-content: center;
  padding: 24px 0;              /* vertical padding only */
  box-sizing: border-box;

  /* let the overlay scroll on smaller screens */
  overflow-y: auto;

  /* full-screen dark glass */
  background: rgba(2, 6, 23, 0.92);
}

/* Hide the Deli logo during Presentation Mode */
body:has(#presentation-overlay:not(.hidden)) #logo { display: none !important; }



.presentation-overlay.hidden {
  display: none;
}

/* Inner card ‚Äì full dark */
.presentation-inner {
  position: relative;
  width: 100%;
  max-width: 1100px;
  margin: 24px auto;            /* centers horizontally, adds breathing room */
  background: #020617;
  border-radius: 22px;
  box-shadow:
    0 40px 120px rgba(15, 23, 42, 0.9),
    0 0 0 1px rgba(30, 64, 175, 0.35);
  padding: 32px 40px 36px;
  box-sizing: border-box;
}


/* Close button */
.presentation-close {
  position: absolute;
  top: 18px;
  right: 18px;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 20px;
  line-height: 1;
  color: #9ca3af;
  padding: 4px;
  border-radius: 999px;
  transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
}

.presentation-close:hover {
  background: rgba(148, 163, 184, 0.18);
  color: #e5e7eb;
  transform: scale(1.05);
}

/* Titles ‚Äì light on dark */
.presentation-title {
  margin: 0;
  font-size: 26px;
  font-weight: 600;
  text-align: center;
  color: #e5e7eb;
}

.presentation-subtitle {
  margin: 6px 0 0;
  text-align: center;
  font-size: 13px;
  letter-spacing: 0.01em;
  color: #94a3b8;
}

/* Mini AI Summary block (top of Presentation Mode) ‚Äì dark card */
.presentation-ai {
  margin-top: 18px;
  padding: 10px 14px 12px;
  border-radius: 14px;
  background:
    radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.18), transparent 55%),
    #020617;
  border: 1px solid rgba(148, 163, 184, 0.45);
  text-align: center;
}

.presentation-ai-kpis {
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 13px;
  font-weight: 600;
  color: #e5e7eb;
}

.presentation-ai-kpis span {
  display: block;
}

.presentation-ai-narrative {
  margin-top: 6px;
  font-size: 12px;
  color: #94a3b8;
  line-height: 1.5;
}

/* Layout: funnel + legend */
.presentation-layout {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 56px;
  margin-top: 32px;
}

/* Left: Funnel */
.pipeline-funnel {
  flex: 0 0 360px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 8px;
  align-items: center;
}

/* Funnel bands (keep same gradients, on dark background now) */
.funnel-band {
  position: relative;
  height: 70px;
  width: 100%;
  max-width: 360px;
  clip-path: polygon(0 0, 100% 0, 90% 100%, 10% 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: 0 14px 28px rgba(15, 23, 42, 0.5);
}

.funnel-band::after {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 10% 0%, rgba(255, 255, 255, 0.45), transparent 55%);
  mix-blend-mode: screen;
  opacity: 0.85;
}

.funnel-band-inner {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
}

/* gradients unchanged */
.funnel-cold {
  background: linear-gradient(135deg, #0052cc, #1d4ed8);
  width: 100%;
}
.funnel-followup {
  background: linear-gradient(135deg, #facc15, #f59e0b);
  width: 88%;
}
.funnel-warm {
  background: linear-gradient(135deg, #fb923c, #f97316);
  width: 76%;
}
.funnel-hot {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  width: 64%;
}
.funnel-converted {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  width: 52%;
}

.funnel-count {
  font-size: 22px;
  font-weight: 700;
  color: #ffffff;
  text-shadow: 0 1px 2px rgba(15, 23, 42, 0.7);
}

.funnel-percent {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.9);
  text-shadow: 0 1px 2px rgba(15, 23, 42, 0.7);
}

/* Right: Legend ‚Äì dark cards */
.pipeline-legend {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.legend-row {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: #020617;
  border: 1px solid rgba(30, 64, 175, 0.5);
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.8);
  transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
}

.legend-row:hover {
  background: #02081f;
  border-color: rgba(59, 130, 246, 0.85);
  transform: translateY(-1px);
}

.legend-emoji {
  font-size: 22px;
  line-height: 1;
  margin-top: 2px;
}

.legend-text {
  flex: 1;
}

.legend-title {
  font-size: 14px;
  font-weight: 600;
  color: #e5e7eb;
  margin-bottom: 4px;
}

.legend-notes-line {
  border-bottom: 1px dashed rgba(148, 163, 184, 0.6);
  margin-bottom: 4px;
}

.legend-subtitle {
  font-size: 12px;
  color: #cbd5f5;
}

/* ---- Presentation Mode: Converted Trophy Panel ---- */

.presentation-trophy-panel {
  margin-top: 22px;
  padding: 16px 18px 14px;
  border-radius: 18px;
  background: #020617;
  border: 1px solid rgba(148, 163, 184, 0.5);
  box-shadow:
    0 20px 40px rgba(15, 23, 42, 0.7),
    0 0 0 1px rgba(15, 23, 42, 0.9);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.trophy-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.trophy-title-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}

.trophy-emoji {
  font-size: 22px;
}

.trophy-title {
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #e5e7eb;
}

.trophy-subtitle {
  font-size: 12px;
  color: #a5b4fc;
}

.trophy-kpi {
  text-align: right;
}

.trophy-kpi-label {
  display: block;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #64748b;
}

.trophy-kpi-value {
  font-size: 20px;
  font-weight: 700;
  color: #22c55e;
}

.trophy-section {
  border-top: 1px dashed rgba(148, 163, 184, 0.5);
  padding-top: 8px;
  margin-top: 6px;
}

.trophy-section-title {
  font-size: 12px;
  font-weight: 600;
  color: #e5e7eb;
  margin-bottom: 4px;
}

.trophy-win-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.trophy-win {
  font-size: 12px;
  line-height: 1.35;
}

.trophy-win-company {
  font-weight: 600;
  color: #f9fafb;
}

.trophy-win-location {
  color: #9ca3af;
}

.trophy-win-empty {
  color: #6b7280;
  font-style: italic;
}

.trophy-insight-text {
  font-size: 12px;
  color: #cbd5f5;
}

/* ---- Presentation Mode: ICP Vertical Breakdown ---- */

.presentation-icp-panel {
  margin-top: 28px;
  padding: 18px 20px 16px;
  border-radius: 18px;
  background: #020617;
  box-shadow:
    inset 0 0 0 1px rgba(15, 23, 42, 0.9),
    0 32px 60px rgba(15, 23, 42, 0.9);
}

.icp-header {
  margin-bottom: 14px;
}

.icp-title {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: #e5e7eb;
}

.icp-subtitle {
  margin-top: 4px;
  font-size: 13px;
  color: #94a3b8;
}

.icp-tiles {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.icp-tile {
  flex: 1 1 calc(14.5% - 8px);
  min-width: 120px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(148, 163, 184, 0.55);
  background:
    radial-gradient(circle at 0% 0%, rgba(148, 163, 184, 0.22), transparent 55%),
    #020617;
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.7);
}

.icp-name {
  font-size: 11px;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: #c7d2fe;
  margin-bottom: 6px;
}

.icp-percent {
  font-size: 18px;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 2px;
}

.icp-count {
  font-size: 11px;
  color: #9ca3af;
}

.icp-share {
  margin-top: 2px;
  font-size: 11px;
  color: #94a3b8;
}


/* Responsive: stack tiles nicely on small screens */
@media (max-width: 960px) {
  .icp-tile {
    flex: 1 1 calc(33.33% - 8px);
  }

  .presentation-inner {
    padding: 24px 18px 26px;
  }

  .presentation-layout {
    flex-direction: column;
    gap: 24px;
    align-items: stretch;
  }

  .pipeline-funnel {
    flex: 0 0 auto;
    max-width: 320px;
    margin: 0 auto;
  }
}

@media (max-width: 640px) {
  .icp-tile {
    flex: 1 1 calc(50% - 8px);
  }

  .presentation-title {
    font-size: 22px;
  }

  .presentation-subtitle {
    font-size: 12px;
  }

  .legend-row {
    padding: 8px 10px;
  }
}





      /* --- VIEW SWITCHER --- */
      #viewSwitcher {
        position: absolute;
        top: 20px;
        right: 120px; /* keep clear of #dashboardToggle */
        z-index: 1101;
        display: flex;
        background: rgba(255,255,255,0.95);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        overflow: hidden;
      }
      #viewSwitcher button {
        border: none; padding: 6px 12px; font-size: 14px; cursor: pointer; background: transparent;
      }
      #viewSwitcher button.active { background: #222; color: #fff; }

#listView {
  position: fixed;
  inset: 0;
  display: none;
  background: #f7f8fb;

  /* ‚úÖ Make list view itself the scroll container */
  overflow-y: auto;
  overflow-x: hidden;


  /* ‚úÖ Flex column so toolbar/table stack correctly */
  flex-direction: column;

  /* ‚úÖ keep your existing panel push behavior */
  margin-right: 0;
  transition: margin-right 0.18s ease;
  box-sizing: border-box;
}

#listView.show {
  display: flex;
}






      #listToolbar {
        position: sticky; top: 0; z-index: 5;
        display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
        background: #fff; padding: 10px 12px; border-bottom: 1px solid #e7e7e7;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      }
      #listToolbar input[type="search"] {
        padding: 6px 10px; font-size: 14px; min-width: 240px; border: 1px solid #ddd; border-radius: 6px;
      }
      .chip {
        padding: 6px 10px; border-radius: 16px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 12px;
      }
      .chip.active { background: #222; color: #fff; border-color: #222; }
      #columnsMenu details { user-select: none; }
      #columnsMenu summary {
        list-style: none; cursor: pointer; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; font-size: 12px;
      }
      #columnsMenu summary::-webkit-details-marker { display: none; }
      #columnsMenu .panel { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 8px; margin-top: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      #columnsMenu .panel label { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 13px; }





#leadTableWrap {
  flex: 1;
  overflow: visible;
  min-height: 0;
}



      table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; }
      thead th {
        position: sticky; top: 0; background: #fff; z-index: 1; text-align: left; padding: 10px; border-bottom: 1px solid #eee; cursor: default;
      }
      thead th.sortable { cursor: pointer; }
      td.linkedin-cell { text-align:center; width:44px; cursor:pointer; user-select:none; }
      tbody td { padding: 10px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
      tr:hover { background: #fafafa; }
	  /* ‚úÖ Selected row highlight (List View Option A) */
#leadTable tbody tr.lead-row.is-selected {
  background: #eef6ff;            /* light blue */
  outline: 2px solid #93c5fd;     /* soft blue border */
  outline-offset: -2px;
}

      .actions-cell button {
        margin-right: 6px; border: 1px solid #ddd; background: #fff; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px;
      }
      .status-cell { white-space: nowrap; font-weight: 600; }
      .website-link { color: #0b6bcb; text-decoration: none; }

	  
	  /* ============================================
   LIST VIEW ‚Äî STATUS COLORS + BADGE UI
   (Lewis Visual Processor Upgrade)
   ============================================ */

#leadTable tbody tr.lead-row {
  border-left: 8px solid transparent;
}

#leadTable tbody tr.lead-row td.status-cell {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Emoji badge next to the dropdown */
.status-badge {
  width: 22px;
  height: 22px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  font-size: 14px;
  border: 1px solid #e5e7eb;
  background: #fff;
}

/* Status-based colored outlines */
#leadTable tbody tr.status-converted   { border-left-color: #16a34a; } /* green */
#leadTable tbody tr.status-hot         { border-left-color: #dc2626; } /* red */
#leadTable tbody tr.status-warm        { border-left-color: #f97316; } /* orange */
#leadTable tbody tr.status-follow-up   { border-left-color: #facc15; } /* yellow */
#leadTable tbody tr.status-cold        { border-left-color: #2563eb; } /* blue */
#leadTable tbody tr.status-research    { border-left-color: #7c3aed; } /* violet */
#leadTable tbody tr.status-unspecified { border-left-color: #6b7280; } /* gray */


      /* Modal (existing) */
      .modal.hidden { display: none; }

      /* --- Account 360¬∞ slide panel (new) --- */
      .slide-panel {
        position: fixed;
        right: 0; top: 0;
        width: 400px; height: 100%;
        background: white;
        border-left: 2px solid #ccc;
        overflow-y: auto;
        padding: 1rem;
        z-index: 3000; /* above logo (2000) and overlays */
		box-sizing: border-box;
      }
      .slide-panel.hidden { display: none; }
      .slide-panel .close-btn {
        position: absolute;
        right: 1rem; top: 1rem;
        cursor: pointer;
      }
	  /* --- POPUP FORM POLISH --- */
.leaflet-popup-content {
  margin: 10px 12px;
}

.leaflet-popup-content input[type="text"],
.leaflet-popup-content input[type="number"],
.leaflet-popup-content select,
.leaflet-popup-content textarea {
  width: 100%;
  box-sizing: border-box;
}

.leaflet-popup-content label {
  display: block;
  margin-top: 6px;
}

.leaflet-popup-content .actions {
  margin-top: 10px;
  display: flex;
  gap: 8px;
}

      /* --- DAILY QUEUE PANEL --- */
      #dailyQueuePanel {
        position: absolute;
        top: 80px;
        right: 20px;
        width: 320px;
        max-height: 60vh;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        padding: 10px 12px;
        font-size: 13px;
        z-index: 2001;
        display: none;              /* hidden until we generate */
      }
      #dailyQueuePanel header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
      }
      #dailyQueuePanel h3 {
        margin: 0;
        font-size: 14px;
      }
      #dailyQueuePanel button.close {
        border: none;
        background: transparent;
        font-size: 16px;
        cursor: pointer;
        line-height: 1;
      }
      #dailyQueueList {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      #dailyQueueList li {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
      }
      #dailyQueueList li:last-child {
        border-bottom: none;
      }
      #dailyQueueList .line1 {
        font-weight: 600;
      }
      #dailyQueueList .line2 {
        color: #6b7280;
        font-size: 12px;
      }
      #dailyQueueList .line3 {
        color: #111827;
        font-size: 12px;
      }
	  
	  
/* ===============================
   TIME ZONE STATE PILLS
   =============================== */
   
   /* ===============================
   TIME ZONE FILTER CHIPS (List View)
   =============================== */

.chip.tz-chip { font-weight: 700; }

.chip.tz-chip.active[data-tz="ET"]      { background:#e6f7ec; color:#1e7f43; border-color:#bfe7cd; }
.chip.tz-chip.active[data-tz="CT"]      { background:#fff7e6; color:#a16207; border-color:#ffe0b3; }
.chip.tz-chip.active[data-tz="MT"]      { background:#fff0e6; color:#c2410c; border-color:#ffd1b8; }
.chip.tz-chip.active[data-tz="PT"]      { background:#e6f0ff; color:#1d4ed8; border-color:#c6d6ff; }
.chip.tz-chip.active[data-tz="UNKNOWN"] { background:#f3f4f6; color:#6b7280; border-color:#d1d5db; }


.state-pill{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-weight:600;
  font-size:11px;
  line-height:1.2;
  border:1px solid #d1d5db;
  background:#f3f4f6;       /* default visible pill */
  color:#374151;
  white-space:nowrap;
}

.acct-industry{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-weight:700;
  font-size:11px;
  line-height:1.2;
  border:1px solid #e5e7eb;
  background:#ffffff;
  color:#111827;
}


/* Support BOTH uppercase + lowercase tz classes (bulletproof) */
.tz-ET, .tz-et { background:#e6f7ec; color:#1e7f43; border-color:#bfe7cd; }  /* Eastern */
.tz-CT, .tz-ct { background:#fff7e6; color:#a16207; border-color:#ffe0b3; }  /* Central */
.tz-MT, .tz-mt { background:#fff0e6; color:#c2410c; border-color:#ffd1b8; }  /* Mountain */
.tz-PT, .tz-pt { background:#e6f0ff; color:#1d4ed8; border-color:#c6d6ff; }  /* Pacific */
.tz-UNKNOWN, .tz-unknown { background:#f3f4f6; color:#6b7280; border-color:#d1d5db; }

/* Row accent (quick scan by timezone) */
.lead-row.tzrow-ET, .lead-row.tzrow-et { border-left:6px solid #1e7f43; }
.lead-row.tzrow-CT, .lead-row.tzrow-ct { border-left:6px solid #a16207; }
.lead-row.tzrow-MT, .lead-row.tzrow-mt { border-left:6px solid #c2410c; }
.lead-row.tzrow-PT, .lead-row.tzrow-pt { border-left:6px solid #1d4ed8; }
.lead-row.tzrow-UNKNOWN, .lead-row.tzrow-unknown { border-left:6px solid #9ca3af; }


/* ‚úÖ Safe top-right cluster layout (prevents overlap with Hide Controls) */
#topRightCluster {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 1101;
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-end;
}

/* Force the two controls to be ‚Äúin flow‚Äù inside the cluster */
#dashboardToggle {
  position: static !important;
}

#viewSwitcher {
  position: static !important;
  top: auto !important;
  right: auto !important;
}

/* Accounts view behaves like List view (full-screen, scrollable) */
:root {
  /* Responsive drawer width that matches the reserved padding */
--acct-drawer-w: clamp(360px, 40vw, 620px);
}

#accountsView {
  position: fixed;
  inset: 0;
  display: none;
  background: #f7f8fb;

  /* ‚úÖ kill the bottom horizontal scrollbar */
  overflow-y: auto;
  overflow-x: hidden;

  flex-direction: column;
  box-sizing: border-box;
}

/* Only reserve space when drawer is open */
#accountsView.drawer-open {
  padding-right: calc(var(--acct-drawer-w) + 18px); /* breathing room */
  box-sizing: border-box;
}

#accountsView.show {
  display: flex;
}

.account-drawer {
  position: fixed;
  top: 0;
  right: 0;

  width: var(--acct-drawer-w);
  height: 100vh;

  background: #fff;
  border-left: 1px solid #ddd;
  z-index: 9999;

  display: flex;
  flex-direction: column;
  box-sizing: border-box;

  overflow: hidden; /* drawer itself does not scroll */
}

.account-drawer.hidden {
  display: none;
}

.account-drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid #eee;
  flex: 0 0 auto;
}

.account-drawer-actions {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  border-bottom: 1px solid #eee;
  flex: 0 0 auto;
}

/* ‚úÖ Scrollable drawer body (and prevent "cut off" at bottom) */
.account-drawer-content {
  flex: 1 1 auto;
  min-height: 0;                 /* critical for flex scroll */
  overflow-y: auto;
  overflow-x: hidden;            /* ‚úÖ prevents horizontal scroll inside drawer */
  padding-bottom: 18px;          /* ‚úÖ ensures last row isn't visually clipped */
  scrollbar-gutter: stable;      /* ‚úÖ prevents header/row width shifting */
}

.account-drawer-section {
  padding: 16px;
  border-bottom: 1px solid #f0f0f0;
}

.muted {
  color: #666;
  font-size: 13px;
}

/* ‚úÖ Make the Leads table fit the drawer so columns stay aligned */
#accountLeadsTable {
  overflow-x: hidden;
}

/* ================================
   Account 360 ‚Äî v1 Coverage Strip
================================ */
.ds-section-head{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
}
.coverage-strip{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
.coverage-pill{
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:999px;
  padding:7px 10px;
  font-size:12px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  cursor:default;
  user-select:none;
}
.coverage-pill .dot{
  width:10px;
  height:10px;
  border-radius:999px;
  background:#d1d5db; /* neutral */
  flex:0 0 auto;
}
.coverage-pill.filled{
  border-color: rgba(34,197,94,0.45);
  background: rgba(34,197,94,0.06);
}
.coverage-pill.filled .dot{ background:#22c55e; }
.coverage-pill.missing{
  border-style:dashed;
  cursor:pointer;
}
.coverage-pill.missing:hover{
  border-color:#93c5fd;
  background:#eff6ff;
}
.coverage-pill .role{ font-weight:700; }
.coverage-pill .count{
  color:#6b7280;
  font-weight:600;
}
.coverage-pill.missing .count{ color:#2563eb; }

#accountLeadsTable table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;           /* ‚úÖ forces columns to obey widths */
}

#accountLeadsTable th,
#accountLeadsTable td {
  padding: 10px 8px;
  vertical-align: top;
}

/* Column sizing for: Role | Name | Status | Recency */
#accountLeadsTable th:nth-child(1),
#accountLeadsTable td:nth-child(1) { width: 22%; }

#accountLeadsTable th:nth-child(2),
#accountLeadsTable td:nth-child(2) { width: 36%; word-break: break-word; }

#accountLeadsTable th:nth-child(3),
#accountLeadsTable td:nth-child(3) { width: 18%; white-space: nowrap; }

#accountLeadsTable th:nth-child(4),
#accountLeadsTable td:nth-child(4) { width: 24%; white-space: nowrap; text-align: right; }


/* ‚úÖ Account 360: clean, row-based person table (no empty role placeholders) */
.acct-leads-wrap{
  margin-top:10px;
  background:#fafafa;
  border:1px solid #e5e7eb;
  border-radius:12px;
  overflow:hidden;
}
.acct-leads-table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}
.acct-leads-table th{
  font-size:12px;
  color:#6b7280;
  text-align:left;
  padding:10px 10px;
}
.acct-leads-table td{
  padding:10px 10px;
  border-top:1px solid #e5e7eb;
  vertical-align:top;
  font-size:13px;
  color:#111827;
}
.acct-leads-table select,
.acct-leads-table input{
  width:100%;
  padding:6px 8px;
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#fff;
  font-size:12px;
  box-sizing:border-box;
}
.acct-name-cell{
  display:flex;
  gap:8px;
  align-items:center;
}
.acct-name-cell input{
  flex:1 1 auto;
}
.acct-person-delete{
  flex:0 0 auto;
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  padding:6px 8px;
  cursor:pointer;
  font-size:12px;
  line-height:1;
}
.acct-person-delete:hover{
  border-color:#ef4444;
  color:#ef4444;
}

/* Accounts: selected row highlight when drawer is open */
.acct-row.is-selected {
  outline: 2px solid rgba(59, 130, 246, 0.35);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
}

/* ============================= */
/* Add Account Modal UI */
/* ============================= */
.ds-modal.hidden { display:none; }
.ds-modal { position:fixed; inset:0; z-index:9999; }
.ds-modal-backdrop{
  position:absolute; inset:0;
  background: rgba(0,0,0,.35);
}
.ds-modal-card{
  position:absolute;
  top:50%; left:50%;
  transform: translate(-50%, -50%);
  width: min(680px, calc(100% - 32px));
  background:#fff;
  border-radius:14px;
  border:1px solid #e5e7eb;
  box-shadow: 0 20px 60px rgba(0,0,0,.22);
  overflow:hidden;
  color:#111;
}
.ds-modal-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid #e5e7eb;
}
.ds-modal-x{
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  padding:6px 10px;
  cursor:pointer;
}
.ds-modal-body{ padding:14px; }
.ds-modal-foot{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  padding:12px 14px;
  border-top:1px solid #e5e7eb;
  background:#fafafa;
}
.ds-field{ margin-bottom:10px; }
.ds-label{ display:block; font-size:12px; color:#374151; margin:0 0 6px 0; }
.ds-input, .ds-textarea{
  width:100%;
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  padding:9px 10px;
  font-size:13px;
  outline:none;
}
.ds-textarea{ min-height:78px; resize:vertical; }
.ds-input:focus, .ds-textarea:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35); }
.ds-grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.ds-grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
.ds-btn{
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  padding:8px 10px;
  cursor:pointer;
  font-size:13px;
}
.ds-btn.primary{
  border-color:#93c5fd;
  background:#eff6ff;
}
@media (max-width: 720px){
  .ds-grid2, .ds-grid3{ grid-template-columns:1fr; }
}






	  
	  
    
/* Highlight newly added person row (Account 360) */
.acct-person-row { transition: background 0.2s ease; }


/* ================================
   LIST VIEW ‚Äì ROLE COLUMN WIDTH
   (Targets header + body by key/class so it still works if columns are hidden)
================================ */

#leadTableWrap {
  overflow-x: auto; /* allow wider columns instead of squeezing */
}

#leadTable th[data-key="role"] {
  min-width: 220px;
  width: 260px;
}

#leadTable td.role-cell {
  min-width: 220px;
  width: 260px;
}

#leadTable td.role-cell select.role-select {
  width: 100%;
  min-width: 220px;
}


/* ‚úÖ Clickable Company ‚Üí opens Account 360 drawer (no extra buttons) */
#leadTable .acct360-link{
  cursor:pointer;
  font-weight:700;
  text-decoration: underline;
  text-decoration-color: rgba(0,0,0,0.25);
}
#leadTable .acct360-link:hover{ text-decoration-color: rgba(0,0,0,0.6); }

/* ‚úÖ Bold Account name everywhere */
#leadModal input[name="company"] { font-weight: 700; }
#accountCompany { font-weight: 700; }

</style>
  </head>
  <body>
   

<!-- Top-right controls: Hide Controls + Map/List/Accounts -->
<div id="topRightCluster">
  <button id="dashboardToggle" title="Toggle Dashboard (Shift+D)" aria-pressed="true">Hide Controls</button>

  <div id="viewSwitcher" role="tablist" aria-label="View Switcher">
    <button id="btnMapView" class="active" role="tab" aria-selected="true">Map</button>
    <button id="btnListView" role="tab" aria-selected="false">List</button>
    <button id="btnAccountsView" role="tab" aria-selected="false">Accounts</button>
  </div>
</div>


    <!-- Existing dashboard -->
    <div id="dashboard">
      <div>
        <label for="tagFilter">Tags:</label>
        <select id="tagFilter"><option value="All">All</option></select>
      </div>
      <div>
        <label for="typeFilter">Type:</label>
        <select id="typeFilter"><option value="All">All</option></select>
      </div>
      <div>
        <label for="cadenceFilter">Cadence:</label>
        <select id="cadenceFilter"><option value="All">All</option></select>
      </div>
      <div>
        <label for="stateFilter">State:</label>
        <select id="stateFilter"><option value="All">All</option></select>
      </div>
	  <div>
    <label for="industryFilter">Industry:</label>
    <select id="industryFilter"><option value="All">All</option></select>
</div>
      <div>
        <label for="clusterToggle">Cluster Pins:</label>
        <input checked id="clusterToggle" type="checkbox"/>
      </div>
      <div>
        <label>Status:</label>
        <label class="status-checkbox"><input checked type="checkbox" value="Hot"/> Hot</label>
        <label class="status-checkbox"><input checked type="checkbox" value="Warm"/> Warm</label>
        <label class="status-checkbox"><input checked type="checkbox" value="Cold"/> Cold</label>
        <label class="status-checkbox"><input checked type="checkbox" value="Follow-Up"/> Follow-Up</label>
        <label class="status-checkbox"><input checked type="checkbox" value="Converted"/> Converted</label>
        <label class="status-checkbox"><input checked type="checkbox" value="Research"/> Research</label>
        <label class="status-checkbox"><input checked type="checkbox" value="Unspecified"/> Unspecified</label>
      </div>
      <div>
        <label for="startDate">From:</label>
        <input id="startDate" type="date"/>
        <label for="endDate">To:</label>
        <input id="endDate" type="date"/>
      </div>
      <div>
        <button id="launchPresentation">Launch Presentation Mode</button>
        <button id="exportDailyList">Daily List</button>
        <button id="resetFilters">Reset Filters</button>
      </div>
<div>
  <button id="openSummaryBtn">üìä Open Today‚Äôs Summary</button>
  <button id="startMyDayBtn">üöÄ Start My Day (20)</button>
  <button id="startMyDayEventBtn">üéØ Start My Day (Event Mode)</button>

  <!-- ‚≠ê NEW: Direct AFP Event Mode button -->
  <button id="startMyDayAFPBtn">üèü AFP Event Mode</button>

  <button id="addLeadBtn">‚ûï Add Lead</button>
</div>


      <!-- üì§ CSV Upload -->
      <!-- üì§ CSV Upload -->
      <div id="csvUploadBar" style="margin-top:8px;">

        <!-- NEW: defaults for CSV imports -->
        <div style="
          display:flex;
          flex-wrap:wrap;
          gap:8px;
          align-items:flex-end;
          margin-bottom:6px;
        ">
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label for="csvDefaultSource"
                   style="font-size:11px; color:#6b7280;">
              Source (optional)
            </label>
            <input
              id="csvDefaultSource"
              type="text"
              placeholder="e.g. Conference"
              style="font-size:12px; padding:4px 6px;
                     border-radius:6px; border:1px solid #d1d5db;"
            />
          </div>

          <div style="display:flex; flex-direction:column; gap:4px;">
            <label for="csvDefaultTag"
                   style="font-size:11px; color:#6b7280;">
              Tag for all rows (optional)
            </label>
            <input
              id="csvDefaultTag"
              type="text"
              placeholder="e.g. AFP Event"
              style="font-size:12px; padding:4px 6px;
                     border-radius:6px; border:1px solid #d1d5db;"
            />
          </div>
        </div>

        <button
          id="uploadCsvBtn"
          style="padding:6px 10px;border-radius:8px;border:1px solid #ccc;cursor:pointer;">
          üì§ Upload CSV
        </button>
        <input id="csvInput" type="file" accept=".csv" style="display:none;" />
        <span id="uploadStatus" style="display:none;margin-left:8px;font-size:14px;"></span>

        <!-- üõ° Safe mode: deletes only currently filtered leads -->
        <button
          id="deleteFilteredLeadsBtn"
          style="margin-left:12px;padding:6px 10px;border-radius:8px;
                 border:1px solid #fca5a5;background:#fee2e2;color:#b91c1c;
                 cursor:pointer;">
          üóëÔ∏è Delete Filtered Leads (Safe)
        </button>
      </div>



	  
    </div>

    <!-- MAP VIEW (wrapped) -->
    <div id="mapView">
	<img alt="Deli Sandwich Logo" id="logo" src="images/Deli_Sandwich_Logo_Large.png"/>
      <div id="map"></div>

         <!-- Presentation Mode Funnel Overlay -->
      <div id="presentation-overlay" class="presentation-overlay hidden">
        <div class="presentation-inner">
          <button id="presentation-close" class="presentation-close">‚úñ</button>

          <h1 class="presentation-title">
            Current Pipeline (<span id="pipeline_total">0</span> Prospects)
          </h1>
          <h2 class="presentation-subtitle">
            <span id="pipeline_range">Date Range</span>
          </h2>
<!-- üß† Mini AI Summary (3 KPI lines + narrative) -->
<div class="presentation-ai">
  <div class="presentation-ai-kpis">
    <span id="ai_summary_line1">üéØ Waiting for data‚Ä¶</span>
    <span id="ai_summary_line2">üìà ‚Äî upgrades | üìâ ‚Äî downgrades</span>
    <span id="ai_summary_line3">üî• Strongest: ‚Äî | Weakest: ‚Äî</span>
  </div>
  <div class="presentation-ai-narrative" id="ai_summary_narrative">
    Presentation insights will appear here once a date range is applied.
  </div>
</div>
          <div class="presentation-layout">
		  
            <!-- Funnel -->
<div class="pipeline-funnel">
  <div class="funnel-band funnel-cold" data-status="Cold">
    <div class="funnel-band-inner">
      <span class="funnel-count" id="funnel_cold">0</span>
      <span class="funnel-percent" id="funnel_cold_pct">0%</span>
    </div>
  </div>

  <div class="funnel-band funnel-followup" data-status="Follow-Up">
    <div class="funnel-band-inner">
      <span class="funnel-count" id="funnel_followup">0</span>
      <span class="funnel-percent" id="funnel_followup_pct">0%</span>
    </div>
  </div>

  <div class="funnel-band funnel-warm" data-status="Warm">
    <div class="funnel-band-inner">
      <span class="funnel-count" id="funnel_warm">0</span>
      <span class="funnel-percent" id="funnel_warm_pct">0%</span>
    </div>
  </div>

  <div class="funnel-band funnel-hot" data-status="Hot">
    <div class="funnel-band-inner">
      <span class="funnel-count" id="funnel_hot">0</span>
      <span class="funnel-percent" id="funnel_hot_pct">0%</span>
    </div>
  </div>

  <div class="funnel-band funnel-converted" data-status="Converted">
    <div class="funnel-band-inner">
      <span class="funnel-count" id="funnel_converted">0</span>
      <span class="funnel-percent" id="funnel_converted_pct">0%</span>
    </div>
  </div>
</div>


            <!-- Legend / Notes -->
            <div class="pipeline-legend">
              <div class="legend-row">
                <div class="legend-emoji">üßä</div>
                <div class="legend-text">
                  <div class="legend-title">Cold Leads</div>
                  <div class="legend-notes-line"></div>
                  <div class="legend-subtitle" id="ai_note_cold_presentation">
                    Notes on Cold Leads
                  </div>
                </div>
              </div>

              <div class="legend-row">
                <div class="legend-emoji">‚è≥</div>
                <div class="legend-text">
                  <div class="legend-title">Follow-Up Leads</div>
                  <div class="legend-notes-line"></div>
                  <div class="legend-subtitle" id="ai_note_followup_presentation">
                    Notes on Follow-Up Leads
                  </div>
                </div>
              </div>

              <div class="legend-row">
                <div class="legend-emoji">üåû</div>
                <div class="legend-text">
                  <div class="legend-title">Warm Leads</div>
                  <div class="legend-notes-line"></div>
                  <div class="legend-subtitle" id="ai_note_warm_presentation">
                    Notes on Warm Leads
                  </div>
                </div>
              </div>

              <div class="legend-row">
                <div class="legend-emoji">üî•</div>
                <div class="legend-text">
                  <div class="legend-title">Hot Leads</div>
                  <div class="legend-notes-line"></div>
                  <div class="legend-subtitle" id="ai_note_hot_presentation">
                    Notes on Hot Leads
                  </div>
                </div>
              </div>

              <div class="legend-row">
                <div class="legend-emoji">üèÜ</div>
                <div class="legend-text">
                  <div class="legend-title">Converted</div>
                  <div class="legend-notes-line"></div>
                  <div class="legend-subtitle" id="ai_note_converted_presentation">
                    Notes on Converted Leads
                  </div>
                </div>
              </div>
            </div>
          </div>
		  
		              <!-- Converted-only Trophy Panel -->
            <div class="presentation-trophy-panel">
              <div class="trophy-header-row">
                <div class="trophy-title-wrap">
                  <span class="trophy-emoji">üèÜ</span>
                  <div>
                    <div class="trophy-title">Converted Pipeline Highlights</div>
                    <div class="trophy-subtitle">
                      Wins in this filtered range
                    </div>
                  </div>
                </div>
                <div class="trophy-kpi">
                  <span class="trophy-kpi-label">Converted leads</span>
                  <span class="trophy-kpi-value" id="trophy_converted_total">‚Äî</span>
                </div>
              </div>

              <div class="trophy-section">
                <div class="trophy-section-title">Top wins</div>
                <div id="trophy_top_wins" class="trophy-win-list">
                  <div class="trophy-win trophy-win-empty">
                    No converted wins in this view yet.
                  </div>
                </div>
              </div>

              <div class="trophy-section">
                <div class="trophy-section-title">Insight</div>
                <div id="trophy_insight" class="trophy-insight-text">
                  Converted insights will appear here once you have wins in this
                  window.
                </div>
              </div>
            </div>



          <!-- ICP Vertical Breakdown bar (stacked under funnel + notes) -->
          <div class="presentation-icp-panel">
            <div class="icp-header">
              <div class="icp-title">ICP Vertical Breakdown</div>
              <div class="icp-subtitle">
                How your core Finexio verticals are converting in this window.
              </div>
            </div>
            <div class="icp-tiles" id="icp_tiles">
              <!-- tiles are injected by JS -->
            </div>
          </div>
        </div> <!-- /.presentation-inner -->
      </div>   <!-- /#presentation-overlay -->





      <div id="statsSummary">Status Breakdown: (loading...)</div>
      <div id="pinCount">Displaying 0 of 0 leads</div>
	  
	        <!-- Daily Queue panel -->
      <div id="dailyQueuePanel">
        <header>
          <h3 id="dailyQueueTitle">Daily Queue</h3>
          <button class="close" id="dailyQueueClose" title="Hide Daily Queue">√ó</button>
        </header>
        <div style="font-size:12px; color:#4b5563; margin-bottom:4px;">
          Auto-selected batch of leads for today‚Äôs activity.
        </div>
        <ul id="dailyQueueList">
          <!-- Filled by JS -->
        </ul>
      </div>


      <div id="legend">
        <div class="legend-item"><div class="legend-color" style="background-image: url('images/marker-icon-green.png');"></div>Converted</div>
        <div class="legend-item"><div class="legend-color" style="background-image: url('images/marker-icon-red.png');"></div>Hot</div>
        <div class="legend-item"><div class="legend-color" style="background-image: url('images/marker-icon-orange.png');"></div>Warm</div>
        <div class="legend-item"><div class="legend-color" style="background-image: url('images/marker-icon-yellow.png');"></div>Follow-Up</div>
        <div class="legend-item"><div class="legend-color" style="background-image: url('images/marker-icon-blue.png');"></div>Cold</div>
        <div class="legend-item"><div class="legend-color" style="background-image: url('images/marker-icon-violet.png');"></div>Research</div>
        <div class="legend-item"><div class="legend-color" style="background-image: url('images/marker-icon-grey.png');"></div>Unspecified</div>
      </div>
    </div>

    <!-- LIST VIEW -->
    <div id="listView" aria-label="Lead List">
<div id="listToolbar">
  <!-- Global search -->
  <input
    id="listSearch"
    type="search"
    placeholder="Search name, title, company, city, state, tags‚Ä¶"
    aria-label="Search"
  />

  <!-- ‚≠ê NEW: Tag-only filter (List view) -->
  <input
    id="listTagFilter"
    type="search"
    placeholder="Filter by tag‚Ä¶"
    aria-label="Filter by tag"
    style="margin-left:8px; min-width:160px; padding:6px 10px; font-size:14px; border:1px solid #ddd; border-radius:6px;"
  />

  <!-- Status chips (normalized keys) -->
  <!-- ‚≠ê NEW: Timezone filter chips -->
<span style="margin-left:10px; font-size:12px; color:#6b7280;">TZ:</span>
<button class="chip tz-chip" data-tz="ET">ET</button>
<button class="chip tz-chip" data-tz="CT">CT</button>
<button class="chip tz-chip" data-tz="MT">MT</button>
<button class="chip tz-chip" data-tz="PT">PT</button>
<button class="chip tz-chip" data-tz="UNKNOWN">Unknown</button>

  
  <button class="chip" data-status="converted">üèÜ Converted</button>
  <button class="chip" data-status="hot">üî• Hot</button>
  <button class="chip" data-status="warm">üåû Warm</button>
  <button class="chip" data-status="cold">üßä Cold</button>
  <button class="chip" data-status="follow-up">‚è≥ Follow-Up</button>
  <button class="chip" data-status="research">üîç Research</button>
  <button class="chip" data-status="unspecified">‚ö™ Unspecified</button>


  <button id="listReset" class="chip" style="margin-left:8px;">Reset</button>

  <!-- Back to Presentation -->
  <button id="backToPresentation" class="chip" style="margin-left:4px;">
    ‚¨Ö Back to Presentation
  </button>

  <!-- ‚≠ê Geocode All Missing button -->
  <button id="geocodeAllMissingBtn" class="chip" style="margin-left:4px;">
    üì° Geocode All Missing
  </button>

  <!-- ‚úÖ RIGHT-SIDE ACTIONS (Top-Right of List View Header) -->
  <div id="listActions" style="margin-left:auto; display:flex; gap:8px; align-items:center;">

    <!-- ‚úÖ Primary Add Lead button for List View -->
    <button id="listAddLeadBtn"
            style="padding:6px 12px; font-size:14px; background:#222; color:#fff;
                   border:none; border-radius:8px; cursor:pointer;">
      ‚ûï Add Lead
    </button>

    <!-- Existing Columns menu (moved into the right-side cluster) -->
    <div id="columnsMenu">
      <details>
        <summary>Columns ‚ñæ</summary>
        <div class="panel" id="columnsPanel"><!-- JS populates --></div>
      </details>
    </div>

  </div>


</div> <!-- ‚úÖ END #listToolbar -->

<div id="leadCount"
     style="padding:8px 12px; font-size:12px; color:#555;">
  0 leads
</div>

<div id="leadTableWrap">
  <table id="leadTable" aria-describedby="leadCount">
    <thead id="leadThead">
      <tr id="leadHeaderRow"></tr>
    </thead>
    <tbody id="leadTbody"></tbody>
  </table>
</div>

</div> <!-- ‚úÖ END #listView -->

<!-- ACCOUNTS VIEW -->
<div id="accountsView" aria-label="Accounts View">
  <div style="padding:16px 18px; font-size:14px; color:#111; display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
    <div>
      <strong>Accounts</strong>
      <div id="accountsHeaderCount" style="margin-top:6px; font-size:12px; color:#6b7280;">
        Showing 0 of 0 accounts
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="addAccountBtn" type="button" style="padding:8px 10px; border:1px solid #cbd5e1; background:#fff; border-radius:10px; cursor:pointer; font-size:13px;">
        + Add Account
      </button>
    </div>
  </div>


  <div id="accountsContent" style="padding: 0 18px 18px;">
    <!-- JS will populate -->
  </div>
</div>




    <!-- NEW: Account 360¬∞ slide-in panel -->
    <div id="account360Panel" class="slide-panel hidden"></div>




    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Scripts -->

<script>

  (function() {
    // --- Upload CSV wiring ---
    const uploadBtn    = document.getElementById('uploadCsvBtn');
    const fileInput    = document.getElementById('csvInput');
    const uploadStatus = document.getElementById('uploadStatus');

    if (uploadBtn && fileInput && uploadStatus) {
      uploadBtn.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', async () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;

        uploadStatus.style.display = 'inline';
        uploadStatus.textContent = 'Uploading‚Ä¶';
        uploadStatus.style.color = '#6b7280';

        try {
          const fd = new FormData();
          fd.append('file', file, file.name); // field name matches backend

          // üîπ NEW: grab default Source + Tag from the new inputs
          const defaultSourceInput = document.getElementById('csvDefaultSource');
          const defaultTagInput    = document.getElementById('csvDefaultTag');

          const defaultSource = defaultSourceInput
            ? defaultSourceInput.value.trim()
            : '';
          const defaultTag = defaultTagInput
            ? defaultTagInput.value.trim()
            : '';

          // Build URL with optional query params
          const params = new URLSearchParams();
          if (defaultSource) params.set('default_source', defaultSource);
          if (defaultTag)    params.set('default_tag', defaultTag);

          let url = '/import/csv';
          const qs = params.toString();
          if (qs) {
            url += `?${qs}`;
          }

          const res  = await fetch(url, { method: 'POST', body: fd });
          const data = await res.json();
          if (!res.ok) throw new Error(data?.error || 'Upload failed');

          const count = data?.inserted_or_updated ?? 0;
          const failed =
            data?.failed ??
            (Array.isArray(data?.failed_rows) ? data.failed_rows.length : 0);

          uploadStatus.textContent = `‚úÖ Imported ${count} row(s) ‚Ä¢ ${failed} failed`;
          uploadStatus.style.color = '#16a34a';

          // ‚úÖ Account-first import: make sure each imported company exists as an Account
          // (stored in localStorage "Manual Accounts" so Accounts View can render even if no leads remain)
          if (Array.isArray(data?.accounts) && data.accounts.length) {
            for (const acct of data.accounts) {
              if (!acct || !acct.company) continue;
              if (typeof dsUpsertManualAccount === 'function') {
                dsUpsertManualAccount(acct);
              } else if (typeof window.dsUpsertManualAccount === 'function') {
                window.dsUpsertManualAccount(acct);
              }
            }
            if (typeof window.renderAccountsView === 'function') {
              window.renderAccountsView();
            }
          }


          if (window.refreshLeads) await window.refreshLeads();
          if (window.autoGeocodeMissing) {
            window.autoGeocodeMissing({ max: 25, delayMs: 1000 });
          }
        } catch (err) {
          uploadStatus.textContent = `‚ùå ${err.message || 'Upload error'}`;
          uploadStatus.style.color = '#dc2626';
        } finally {
          setTimeout(() => {
            uploadStatus.style.display = 'none';
            uploadStatus.textContent = '';
            fileInput.value = '';
          }, 3500);
        }
      });

    }

    // Helper: get IDs for current filtered/visible leads
    function getFilteredLeadIdsForDelete() {
      const DS   = window.DS || {};
      const rows = (DS.state && (DS.state.filtered || DS.state.rawRows)) || [];
      return rows
        .map(r => r.id ?? r.ID ?? r.lead_id)
        .filter(id => id !== null && id !== undefined);
    }

    // --- Bulk Delete Filtered Leads (Safe mode) wiring ---
    const deleteFilteredBtn = document.getElementById('deleteFilteredLeadsBtn');

    if (deleteFilteredBtn) {
      deleteFilteredBtn.addEventListener('click', async () => {
        const ids = getFilteredLeadIdsForDelete();

        if (!ids.length) {
          alert('No leads match the current filters, so there is nothing to delete.');
          return;
        }

        const ok = window.confirm(
          `Delete ${ids.length} lead(s) that match the CURRENT filters? This cannot be undone.`
        );
        if (!ok) return;

        const originalText = deleteFilteredBtn.textContent;
        deleteFilteredBtn.disabled = true;
        deleteFilteredBtn.textContent = 'Deleting‚Ä¶';

        try {
          const res = await fetch('/leads/bulk-delete-by-ids', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || `Failed (${res.status})`);

          const deletedCount = data.deleted ?? ids.length;
          alert(`Deleted ${deletedCount} lead(s).`);

          if (window.refreshLeads) await window.refreshLeads();
        } catch (err) {
          console.error('Bulk delete (filtered) failed', err);
          alert(`Bulk delete failed: ${err.message || 'Unknown error'}`);
        } finally {
          deleteFilteredBtn.disabled = false;
          deleteFilteredBtn.textContent = originalText;
        }
      });
    }

    // --- ‚≠ê NEW: Geocode All Missing wiring ---
    const geocodeAllBtn = document.getElementById('geocodeAllMissingBtn');

    if (geocodeAllBtn) {
      geocodeAllBtn.addEventListener('click', async () => {
        const ok = window.confirm(
          'Geocode ALL leads that are missing latitude/longitude in the database?\n\n' +
          'This will call the backend geocoder with a short delay between requests ' +
          'to avoid rate limits.'
        );
        if (!ok) return;

        const originalText = geocodeAllBtn.textContent;
        geocodeAllBtn.disabled = true;
        geocodeAllBtn.textContent = '‚è≥ Geocoding‚Ä¶';

        try {
          // You can tweak limit/delay here if needed
          const res = await fetch('/geocode/missing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ limit: 500, delayMs: 1200 })
          });

          const data = await res.json().catch(() => null);
          if (!res.ok) {
            console.error('Bulk geocode failed', res.status, data);
            alert('Bulk geocode failed ‚Äì check backend logs.');
          } else {
            const updated = data?.result?.updatedCount ?? 0;
            const skipped = data?.result?.skippedCount ?? 0;
            alert(`Geocode complete: ${updated} updated, ${skipped} skipped.`);

            if (window.refreshLeads) await window.refreshLeads();
          }
        } catch (err) {
          console.error('Bulk geocode error', err);
          alert('Bulk geocode failed due to a network error.');
        } finally {
          geocodeAllBtn.disabled = false;
          geocodeAllBtn.textContent = originalText;
        }
      });
    }
  })();
</script>

<!-- END OF VIEW SWITCHING -->

<script>
/* ================================
   Account View Drawer Controls
   (Step 3 ‚Äì UI control + open state)
================================ */

function openAccountDrawer() {
  const drawer = document.getElementById('accountDrawer');
  drawer?.classList.remove('hidden');
  drawer?.classList.add('open'); // ‚úÖ used by other logic (delete safety)
  document.getElementById('accountsView')?.classList.add('drawer-open');
}

function closeAccountDrawer() {
  const drawer = document.getElementById('accountDrawer');
  drawer?.classList.add('hidden');
  drawer?.classList.remove('open');
  document.getElementById('accountsView')?.classList.remove('drawer-open');

  // ‚úÖ clear selected highlight (Accounts list)
  document.querySelectorAll('#accountsList .acct-row.is-selected')
    .forEach(r => r.classList.remove('is-selected'));

  // ‚úÖ focus returns cleanly
  setTimeout(() => {
    const s = document.getElementById('accountsSearch');
    if (s && typeof s.focus === 'function') s.focus();
    else document.getElementById('accountsList')?.focus?.();
  }, 0);
}

// ‚úÖ Attach listeners only after the drawer exists in the DOM
document.addEventListener('DOMContentLoaded', () => {
  document
    .getElementById('closeAccountDrawer')
    ?.addEventListener('click', (e) => {
      e.preventDefault();
      closeAccountDrawer();
    });
});

// ‚úÖ Delegated close handler (covers edge cases)
document.addEventListener('click', (e) => {
  const btn = e.target && e.target.closest ? e.target.closest('#closeAccountDrawer') : null;
  if (!btn) return;
  e.preventDefault();
  closeAccountDrawer();
});


// ‚úÖ Company click (List View) ‚Üí open Account 360 drawer (shows other contacts)
document.addEventListener('click', (e) => {
  const acctLink = e.target && e.target.closest ? e.target.closest('#leadTbody .acct360-link') : null;
  if (!acctLink) return;

  e.preventDefault();
  // critical: prevents any other document click handlers (like row ‚Üí Lead 360) from firing
  if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
  else e.stopPropagation();

  const company = String(acctLink.getAttribute('data-company') || acctLink.textContent || '').trim();
  const getter = window.dsGetAccountByCompany;
  if (typeof getter !== 'function') {
    console.warn('dsGetAccountByCompany missing; cannot open Account 360');
    alert('Account 360 helper not loaded yet. Refresh the page and try again.');
    return;
  }
  const acct = getter(company);
if (!acct) {
    alert('Could not find that account in memory. Try Refresh.');
    return;
  }

  try { openAccountDrawer(); } catch (err) {}
  try { openDrawerForAccount(acct); } catch (err) {}
});

// ESC key closes drawer
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeAccountDrawer();
});

</script>



	
	
<!-- your app scripts -->
<script src="leads.js" defer></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const mapView  = document.getElementById('mapView');
  const listView = document.getElementById('listView');
  const btnMap   = document.getElementById('btnMapView');
  const btnList  = document.getElementById('btnListView');
  
  const accountsView = document.getElementById('accountsView');
  const btnAccounts  = document.getElementById('btnAccountsView');


  const dashboard = document.getElementById('dashboard');
  const dashBtn   = document.getElementById('dashboardToggle');
  


  // --- Map/List switching ---
  function showMap() {
    if (mapView) mapView.classList.remove('hidden');
    if (listView) listView.classList.remove('show');
	if (accountsView) accountsView.classList.remove('show');


    btnMap?.classList.add('active');
    btnList?.classList.remove('active');

    btnMap?.setAttribute('aria-selected', 'true');
    btnList?.setAttribute('aria-selected', 'false');
	
	btnAccounts?.classList.remove('active');
    btnAccounts?.setAttribute('aria-selected', 'false');

  }

  function showList() {
    if (mapView) mapView.classList.add('hidden');
    if (listView) listView.classList.add('show');
	if (accountsView) accountsView.classList.remove('show');


    btnList?.classList.add('active');
    btnMap?.classList.remove('active');

    btnList?.setAttribute('aria-selected', 'true');
    btnMap?.setAttribute('aria-selected', 'false');
	
	btnAccounts?.classList.remove('active');
    btnAccounts?.setAttribute('aria-selected', 'false');


    // Render list if available
    if (typeof window.renderListView === 'function') {
      setTimeout(() => window.renderListView(), 0);
    }
  }
  
  function showAccounts() {
  if (mapView) mapView.classList.add('hidden');
  if (listView) listView.classList.remove('show');
  if (accountsView) accountsView.classList.add('show');

  btnAccounts?.classList.add('active');
  btnMap?.classList.remove('active');
  btnList?.classList.remove('active');

  btnAccounts?.setAttribute('aria-selected', 'true');
  btnMap?.setAttribute('aria-selected', 'false');
  btnList?.setAttribute('aria-selected', 'false');

  // Render Accounts immediately (Option A: derived from loaded leads)
  if (typeof window.renderAccountsView === 'function') {
    setTimeout(() => window.renderAccountsView(), 0);
  } else {
    console.warn("renderAccountsView is not available yet.");
  }
}


  btnMap?.addEventListener('click', (e) => { e.preventDefault(); showMap(); });
  btnList?.addEventListener('click', (e) => { e.preventDefault(); showList(); });
  
  btnAccounts?.addEventListener('click', (e) => {
  e.preventDefault();
  showAccounts();
});


  // --- Hide Controls toggle ---
  function setDashboardHidden(hidden) {
    if (!dashboard || !dashBtn) return;

    dashboard.classList.toggle('hidden', hidden);

    // aria + label
    dashBtn.setAttribute('aria-pressed', String(!hidden));
    dashBtn.textContent = hidden ? 'Show Controls' : 'Hide Controls';
  }

  dashBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    const isHidden = dashboard?.classList.contains('hidden');
    setDashboardHidden(!isHidden);
  });

  // Ensure initial state matches current DOM
  if (dashboard && dashBtn) {
    setDashboardHidden(dashboard.classList.contains('hidden'));
  }
});
</script>





<!-- ‚úÖ Auto-geocode helper (place near the end of <body>) -->
<script>
async function autoGeocodeMissing({ max = 25, delayMs = 1000 } = {}) {
  try {
    const res = await fetch('/summary');
    const data = await res.json();
    const leads = Array.isArray(data) ? data : (data.data || data.leads || []);

    const targets = leads
      .filter(l => (!l.latitude || !l.longitude) && (l.city || l.state || l.company))
      .slice(0, max);

    for (const lead of targets) {
      const q = [lead.company, lead.city, lead.state].filter(Boolean).join(', ');
      if (!q) continue;

      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      const geo = await fetch(url, { headers: { 'Accept-Language': 'en' } }).then(r => r.json());

      if (Array.isArray(geo) && geo[0]) {
        const lat = parseFloat(geo[0].lat);
        const lon = parseFloat(geo[0].lon);
if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
  const id = lead.id || lead.uuid;
  const base = window.DELI_API_BASE || '';
  await fetch(`${base}/update-lead/${encodeURIComponent(id)}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ latitude: lat, longitude: lon })
  });
}

      }

      // throttle to avoid 429
      await new Promise(r => setTimeout(r, delayMs));
    }

    if (window.refreshLeads) await window.refreshLeads();
  } catch (e) {
    console.warn('Auto-geocode failed:', e);
  }
}
</script>




	
<!-- ‚úÖ Add Lead Modal (fixed wrapper) -->
<div id="leadModal" class="modal hidden"
     style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 9999; display: none;
            justify-content: center; align-items: center;">

  <div class="modal-content"
       style="background: white; padding: 20px; width: 400px; max-height: 80vh;
              overflow-y: auto; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2);">

    <h2>New Lead</h2>

    <form id="leadForm">
      <input type="hidden" name="id" />

      <input name="name" placeholder="Name" required
             style="width: 100%; margin-bottom: 10px; padding: 8px;"/>

      <input name="company" placeholder="Company"
             style="width: 100%; margin-bottom: 10px; padding: 8px;"/>

      <input name="city" placeholder="City"
             style="width: 100%; margin-bottom: 10px; padding: 8px;"/>

      <select name="state"
              style="width: 100%; margin-bottom: 10px; padding: 8px;">
        <option value="">Select State</option>
        <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
        <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DC">DC</option>
        <option value="DE">DE</option><option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option>
        <option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option>
        <option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option>
        <option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option>
        <option value="MS">MS</option><option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option>
        <option value="NV">NV</option><option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option>
        <option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option>
        <option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
        <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option>
        <option value="UT">UT</option><option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option>
        <option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
      </select>


      <select name="industry"
              style="width: 100%; margin-bottom: 10px; padding: 8px;">
        <option value="">Select Industry</option>
        <option value="Manufacturing">Manufacturing</option>
        <option value="Healthcare">Healthcare</option>
        <option value="Education">Education</option>
        <option value="Hospitality">Hospitality</option>
        <option value="Construction">Construction</option>
        <option value="Government">Government</option>
        <option value="Other">Other</option>
      </select>


      <input name="tags" placeholder="Tags (comma-separated)"
             style="width: 100%; margin-bottom: 10px; padding: 8px;"/>

      <input name="cadence_name" placeholder="Cadence Name"
             style="width: 100%; margin-bottom: 10px; padding: 8px;"/>

      <input name="website" placeholder="Website"
             style="width: 100%; margin-bottom: 10px; padding: 8px;"/>

      <select name="status"
              style="width: 100%; margin-bottom: 10px; padding: 8px;">
        <option value="">Select Status</option>
        <option value="Unspecified">Unspecified ‚ö™</option>
        <option value="Converted">Converted üèÜ</option>
        <option value="Hot">Hot üî•</option>
        <option value="Warm">Warm üåû</option>
        <option value="Cold">Cold üßä</option>
        <option value="Follow-Up">Follow-Up ‚è≥</option>
        <option value="Research">Research üîç</option>
      </select>

      <label style="display:block; font-weight:600; margin-top:6px;">
        Last Touched
      </label>
      <input name="last_touched" type="date"
             style="width: 100%; margin-bottom: 10px; padding: 8px;" />

      <input name="net_new" placeholder="Net New (true/false)"
             style="width: 100%; margin-bottom: 10px; padding: 8px;" />

      <div style="display:flex; gap:8px; margin-bottom: 10px;">
        <input name="arr" placeholder="ARR (e.g. 25M)" style="flex: 1; padding: 8px;" />
        <input name="ap_spend" placeholder="AP Spend (e.g. 10M)" style="flex: 1; padding: 8px;" />
      </div>

      <input name="obstacle" placeholder="Obstacle"
             style="width: 100%; margin-bottom: 10px; padding: 8px;" />

      <input name="self_sourced" placeholder="Self Sourced (true/false)"
             style="width: 100%; margin-bottom: 10px; padding: 8px;" />

      <textarea name="notes" placeholder="Notes..."
                style="width: 100%; margin-bottom: 10px; padding: 8px;"></textarea>

      <div class="modal-buttons"
           style="display: flex; justify-content: flex-end; gap: 10px;">
        <button id="cancelLead" type="button">Cancel</button>
        <button type="submit">Save Lead</button>
      </div>
    </form>

  </div>
</div>

	
<script>

/* ===============================
   TIME ZONE HELPERS (GLOBAL)
   =============================== */

const TIMEZONE_MAP = {
  ET: ["CT","DE","DC","FL","GA","IN","KY","MA","MD","ME","MI","NC","NH","NJ","NY","OH","PA","RI","SC","TN","VA","VT","WV"],
  CT: ["AL","AR","IA","IL","KS","LA","MN","MO","MS","ND","NE","OK","SD","TX","WI"],
  MT: ["AZ","CO","ID","MT","NM","UT","WY"],
  PT: ["CA","NV","OR","WA"]
};

// Supports BOTH "UT" and "Utah"
const STATE_NAME_TO_ABBR = {
  "ALABAMA":"AL","ALASKA":"AK","ARIZONA":"AZ","ARKANSAS":"AR","CALIFORNIA":"CA",
  "COLORADO":"CO","CONNECTICUT":"CT","DELAWARE":"DE","DISTRICT OF COLUMBIA":"DC",
  "FLORIDA":"FL","GEORGIA":"GA","HAWAII":"HI","IDAHO":"ID","ILLINOIS":"IL",
  "INDIANA":"IN","IOWA":"IA","KANSAS":"KS","KENTUCKY":"KY","LOUISIANA":"LA",
  "MAINE":"ME","MARYLAND":"MD","MASSACHUSETTS":"MA","MICHIGAN":"MI","MINNESOTA":"MN",
  "MISSISSIPPI":"MS","MISSOURI":"MO","MONTANA":"MT","NEBRASKA":"NE","NEVADA":"NV",
  "NEW HAMPSHIRE":"NH","NEW JERSEY":"NJ","NEW MEXICO":"NM","NEW YORK":"NY",
  "NORTH CAROLINA":"NC","NORTH DAKOTA":"ND","OHIO":"OH","OKLAHOMA":"OK",
  "OREGON":"OR","PENNSYLVANIA":"PA","RHODE ISLAND":"RI","SOUTH CAROLINA":"SC",
  "SOUTH DAKOTA":"SD","TENNESSEE":"TN","TEXAS":"TX","UTAH":"UT","VERMONT":"VT",
  "VIRGINIA":"VA","WASHINGTON":"WA","WEST VIRGINIA":"WV","WISCONSIN":"WI","WYOMING":"WY"
};


function normalizeStateToAbbr(state) {
  if (!state) return "";
  const raw = String(state).trim();
  const up  = raw.toUpperCase();

  // Already 2-letter?
  if (/^[A-Z]{2}$/.test(up)) return up;

  // Clean dots/extra spaces (handles "D.C.")
  const cleaned = up.replace(/\./g, "").replace(/\s+/g, " ").trim();

  return STATE_NAME_TO_ABBR[cleaned] || "";
}

function getTimezoneByState(state) {
  const abbr = normalizeStateToAbbr(state);
  if (!abbr) return "UNKNOWN";

  for (const zone in TIMEZONE_MAP) {
    if (TIMEZONE_MAP[zone].includes(abbr)) return zone;
  }
  return "UNKNOWN";
}


/* ---------- List View wiring + sorting ---------- */


  // Helpers
  const $  = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  
    // Make sure website links are absolute (so "www.cuny.edu" works)
  function normalizeWebsiteUrl(url) {
    if (!url) return '';
    let u = String(url).trim();
    if (!u) return '';

    // strip any existing http/https just in case
    u = u.replace(/^https?:\/\//i, '');

    return 'https://' + u;
  }


   // Sort state
  const SORT = { key: 'company', dir: 'asc' };


// Column definitions
  const COLUMNS = [
    { key:'status',         label:'Status',         sortable:true },
    { key:'pin',            label:'Pin',            sortable:true },
    { key:'company',        label:'Company',        sortable:true },
    { key:'name',           label:'Name',           sortable:true },
    { key:'role',           label:'Role',           sortable:true },
    { key:'city',           label:'City',           sortable:true },
    { key:'state',          label:'State',          sortable:true },
    { key:'industry',       label:'Industry',       sortable:true },
    { key:'forecast_month', label:'Forecast',       sortable:true },
    { key:'linkedin',       label:'LinkedIn',       sortable:true },
    { key:'tags',           label:'Tags',           sortable:false },
    { key:'website',        label:'Website',        sortable:false },

    // ‚≠ê NEW: actions column (for delete button)
    { key:'actions',        label:'',               sortable:false },
  ];



  const STATUS_RANK = {
    converted: 0,
    hot: 1,
    warm: 2,
    'follow-up': 3,
    cold: 4,
    research: 5,
    unspecified: 6
  };
  
  

  // üîÅ Global caches for List View row editor
  window.LIST_STATE_OPTIONS = [];
  window.LIST_INDUSTRY_OPTIONS = [];

  // NEW: build Industry options from current dataset
  function buildIndustryOptions() {
    const DS = window.DS || {};
    const rows = (DS.state && (DS.state.rawRows || DS.state.filtered)) || [];
    const set = new Set();

    rows.forEach((r) => {
      const raw =
        r.industry ||
        r.Industry ||
        r.vertical ||
        r.Vertical ||
        '';
      const s = String(raw || '').trim();
      if (!s) return;
      set.add(s);
    });

    return Array.from(set).sort((a, b) =>
      a.toLowerCase().localeCompare(b.toLowerCase())
    );
  }
  
  // Normalize state labels so we don't end up with "ALABAMA" + "Alabama"
  function normalizeStateLabel(raw) {
    if (!raw) return '';
    const s = String(raw).trim();
    if (!s) return '';

    const lower = s.toLowerCase();

    // Special-case DC
    if (lower === 'dc' || lower === 'd.c.' || lower === 'district of columbia') {
      return 'District of Columbia';
    }

    // Title-case each word (alabama -> Alabama, new york -> New York)
    return lower.replace(/\b\w/g, (c) => c.toUpperCase());
  }

  // Build dropdown option lists from current data
  function buildStateOptions() {
    const DS = window.DS || {};
    const rows = (DS.state && (DS.state.rawRows || DS.state.filtered)) || [];
    const set = new Set();

    rows.forEach((r) => {
      const raw = r.state || r.State || r['State/Province'] || '';
      if (!raw) return;

      const label = normalizeStateLabel(raw);
      if (label) set.add(label);
    });

    // Sort alphabetically, case-insensitive
    return Array.from(set).sort((a, b) =>
      a.toLowerCase().localeCompare(b.toLowerCase())
    );
  }



function getCI(row, key) {
    if (!row) return '';

    // ‚≠ê NEW: handle virtual column
    if (key.toLowerCase() === 'pin') {
        const lat = row.latitude || row.lat;
        const lon = row.longitude || row.lon;
        return lat && lon ? '1' : '0';  // sortable numeric
    }


    // ‚≠ê NEW: LinkedIn status virtual column (supports linkedin or linkedin_status keys)
    if (key && String(key).toLowerCase() === 'linkedin') {
        const hitLi = Object.keys(row).find(k => {
          const lk = String(k || '').toLowerCase();
          return lk === 'linkedin' || lk === 'linkedin_status' || lk === 'linkedinstatus';
        });
        return hitLi ? (row[hitLi] ?? '') : '';
    }

    const hit = Object.keys(row).find(k => k.toLowerCase() === key.toLowerCase());
    if (hit) return row[hit] ?? '';

    // Back-compat: if UI asks for `role` but data still uses `title`
    if (key && String(key).toLowerCase() === 'role') {
      const hitTitle = Object.keys(row).find(k => k.toLowerCase() === 'title');
      return hitTitle ? (row[hitTitle] ?? '') : '';
    }
    return '';
}

  // Patch a single lead in DS.state without blowing away filters
  function patchLeadInState(id, partial) {
    const DS = window.DS || {};
    if (!DS.state) return;

    const apply = (rows) => {
      if (!Array.isArray(rows)) return;
      rows.forEach((r) => {
        const rid = r.id || r.ID || r.lead_id || r.uuid;
        if (rid != null && String(rid) === String(id)) {
          Object.keys(partial).forEach((k) => {
            r[k] = partial[k];
          });
        }
      });
    };

    apply(DS.state.rawRows);
    apply(DS.state.filtered);

    // Persist edits (so imported rows stay edited after refresh)
    try { dsUpsertLeadPatch(id, partial); } catch (e) {}

    // ‚úÖ Persist if this lead is manual (localStorage)
    try {
      const list = dsGetManualLeads();
      const idx = list.findIndex(r => String(r.id || r.lead_id || r.uuid || '') === String(id));
      if (idx >= 0) {
        Object.keys(partial || {}).forEach((k) => { list[idx][k] = partial[k]; });
        dsSetManualLeads(list);
      }
    } catch (e) {}
  }
  
    // Remove a single lead from DS.state (raw + filtered) without resetting filters
  function deleteLeadFromState(id) {
    const DS = window.DS || {};
    if (!DS.state) return;

    const remove = (rows) => {
      if (!Array.isArray(rows)) return;
      const idx = rows.findIndex((r) => {
        const rid = r.id || r.ID || r.lead_id || r.uuid;
        return rid != null && String(rid) === String(id);
      });
      if (idx !== -1) {
        rows.splice(idx, 1);
      }
    };

    remove(DS.state.rawRows);
    remove(DS.state.filtered);

    // Persist deletion (so imported rows stay deleted after refresh)
    try { dsAddDeletedLeadId(id); } catch (e) {}
  }





  function statusRankVal(s) {
    const k = String(s || '').toLowerCase();
    if (k.includes('convert')) return STATUS_RANK.converted;
    if (k.includes('hot'))     return STATUS_RANK.hot;
    if (k.includes('warm'))    return STATUS_RANK.warm;
    if (k.includes('follow'))  return STATUS_RANK['follow-up'];
    if (k.includes('cold'))    return STATUS_RANK.cold;
    if (k.includes('research'))return STATUS_RANK.research;
    return STATUS_RANK.unspecified;
  }

  // LinkedIn status rank (lower = higher priority in ASC)
  // '' (blank) = not yet reached out
  // sent = reached out
  // accepted = connection accepted
  // replied = responded to outreach
  // hard_no = explicit "no" on LinkedIn
  function linkedinRankVal(v) {
    const raw = String(v || '').trim().toLowerCase();
    if (!raw) return 0;
    if (raw.includes('hard')) return 4;
    if (raw.includes('repl') || raw.includes('resp')) return 3;
    if (raw.includes('accept') || raw.includes('connect')) return 2;
    if (raw.includes('sent') || raw.includes('outreach') || raw.includes('dm')) return 1;
    return 1; // fallback = treated like "sent"
  }

  function linkedinEmoji(v) {
    const raw = String(v || '').trim().toLowerCase();
    if (!raw) return '‚ö™';            // not reached out
    if (raw.includes('sent') || raw.includes('outreach') || raw.includes('dm')) return 'üì®';
    if (raw.includes('accept') || raw.includes('connect')) return 'ü§ù';
    if (raw.includes('repl') || raw.includes('resp')) return 'üí¨';
    if (raw.includes('hard')) return '‚õî';
    return 'üì®';
  }

  function linkedinNextVal(v) {
    const raw = String(v || '').trim().toLowerCase();
    const order = ['', 'sent', 'accepted', 'replied', 'hard_no'];
    const idx = Math.max(0, order.indexOf(raw));
    const next = order[(idx + 1) % order.length];
    return next;
  }

  
  // =====================================
// STATUS NORMALIZATION HELPERS (REQUIRED)
// =====================================

// Converts DB/CSV statuses into clean, frontend-safe keys
function statusKey(raw) {
  if (!raw) return 'unspecified';

  return String(raw)
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '-')      // turn spaces into hyphens
    .replace(/_/g, '-')        // unify underscores ‚Üí hyphens
    .replace(/[^a-z\-]/g, ''); // remove weird chars
}

// Human-friendly + emoji for display
function prettyStatus(key) {
  switch (key) {
    case 'converted':   return 'üèÜ Converted';
    case 'hot':         return 'üî• Hot';
    case 'warm':        return 'üåû Warm';
    case 'follow-up':   return '‚è≥ Follow-Up';
    case 'cold':        return 'üßä Cold';
    case 'research':    return 'üîç Research';
    case 'unspecified': return '‚ö™ Unspecified';
    default:            return '‚ö™ Unspecified';
  }
}





function renderListTable(rows, baseRows) {



  const thead = $('#leadThead');
  const tbody = $('#leadTbody');
  const count = $('#leadCount');

  // ===== List Banner: "Showing X of Y ..." =====
  const activeStatuses = $$('#listToolbar .chip.active[data-status]')
    .map(el => (el.dataset.status || '').toLowerCase())
    .filter(Boolean);

  const safeBase = Array.isArray(baseRows) ? baseRows : [];
  const safeRows = Array.isArray(rows) ? rows : [];

  function titleStatus(s) {
    if (s === 'follow-up') return 'Follow-Up';
    return (s || '').replace(/\b\w/g, c => c.toUpperCase());
  }

  if (count) {
    if (activeStatuses.length === 1) {
      const s = activeStatuses[0];
      const total = safeBase.filter(
        r => statusKey(getCI(r, 'status')) === s
      ).length;
      const shown = safeRows.length;

      count.textContent =
        `Showing ${shown} of ${total} ${titleStatus(s)} leads`;
    } else {
      count.textContent =
        `Showing ${safeRows.length} of ${safeBase.length} leads`;
    }
  }

  // ‚úÖ everything else continues BELOW




    // Header with sort indicators
    thead.innerHTML =
      '<tr id="leadHeaderRow">' +
      COLUMNS.map(c => {
        const isActive = SORT.key === c.key;
        const indicator = c.sortable
          ? `<span class="sort-indicator" style="margin-left:6px; font-size:11px; opacity:${isActive?1:.35}">
               ${isActive ? (SORT.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚ñ≤'}
             </span>`
          : '';
        const cls = c.sortable ? 'sortable' : '';
        return `<th data-key="${c.key}" class="${cls}">${c.label}${indicator}</th>`;
      }).join('') +
      '</tr>';

    // Wire header clicks
    $$('#leadThead th.sortable').forEach(th => {
      th.onclick = () => {
        const key = th.getAttribute('data-key');
        if (SORT.key === key) {
          SORT.dir = SORT.dir === 'asc' ? 'desc' : 'asc';
        } else {
          SORT.key = key;
          SORT.dir = 'asc';
        }
        window.renderListView(); // re-render with new sort
      };
    });

    const stateOptions    = buildStateOptions();
    const industryOptions = buildIndustryOptions();
	
// Status Options (must load before List View)
window.LIST_STATUS_OPTIONS = [
  { value: "Converted", label: "üèÜ Converted" },
  { value: "Hot", label: "üî• Hot" },
  { value: "Warm", label: "üåû Warm" },
  { value: "Follow-Up", label: "‚è≥ Follow-Up" },
  { value: "Cold", label: "üßä Cold" },
  { value: "Research", label: "üîç Research" },
  { value: "Unspecified", label: "‚ö™ Unspecified" }
];


    // update global caches for the inline row editor
    window.LIST_STATE_OPTIONS    = stateOptions;
    window.LIST_INDUSTRY_OPTIONS = industryOptions;


    // Rows
    const html = rows.map(r => {
	  const rawStatus = statusKey(getCI(r, 'status') || 'unspecified'); // ALWAYS normalized (follow_up ‚Üí follow-up)
	  const tz = getTimezoneByState(getCI(r,'state'));
      const statusEmoji = prettyStatus(rawStatus).split(' ')[0];        // üèÜ / üî• / üåû / ‚è≥ / üßä / üîç / ‚ö™
      const t = (v) => (v == null || v === '') ? '' : String(v);
      const website = getCI(r,'website');
      const websiteUrl = website ? normalizeWebsiteUrl(website) : '';
      const linkedin = getCI(r,'linkedin');
      const ap  = getCI(r,'ap_spend');
      const hasPin = getCI(r, 'pin') === '1';

      // DB id (case-insensitive) so we can call API routes
      const id = getCI(r, 'id') || r.id || r.lead_id || '';

      // Role enum (keep List View + Account 360 in sync)
      const roleVal = (typeof dsEnumRole === 'function')
        ? (dsEnumRole(getCI(r,'role')) || '')
        : (t(getCI(r,'role')) || '');

      const deleteCell = id
        ? `<button class="list-delete-btn"
                    data-id="${id}"
                    title="Delete this lead">üóë</button>`
        : '';

      // Tags value as plain string for initial display
      const rawTags = t(getCI(r,'tags'));

      return `<tr data-id="${id}" class="lead-row status-${rawStatus} tzrow-${tz}">


        
		
<td class="status-cell">
  <div class="ds-status-actions" style="display:flex;gap:6px;align-items:center;">
    <span class="status-badge" title="${prettyStatus(rawStatus)}">
      ${statusEmoji}
    </span>

<select class="status-select" data-id="${id}">
  <option value="Converted"   ${rawStatus === 'converted' ? 'selected' : ''}>üèÜ Converted</option>
  <option value="Hot"         ${rawStatus === 'hot' ? 'selected' : ''}>üî• Hot</option>
  <option value="Warm"        ${rawStatus === 'warm' ? 'selected' : ''}>üåû Warm</option>
  <option value="Follow-Up"   ${rawStatus === 'follow-up' ? 'selected' : ''}>‚è≥ Follow-Up</option>
  <option value="Cold"        ${rawStatus === 'cold' ? 'selected' : ''}>üßä Cold</option>
  <option value="Research"    ${rawStatus === 'research' ? 'selected' : ''}>üîç Research</option>
  <option value="Unspecified" ${rawStatus === 'unspecified' ? 'selected' : ''}>‚ö™ Unspecified</option>
</select>


<button class="ds-btn-add-to-queue"
        data-lead-id="${id}"
        title="Add to Daily Queue">‚ûï Queue</button>


  </div>
</td>




		
<td>${hasPin ? '‚úÖ' : '‚ùå'}</td>
        <td><a href="#" class="acct360-link" data-company="${String(getCI(r,'company')||'').replace(/"/g, '&quot;')}" title="Open Account 360">${t(getCI(r,'company'))}</a></td>
        <td>${t(getCI(r,'name'))}</td>
        <td class="role-cell" data-id="${id}">
  <select class="role-select" data-id="${id}" data-prev-role="${roleVal}"
          style="width:100%; padding:4px; font-size:12px; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
    <option value="" ${!roleVal ? 'selected' : ''}>‚Äî</option>
    <option value="CFO" ${roleVal==='CFO' ? 'selected' : ''}>CFO</option>
    <option value="Controller" ${roleVal==='Controller' ? 'selected' : ''}>Controller</option>
    <option value="Finance" ${roleVal==='Finance' ? 'selected' : ''}>Finance</option>
    <option value="Treasury" ${roleVal==='Treasury' ? 'selected' : ''}>Treasury</option>
    <option value="AP" ${roleVal==='AP' ? 'selected' : ''}>AP</option>
  </select>
</td>
        <td>${t(getCI(r,'city'))}</td>
        <td>
  <span class="state-pill tz-${getTimezoneByState(getCI(r,'state'))}">
    ${t(getCI(r,'state'))}
  </span>
</td>

        <td>${t(getCI(r,'industry'))}</td>
        <td>${t(getCI(r,'forecast_month') || getCI(r,'forecast'))}</td>
<td class="linkedin-cell" data-id="${id}" data-prev="${t(linkedin)}" title="LinkedIn status (click to cycle)">${linkedinEmoji(linkedin)}</td>


        <!-- ‚≠ê TAGS CELL EDITABLE -->
        <td class="tags-cell" data-id="${id}">
          <span class="tags-text">${rawTags}</span>
          <button class="tags-edit-btn" title="Edit tags">‚úèÔ∏è</button>
        </td>

        <td>${websiteUrl
              ? `<a class="website-link" href="${websiteUrl}" target="_blank" rel="noopener noreferrer">Visit</a>`
              : ''}</td>


<td class="actions-cell">
  <button class="preview-btn"
          data-id="${id}"
          title="Open Pin Preview">üëÅ Preview</button>
		  

  <button class="row-edit-btn"
          data-id="${id}"
          title="Edit State & Industry">üìù Edit</button>

  ${!hasPin 
    ? `<button class="geo-btn" data-id="${id}" title="Geocode this lead">üìç Geocode</button>`
    : ''
  }

  ${deleteCell}
</td>

      </tr>` + (() => {
        const rawNotes = String(getCI(r,'notes') || '').trim();
        if (!rawNotes) return '';
        return `<tr class="lead-notes-row" data-id="${id}"><td colspan="${COLUMNS.length}" class="lead-notes-cell"><div class="lead-notes-text">${t(rawNotes)}</div></td></tr>`;
      })();
    }).join('');

    tbody.innerHTML = html;


    // üîó LinkedIn status cell (click-to-cycle + persist)
    $$('#leadTbody .linkedin-cell').forEach(cell => {
      cell.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const id = String(cell.getAttribute('data-id') || '').trim();
        if (!id) return;

        const prev = String(cell.getAttribute('data-prev') || '').trim().toLowerCase();
        const next = linkedinNextVal(prev);

        // Optimistic UI + memory patch
        try { cell.textContent = linkedinEmoji(next); } catch(_e){}
        try { cell.setAttribute('data-prev', next); } catch(_e){}
        try {
          const patch = { linkedin_status: next, linkedin: next };
          if (typeof window.patchLeadEverywhere === 'function') window.patchLeadEverywhere(id, patch);
          else if (typeof patchLeadInState === 'function') patchLeadInState(id, patch);
          else { try { dsUpsertLeadPatch(id, patch); } catch(_e2){} }
        } catch (_e) {}

        try {
          const API_BASE = window.DELI_API_BASE || '';
          const res = await fetch(`${API_BASE}/update-lead/${encodeURIComponent(id)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ linkedin_status: next, linkedin: next })
          });

          if (!res.ok) {
            console.error('LinkedIn update failed', res.status);

            // revert UI + memory
            const revert = prev;
            try { cell.textContent = linkedinEmoji(revert); } catch(_e){}
            try { cell.setAttribute('data-prev', revert); } catch(_e){}
            try {
              const patch = { linkedin_status: revert, linkedin: revert };
              if (typeof window.patchLeadEverywhere === 'function') window.patchLeadEverywhere(id, patch);
              else if (typeof patchLeadInState === 'function') patchLeadInState(id, patch);
            } catch (_e) {}

            alert('Could not save LinkedIn status ‚Äî please try again.');
            return;
          }

          // keep list + account view in sync if open
          try { window.renderAccountsView?.(); } catch(_e){}
        } catch (err) {
          console.error('Error updating LinkedIn status', err);

          // revert UI + memory
          const revert = prev;
          try { cell.textContent = linkedinEmoji(revert); } catch(_e){}
          try { cell.setAttribute('data-prev', revert); } catch(_e){}
          try {
            const patch = { linkedin_status: revert, linkedin: revert };
            if (typeof window.patchLeadEverywhere === 'function') window.patchLeadEverywhere(id, patch);
            else if (typeof patchLeadInState === 'function') patchLeadInState(id, patch);
          } catch (_e) {}

          alert('Error saving LinkedIn status ‚Äî network or server issue.');
        }
      });
    });


 

    // üî• DELETE button handlers
    $$('#leadTbody .list-delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation(); // don‚Äôt trigger row-level events

        const id = btn.dataset.id;
        if (!id) return;

        const ok = window.confirm(
          'Delete this lead from Deli Sandwich?\n\nThis cannot be undone.'
        );
        if (!ok) return;

        try {
          const API_BASE = window.DELI_API_BASE || '';
          const res = await fetch(`${API_BASE}/leads/${encodeURIComponent(id)}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            console.error('List delete failed', res.status);
            alert('Delete failed ‚Äì please try again.');
            return;
          }

          // ‚úÖ Remove this lead from in-memory state so filters stay put
          deleteLeadFromState(id);

          // Re-render the List View with the same filters + chips
          if (typeof window.renderListView === 'function') {
            window.renderListView();
          }
        } catch (err) {
          console.error('List delete error', err);
          alert('Delete failed due to a network error.');
        }

      });
    });

    // üìç GEOCODE button handlers
    $$('#leadTbody .geo-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation(); // don‚Äôt trigger row-level events

        const id = btn.dataset.id;
        if (!id) return;

        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '‚è≥ Geocoding‚Ä¶';

        try {
          const API_BASE = window.DELI_API_BASE || '';
          const res = await fetch(`${API_BASE}/leads/${encodeURIComponent(id)}/geocode`, {
            method: 'POST'
          });

          const data = await res.json().catch(() => null);
          if (!res.ok || !data?.success) {
            console.error('Row geocode failed', res.status, data);
            alert('Geocode failed ‚Äì please try again.');
          } else {
            // ‚úÖ Try to grab new lat/lng from the response, if provided
            const updated = (data.lead || data.updated || data.row || data) || {};
            const lat = updated.latitude ?? updated.lat ?? null;
            const lng = updated.longitude ?? updated.lng ?? updated.lon ?? null;

            // ‚úÖ Patch this lead in memory so filters stay put
            if (lat != null && lng != null) {
              patchLeadInState(id, {
                latitude: lat,
                longitude: lng
              });
            }

            // Re-render the List View with current filters
            if (typeof window.renderListView === 'function') {
              window.renderListView();
            }
          }
        } catch (err) {
          console.error('Row geocode error', err);
          alert('Geocode failed due to a network error.');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    });
	


	
// üîÑ STATUS dropdown handlers
$$('#leadTbody .status-select').forEach(select => {

  // ‚úÖ Prevent row-click from hijacking the dropdown open
  ['pointerdown', 'mousedown', 'click'].forEach(evt => {
    select.addEventListener(evt, (e) => {
      e.stopPropagation();
    });
  });

  // Existing change handler (save)
  select.addEventListener('change', async (e) => {
    e.stopPropagation();

    const row = select.closest('tr');
    const id  = row?.dataset?.id;
    if (!id) return;

    const newStatus = select.value;

    try {
      const API_BASE = window.DELI_API_BASE || '';
      const res = await fetch(`${API_BASE}/update-lead/${encodeURIComponent(id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) throw new Error(`Status update failed (${res.status})`);

      const updated = await res.json().catch(() => ({}));
      const fresh   = updated.lead || updated || {};

      patchLeadInState(id, {
        status: newStatus,
        last_status_change: fresh.last_status_change || new Date().toISOString()
      });

      const marker = window.DS?.state?.markerById?.get(String(id));
      if (marker && typeof marker.setIcon === 'function') {
        marker.setIcon(iconForStatus(newStatus));
      }

    } catch (err) {
      console.error(err);
      alert('Could not update status ‚Äî please try again.');
    }
  });
});

	// üëÅ PREVIEW button handlers
$$('#leadTbody .preview-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const id = btn.dataset.id;
    if (!id) return;

    if (typeof window.focusLeadOnMap === 'function') {
      window.focusLeadOnMap(id);
    } else {
      document.getElementById('btnMapView')?.click();
    }
  });
});




    // üè∑Ô∏è TAGS INLINE EDIT HANDLERS (unchanged)
    $$('#leadTbody .tags-edit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const cell = btn.closest('.tags-cell');
        if (!cell) return;

        const id = cell.dataset.id;
        const textEl = cell.querySelector('.tags-text');
        const current = textEl ? textEl.textContent.trim() : '';

        cell.innerHTML = `
          <input class="tags-input" type="text"
                 value="${current.replace(/"/g, '&quot;')}"
                 style="width: 70%; padding: 4px; font-size: 13px;" />
          <button class="tags-save-btn" style="margin-left:4px; font-size:12px;">Save</button>
          <button class="tags-cancel-btn" style="margin-left:4px; font-size:12px;">Cancel</button>
        `;

        const input  = cell.querySelector('.tags-input');
        const save   = cell.querySelector('.tags-save-btn');
        const cancel = cell.querySelector('.tags-cancel-btn');

        if (input) {
          input.focus();
          input.select();
        }

        const restoreView = (value) => {
          cell.innerHTML = `
            <span class="tags-text">${value}</span>
            <button class="tags-edit-btn" title="Edit tags">‚úèÔ∏è</button>
          `;
        };

        if (cancel) {
          cancel.addEventListener('click', (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            restoreView(current);
          });
        }

        if (save) {
          save.addEventListener('click', async (ev) => {
            ev.preventDefault();
            ev.stopPropagation();

            if (!input || !id) return;
            const newTags = input.value.trim();

            try {
              const API_BASE = window.DELI_API_BASE || '';
              const res = await fetch(`${API_BASE}/update-lead/${encodeURIComponent(id)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags: newTags })
              });

              if (!res.ok) {
                console.error('Tags update failed', res.status);
                alert('Could not save tags ‚Äì please try again.');
                return;
              }

              // ‚úÖ Patch this lead in memory so filters stay put
              patchLeadInState(id, { tags: newTags });

              if (typeof window.renderListView === 'function') {
                window.renderListView();
              }

            } catch (err) {
              console.error('Error updating tags', err);
              alert('Error saving tags ‚Äì network or server issue.');
            }
          });
        }

        if (input) {
          input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
              ev.preventDefault();
              save?.click();
            } else if (ev.key === 'Escape') {
              ev.preventDefault();
              cancel?.click();
            }
          });
        }
      });
    });
    // ü™™ ROLE dropdown handlers (List View)
    $$('#leadTbody .role-select').forEach(select => {
      select.addEventListener('change', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        // ‚úÖ Robust id grab (supports different render shapes)
        const id = String(
          select.getAttribute('data-lead-id')
          || select.dataset.id
          || select.closest('tr')?.dataset?.id
          || ''
        ).trim();
        if (!id) return;

        const prev = select.getAttribute('data-prev-role') || '';
        const newRole =
          (typeof dsEnumRole === 'function')
            ? (dsEnumRole(select.value) || '')
            : String(select.value || '').trim();

        // Optimistic in-memory + persisted patch (so it survives refresh even if API is slow/partial)
        try {
          const patch = { role: newRole, title: newRole };
          if (typeof window.patchLeadEverywhere === 'function') {
            window.patchLeadEverywhere(id, patch);
          } else if (typeof patchLeadInState === 'function') {
            patchLeadInState(id, patch);
          } else {
            try { dsUpsertLeadPatch(id, patch); } catch (_e) {}
          }
        } catch (_e) {}

        try {
          const API_BASE = window.DELI_API_BASE || '';
          const res = await fetch(`${API_BASE}/update-lead/${encodeURIComponent(id)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: newRole, title: newRole })
          });

          if (!res.ok) {
            console.error('Role update failed', res.status);
            alert('Could not save role ‚Äì please try again.');

            // revert UI + in-memory
            select.value = prev;
            try {
              const revert = { role: prev, title: prev };
              if (typeof window.patchLeadEverywhere === 'function') window.patchLeadEverywhere(id, revert);
              else if (typeof patchLeadInState === 'function') patchLeadInState(id, revert);
            } catch (_e) {}
            return;
          }

          // Update the "prev" value so future failures revert correctly
          select.setAttribute('data-prev-role', newRole);

          // Refresh list (keeps filters)
          window.renderListView?.();

          // If Account Drawer is open, refresh it so Role dropdown reflects instantly
          try { window.renderAccountsView?.(); } catch(e){}
          setTimeout(() => {
            const drawer = document.getElementById('accountDrawer');
            if (!drawer || !drawer.classList.contains('open')) return;

            const company = String(window.DS_ACTIVE_COMPANY || '').trim();
            const cache = window.DS_ACCOUNTS_CACHE;
            const acct = Array.isArray(cache) ? cache.find(a => String(a.company||'') === company) : null;
            if (acct && typeof window.openDrawerForAccount === 'function') window.openDrawerForAccount(acct);
          }, 0);

        } catch (err) {
          console.error('Error updating role', err);
          alert('Error saving role ‚Äì network or server issue.');

          // revert UI + in-memory
          select.value = prev;
          try {
            const revert = { role: prev, title: prev };
            if (typeof window.patchLeadEverywhere === 'function') window.patchLeadEverywhere(id, revert);
            else if (typeof patchLeadInState === 'function') patchLeadInState(id, revert);
          } catch (_e) {}
        }
      });
    });

// üß± Account 360 Panel (List View Option B ‚Äî panel-only editing)

  const account360Panel = document.getElementById('account360Panel');

  // ‚úÖ Helper: find lead by id from DS memory (rawRows preferred)
  function findLeadById(id) {
    const DS = window.DS || {};
    const st = DS.state || {};
    const rows = (st.rawRows || st.filtered || []);
    if (!Array.isArray(rows)) return null;

    const target = String(id);
    return rows.find(r => {
      const rid = r.id ?? r.ID ?? r.lead_id ?? r.uuid;
      return rid != null && String(rid) === target;
    }) || null;
  }
  
window.findLeadById = findLeadById;
}


// ‚úÖ Restore selected lead after any refreshLeads() call
// (We wait until leads.js has created window.refreshLeads)

// ‚úÖ Restore selected lead after any refreshLeads() call
// (We wait until leads.js has created window.refreshLeads)





  function toNumShort(v) {
    if (v == null) return null;
    let s = String(v).trim();
    if (!s) return null;
    s = s.replace(/[\$,]/g, '').toLowerCase();
    const m = s.match(/^([\d.]+)\s*(k|m{1,2}|b)?$/);
    if (!m) {
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }
    let num = parseFloat(m[1]);
    if (!Number.isFinite(num)) return null;
    const suf = m[2];
    if (suf === 'k') num *= 1_000;
    if (suf === 'm' || suf === 'mm') num *= 1_000_000;
    if (suf === 'b') num *= 1_000_000_000;
    return num;
  }

function closeAccount360() {
  if (!account360Panel) return;

  account360Panel.classList.add('hidden');
  account360Panel.innerHTML = '';

  // ‚úÖ Option A: un-push the list when panel closes
  document.getElementById('listView')?.classList.remove('with-panel');

  // ‚úÖ Clear the row highlight
  $$('#leadTbody tr.lead-row.is-selected').forEach(tr => tr.classList.remove('is-selected'));

  // ‚úÖ Stop ‚Äúrestore selection‚Äù from re-opening the panel after close
  forgetSelectedLead();
}


  function renderAccount360Panel(lead) {
    const esc = (s='') => String(s ?? '').replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));

    const id = lead.id || lead.lead_id || lead.uuid || '';
    const website = lead.website || '';
    const websiteUrl = website ? normalizeWebsiteUrl(website) : '';

    const statusVal = (lead.status || 'unspecified').toString().toLowerCase();
    const statusOpt = (v, label) => `<option value="${v}" ${statusVal.includes(v)?'selected':''}>${label}</option>`;

    return `
      <div style="position:relative">
        <button type="button" class="close-btn acc360-close" aria-label="Close">‚úñ</button>

        <div style="font-weight:700;font-size:16px;margin-bottom:6px;">
          Lead 360 ‚Äî ${esc(lead.company || lead.name || '(Lead)')}
        </div>

        <div style="font-size:12px;color:#666;margin-bottom:12px;">
          ID: ${esc(id)}
          ${websiteUrl ? ` ‚Ä¢ <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer">Website</a>` : ''}
        </div>

        <form class="acc360-form" data-id="${esc(id)}" style="display:grid;gap:10px;">
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">State</label>
              <select name="state" style="text-transform:uppercase;text-align:center">
                ${(() => {
                  const current = String(lead.state || '').trim().toUpperCase();
                  const opts = ['', 'AL','AK','AZ','AR','CA','CO','CT','DC','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
                  return opts.map(ab => {
                    const label = ab ? ab : 'Select';
                    return `<option value="${ab}" ${ab && ab===current ? 'selected' : (!ab && !current ? 'selected' : '')}>${label}</option>`;
                  }).join('');
                })()}
              </select>
            </div>


          <div style="display:grid;gap:6px;">
            <label style="font-size:12px;color:#555;">Role</label>
            <select name="role">
              ${(() => {
                const current = String((lead.role || lead.title || '')).trim().toLowerCase();
                const opts = ['', 'CFO','Controller','Finance','Treasury','AP'];
                return opts.map(v => {
                  const label = v ? v : 'Select';
                  const isSel = (v && v.toLowerCase()===current) || (!v && !current);
                  return `<option value="${v}" ${isSel ? 'selected' : ''}>${label}</option>`;
                }).join('');
              })()}
            </select>
          </div>

          <div style="display:grid;gap:6px;">
            <label style="font-size:12px;color:#555;">Company</label>
            <input name="company" value="${esc(lead.company || '')}" />
          </div>

          <div style="display:grid;gap:6px;">
            <label style="font-size:12px;color:#555;">Website</label>
            <input name="website" value="${esc(lead.website || '')}" />
          </div>

          <div style="display:grid;grid-template-columns:1fr 90px;gap:10px;">
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">City</label>
              <input name="city" value="${esc(lead.city || '')}" />
            </div>
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">State</label>
              <input name="state" maxlength="2" style="text-transform:uppercase;text-align:center" value="${esc(lead.state || '')}" />
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">Status</label>
<select name="status">
  <option value="Converted"   ${statusVal.includes('convert') ? 'selected' : ''}>üèÜ Converted</option>
  <option value="Hot"         ${statusVal.includes('hot') ? 'selected' : ''}>üî• Hot</option>
  <option value="Warm"        ${statusVal.includes('warm') ? 'selected' : ''}>üåû Warm</option>
  <option value="Follow-Up"   ${statusVal.includes('follow') ? 'selected' : ''}>‚è≥ Follow-Up</option>
  <option value="Cold"        ${statusVal.includes('cold') ? 'selected' : ''}>üßä Cold</option>
  <option value="Research"    ${statusVal.includes('research') ? 'selected' : ''}>üîç Research</option>
  <option value="Unspecified" ${statusVal.includes('unspecified') ? 'selected' : ''}>‚ö™ Unspecified</option>
</select>

            </div>
                        <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">Industry</label>
              <select name="industry">
                ${(() => {
                  const current = String(lead.industry || '').trim();
                  const opts = ['', 'Manufacturing','Healthcare','Education','Hospitality','Construction','Government','Other'];
                  return opts.map(v => {
                    const label = v ? v : 'Select';
                    return `<option value="${v}" ${v && v===current ? 'selected' : (!v && !current ? 'selected' : '')}>${label}</option>`;
                  }).join('');
                })()}
              </select>
            </div>

          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">ARR</label>
              <input name="arr" placeholder="e.g. 25M" value="${esc(lead.arr ?? '')}" />
            </div>
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">AP Spend</label>
              <input name="ap_spend" placeholder="e.g. 50M" value="${esc(lead.ap_spend ?? '')}" />
            </div>
          </div>

          <div style="display:grid;gap:6px;">
            <label style="font-size:12px;color:#555;">Tags</label>
            <input name="tags" value="${esc(lead.tags || '')}" />
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">Competitor</label>
              <input name="competitor" value="${esc(lead.competitor || '')}" />
            </div>
            <div style="display:grid;gap:6px;">
              <label style="font-size:12px;color:#555;">Entry Point</label>
              <input name="entry_point" value="${esc(lead.entry_point || '')}" />
            </div>
          </div>

          <div style="display:grid;gap:6px;">
            <label style="font-size:12px;color:#555;">Objection</label>
            <input name="objection" value="${esc(lead.objection || '')}" />
          </div>

          <div style="display:grid;gap:6px;">
            <label style="font-size:12px;color:#555;">Notes</label>
            <textarea name="notes" rows="5">${esc(lead.notes || '')}</textarea>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px;">
            <button type="button" class="acc360-delete" style="border:1px solid #f5b5b5;background:#fff;color:#b00020;border-radius:8px;padding:8px 10px;cursor:pointer;">Delete</button>
            <button type="submit" class="acc360-save" style="border:1px solid #ddd;background:#222;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;">Save</button>
          </div>
        </form>
      </div>
    `;
  }

  function setSelectedLeadRowById(id) {
    $$('#leadTbody tr.lead-row.is-selected').forEach(tr => tr.classList.remove('is-selected'));
    const row = document.querySelector(`#leadTbody tr.lead-row[data-id="${CSS.escape(String(id))}"]`);
    if (row) row.classList.add('is-selected');
  }
  
 // ‚úÖ Persist selected lead while Account 360 is open
const DS_SELECTED_LEAD_KEY = 'deli_selected_lead_id';

function rememberSelectedLead(id) {
  const v = String(id || '');
  if (!v) return;
  sessionStorage.setItem(DS_SELECTED_LEAD_KEY, v);
}

function forgetSelectedLead() {
  sessionStorage.removeItem(DS_SELECTED_LEAD_KEY);
}

function getRememberedSelectedLeadId() {
  return sessionStorage.getItem(DS_SELECTED_LEAD_KEY);
}

// Re-open / re-render the selected lead after list refresh/filter re-render
function restoreSelectedLeadIfAny() {
  const id = getRememberedSelectedLeadId();
  if (!id) return;

  // If the lead no longer exists in memory (filtered out or removed), clear it
  const lead = (window.findLeadById && typeof window.findLeadById === 'function')
    ? window.findLeadById(id)
    : null;

  if (!lead) {
    forgetSelectedLead();
    return;
  }
  


  // Keep the row highlight in sync
  setSelectedLeadRowById(id);
  rememberSelectedLead(id);


// If panel is open, re-render it with latest memory
const panelIsOpen = account360Panel && !account360Panel.classList.contains('hidden');
if (panelIsOpen && typeof openAccount360 === 'function') {
  openAccount360(id);
}

}

(function attachRefreshRestoreWrapper() {
  function applyLocalLeadPatchesEverywhere() {
    try { if (typeof dsMergeManualLeadsIntoState === 'function') dsMergeManualLeadsIntoState(); } catch (e) { console.error(e); }
    // Re-render so List/Account/Map reflect patches after a refresh
    try { window.renderListView?.(); } catch (e) {}
    try { window.renderAccountsView?.(); } catch (e) {}
    try { window.renderMapView?.(); } catch (e) {}
  }

  function tryAttach() {
    if (!window.refreshLeads) return false;
    if (window.refreshLeads.__restoresSelected) return true;

    const _origRefreshLeads = window.refreshLeads;

    window.refreshLeads = async function (...args) {
      const res = await _origRefreshLeads.apply(this, args);

      // After every refresh, re-apply local patches so edits (like Role) survive page reloads
      setTimeout(() => {
        try { applyLocalLeadPatchesEverywhere(); } catch (e) { console.error(e); }
        try { restoreSelectedLeadIfAny(); } catch (e) { console.error(e); }
      }, 0);

      return res;
    };

    window.refreshLeads.__restoresSelected = true;

    // If refreshLeads already ran before we wrapped it, force-apply patches once on attach
    setTimeout(() => { try { applyLocalLeadPatchesEverywhere(); } catch (e) {} }, 0);

    return true;
  }

  if (tryAttach()) return;

  let tries = 0;
  const t = setInterval(() => {
    tries += 1;
    if (tryAttach() || tries > 50) clearInterval(t);
  }, 100);
})();;
 

  function openAccount360(id) {
    if (!account360Panel) return;

    const lead = window.findLeadById ? window.findLeadById(id) : null;

    if (!lead) {
      alert('Could not find that lead in memory. Try Refresh.');
      return;
    }

    // ‚úÖ render + SHOW the panel
    account360Panel.innerHTML = renderAccount360Panel(lead);
    account360Panel.classList.remove('hidden');

    // ‚úÖ Option A: push list view over
    document.getElementById('listView')?.classList.add('with-panel');

    // ‚úÖ highlight row
	rememberSelectedLead(id);
    setSelectedLeadRowById(id);
  }

  // ‚úÖ Account 360 open handlers (event delegation ‚Äî survives re-renders)
  document.addEventListener('click', (e) => {
    // Row click (ignore controls)
    const row = e.target.closest('#leadTbody tr.lead-row');
    if (row && !e.target.closest('button, a, input, select, textarea')) {
      const id = row.dataset.id;
      if (id) openAccount360(id);
      return;
    }

    // Edit button
    const editBtn = e.target.closest('#leadTbody .row-edit-btn');
    if (editBtn) {
      e.preventDefault();
      e.stopPropagation();
      const id = editBtn.dataset.id || editBtn.closest('tr')?.dataset?.id;
      if (id) openAccount360(id);
      return;
    }
  });

  // Panel close + save + delete
  if (account360Panel && !account360Panel.dataset.bound) {
    account360Panel.dataset.bound = '1';

    account360Panel.addEventListener('click', async (e) => {
      if (e.target.closest('.acc360-close')) {
        e.preventDefault();
        closeAccount360();
        return;
      }

      const delBtn = e.target.closest('.acc360-delete');
      if (delBtn) {
        e.preventDefault();
        const form = account360Panel.querySelector('.acc360-form');
        const id = form?.dataset?.id;
        if (!id) return;

        const label = (account360Panel.querySelector('div')?.textContent || 'this lead').trim();
        if (!confirm(`Delete ${label}? This cannot be undone.`)) return;

        delBtn.disabled = true;
        delBtn.textContent = 'Deleting‚Ä¶';

        try {
          const API_BASE = window.DELI_API_BASE || '';
          const res = await fetch(`${API_BASE}/leads/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if (!res.ok) throw new Error(`Delete failed (${res.status})`);

          closeAccount360();
          if (window.refreshLeads) await window.refreshLeads();
        } catch (err) {
          console.error(err);
          alert('Delete failed.');
        } finally {
          delBtn.disabled = false;
          delBtn.textContent = 'Delete';
        }
		

		
      }
    });

    account360Panel.addEventListener('submit', async (e) => {
      const form = e.target;
      if (!form.classList.contains('acc360-form')) return;
      e.preventDefault();

      const id = form.dataset.id;
      if (!id) return;

      const fd = new FormData(form);

      const payload = {
        name: (fd.get('name') || '').trim() || null,
        role: (fd.get('role') || fd.get('title') || '').trim() || null,
        company: (fd.get('company') || '').trim() || null,
        website: (fd.get('website') || '').trim() || null,
        city: (fd.get('city') || '').trim() || null,
        state: (fd.get('state') || '').trim().toUpperCase() || null,
        status: (fd.get('status') || 'unspecified').trim(),
        industry: (fd.get('industry') || '').trim() || null,
        arr: toNumShort(fd.get('arr')),
        ap_spend: toNumShort(fd.get('ap_spend')),
        tags: (fd.get('tags') || '').trim() || null,
        competitor: (fd.get('competitor') || '').trim() || null,
        objection: (fd.get('objection') || '').trim() || null,
        entry_point: (fd.get('entry_point') || '').trim() || null,
        notes: (fd.get('notes') || '') || null
      };

      // Keep backward compatibility: some backends/store may still use `title`
      if (payload.role && !payload.title) payload.title = payload.role;
      if (!payload.role && payload.title) payload.role = payload.title;


      const saveBtn = form.querySelector('.acc360-save');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving‚Ä¶';
      }

      try {
        const API_BASE = window.DELI_API_BASE || '';
        const res = await fetch(`${API_BASE}/update-lead/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || `Save failed (${res.status})`);

        // ‚úÖ Persist + sync role (and other edits) everywhere (List, Account Drawer, Account 360 Panel)
        try { dsUpsertLeadPatch(id, payload); } catch(e){}

        const merged = { ...payload, ...(data.lead || data || {}) };

        if (typeof window.patchLeadEverywhere === 'function') {
          window.patchLeadEverywhere(id, merged);
        } else if (typeof patchLeadInState === 'function') {
          patchLeadInState(id, merged);
        }
        // re-render panel with fresh memory
        const fresh = findLeadById(id) || {};
        account360Panel.innerHTML = renderAccount360Panel(fresh);
        account360Panel.classList.remove('hidden');

        if (window.refreshLeads) await window.refreshLeads();
      } catch (err) {
        console.error(err);
        alert('Save failed.');
      } finally {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save';
        }
      }
    });
  }

// =============================
// Manual Accounts (Account-first creation) ‚Äî LocalStorage
// =============================
const DS_MANUAL_ACCOUNTS_KEY = 'DS_MANUAL_ACCOUNTS_V1';

// =============================
// Manual Leads (People) ‚Äî LocalStorage
// =============================
const DS_MANUAL_LEADS_KEY = 'DS_MANUAL_LEADS_V1';


// Lead Patches + Deletes (for editing imported rows) ‚Äî LocalStorage
const DS_LEAD_PATCHES_KEY = 'DS_LEAD_PATCHES_V1';
const DS_DELETED_LEAD_IDS_KEY = 'DS_DELETED_LEAD_IDS_V1';

function dsGetLeadPatches() {
  try {
    const obj = JSON.parse(localStorage.getItem(DS_LEAD_PATCHES_KEY) || '{}');
    return (obj && typeof obj === 'object') ? obj : {};
  } catch (e) { return {}; }
}

function dsSetLeadPatches(obj) {
  try { localStorage.setItem(DS_LEAD_PATCHES_KEY, JSON.stringify(obj && typeof obj === 'object' ? obj : {})); }
  catch (e) {}
}

function dsUpsertLeadPatch(id, partial) {
  const rid = String(id || '').trim();
  if (!rid) return;

  // Only persist the fields we actually allow editing in the UI (keeps storage clean)
  const allow = ['name','role','title','status','tags','cadence','cadence_name','notes','lastTouchAt','last_touched','last_touch_at'];

  const patches = dsGetLeadPatches();
  const prev = (patches[rid] && typeof patches[rid] === 'object') ? patches[rid] : {};
  const next = { ...prev };

  allow.forEach((k) => {
    if (Object.prototype.hasOwnProperty.call(partial, k)) next[k] = partial[k];
  });

  patches[rid] = next;
  dsSetLeadPatches(patches);
}

function dsGetDeletedLeadIds() {
  try {
    const arr = JSON.parse(localStorage.getItem(DS_DELETED_LEAD_IDS_KEY) || '[]');
    return Array.isArray(arr) ? arr.map(String) : [];
  } catch (e) { return []; }
}

function dsSetDeletedLeadIds(arr) {
  try { localStorage.setItem(DS_DELETED_LEAD_IDS_KEY, JSON.stringify(Array.isArray(arr) ? arr : [])); }
  catch (e) {}
}

function dsAddDeletedLeadId(id) {
  const rid = String(id || '').trim();
  if (!rid) return;
  const prev = dsGetDeletedLeadIds();
  if (prev.includes(rid)) return;
  prev.push(rid);
  dsSetDeletedLeadIds(prev);
}

function dsGetManualLeads() {
  try {
    const arr = JSON.parse(localStorage.getItem(DS_MANUAL_LEADS_KEY) || '[]');
    return Array.isArray(arr) ? arr : [];
  } catch (e) { return []; }
}

function dsSetManualLeads(list) {
  try { localStorage.setItem(DS_MANUAL_LEADS_KEY, JSON.stringify(Array.isArray(list) ? list : [])); }
  catch (e) {}
}

function dsUuid() {
  try { return crypto.randomUUID(); } catch (e) {
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
}

function dsParseTagsCSV(str) {
  // Split on commas or pipes, trim, de-dupe (case-insensitive), and normalize spacing.
  const raw = String(str || '');
  const parts = raw.split(/[,|]/).map(s => s.trim()).filter(Boolean);

  const seen = new Set();
  const out = [];
  for (const p of parts) {
    const key = p.toLowerCase();
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(p.replace(/\s+/g, ' '));
  }
  return out.join(', ');
}

function dsNormStatus(s) {
  const v = String(s || 'Unspecified').trim().toLowerCase();
  if (v === 'converted') return 'Converted';
  if (v === 'hot') return 'Hot';
  if (v === 'warm') return 'Warm';
  if (v === 'cold') return 'Cold';
  if (v === 'research') return 'Research';
  if (v === 'follow-up' || v === 'followup') return 'Follow-Up';
  return 'Unspecified';
}

function dsTodayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function dsTitleCaseName(name) {
  // Light normalization: collapse spaces and Title-Case each word (keeps apostrophes/hyphens reasonable).
  const s = String(name || '').trim().replace(/\s+/g, ' ');
  if (!s) return '';
  return s.split(' ').map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '').join(' ');
}

function dsEnumRole(role) {
  const v = String(role || '').trim();
  if (!v) return '';
  const low = v.toLowerCase();
  if (low === 'cfo') return 'CFO';
  if (low === 'controller') return 'Controller';
  if (low === 'finance') return 'Finance';
  if (low === 'treasury') return 'Treasury';
  if (low === 'ap') return 'AP';
  return 'Finance';
}

// Merge manual leads into DS.state (idempotent)
function dsMergeManualLeadsIntoState() {
  const DS = window.DS || {};
  if (!DS.state) return;
  if (!Array.isArray(DS.state.rawRows)) DS.state.rawRows = [];
  if (!Array.isArray(DS.state.filtered)) DS.state.filtered = DS.state.rawRows;

  const rows = DS.state.rawRows;
  const existing = new Set(rows.map(r => String(r.id || r.ID || r.lead_id || r.uuid || '')).filter(Boolean));
  const manual = dsGetManualLeads();

  manual.forEach(m => {
    const mid = String(m.id || m.lead_id || m.uuid || '');
    if (!mid || existing.has(mid)) return;
    rows.push(m);
    existing.add(mid);
  });

  // Apply persisted lead edits + deletions
  try {
    const deleted = new Set(dsGetDeletedLeadIds().map(s => String(s).trim()).filter(Boolean));
    if (deleted.size) {
      DS.state.rawRows = (DS.state.rawRows || []).filter(r => !deleted.has(String(r.id || r.ID || r.lead_id || r.uuid || '').trim()));
      DS.state.filtered = (DS.state.filtered || []).filter(r => !deleted.has(String(r.id || r.ID || r.lead_id || r.uuid || '').trim()));
    }

    const patches = dsGetLeadPatches();
    const applyPatches = (rows) => {
      if (!Array.isArray(rows)) return;
      rows.forEach(r => {
        const rid = String(r.id || r.ID || r.lead_id || r.uuid || '').trim();
        if (!rid) return;
        const p = patches[rid];
        if (!p || typeof p !== 'object') return;
        Object.keys(p).forEach(k => { r[k] = p[k]; });
      });
    };
    applyPatches(DS.state.rawRows);
    applyPatches(DS.state.filtered);
  } catch (e) {}

}

// Centralized delete (used by list + drawer)
function dsDeleteAccountEverywhere(company) {
  const c = String(company || '').trim();
  if (!c) return;

  // 1) Archive company (existing behavior)
  try {
    const key = 'DS_ARCHIVED_COMPANIES';
    const prev = JSON.parse(localStorage.getItem(key) || '[]');
    const set = new Set(Array.isArray(prev) ? prev.map(s => String(s||'').toLowerCase()) : []);
    set.add(c.toLowerCase());
    localStorage.setItem(key, JSON.stringify(Array.from(set)));
  } catch (e) {}

  // 2) Remove from manual accounts
  try { dsDeleteManualAccount(c); } catch (e) {}

  // 3) Remove manual leads belonging to this company
  try {
    const keep = dsGetManualLeads().filter(r => String(r.company || r.Company || '').trim().toLowerCase() !== c.toLowerCase());
    dsSetManualLeads(keep);
  } catch (e) {}

  // 4) Remove from in-memory DS state
  const DS = window.DS || {};
  if (DS.state && Array.isArray(DS.state.rawRows)) {
    DS.state.rawRows = DS.state.rawRows.filter(r => String(r.company ?? r.Company ?? '').trim().toLowerCase() !== c.toLowerCase());
  }
  if (DS.state && Array.isArray(DS.state.filtered)) {
    DS.state.filtered = DS.state.filtered.filter(r => String(r.company ?? r.Company ?? '').trim().toLowerCase() !== c.toLowerCase());
  }

  // 5) Close drawer if active
  const drawer = document.getElementById('accountDrawer');
  if (drawer && drawer.classList.contains('open')) {
    const activeCompany = String(document.getElementById('accountCompany')?.textContent || '').trim();
    if (activeCompany && activeCompany.toLowerCase() === c.toLowerCase()) {
      try { closeAccountDrawer(); } catch (e) {}
    }
  }

  // 6) Re-render views
  if (typeof window.renderAccountsView === 'function') window.renderAccountsView();
  if (typeof window.renderListView === 'function') window.renderListView();
  if (typeof window.renderMapView === 'function') window.renderMapView();
}


// =============================
// Toast (frontend-only) ‚Äî used for Undo
// =============================
function dsEnsureToast() {
  let el = document.getElementById('dsToast');
  if (el) return el;

  el = document.createElement('div');
  el.id = 'dsToast';
  el.style.position = 'fixed';
  el.style.left = '16px';
  el.style.bottom = '16px';
  el.style.zIndex = '9999';
  el.style.maxWidth = '92vw';
  el.style.background = '#111827';
  el.style.color = '#fff';
  el.style.padding = '10px 12px';
  el.style.borderRadius = '12px';
  el.style.boxShadow = '0 10px 24px rgba(0,0,0,0.25)';
  el.style.display = 'none';
  el.style.alignItems = 'center';
  el.style.gap = '10px';
  el.style.fontSize = '13px';
  el.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, Arial';
  el.style.whiteSpace = 'nowrap';
  el.style.overflow = 'hidden';
  el.style.textOverflow = 'ellipsis';

  el.innerHTML = '<span id="dsToastMsg"></span>' +
                 '<button id="dsToastUndo" type="button" style="margin-left:10px; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.25); background:transparent; color:#fff; cursor:pointer;">Undo</button>' +
                 '<button id="dsToastClose" type="button" style="margin-left:6px; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.25); background:transparent; color:#fff; cursor:pointer;">‚úï</button>';

  document.body.appendChild(el);

  document.getElementById('dsToastClose')?.addEventListener('click', () => {
    el.style.display = 'none';
    window.__DS_LAST_DELETE = null;
  });

  return el;
}

function dsShowUndoToast(message, onUndo) {
  const toast = dsEnsureToast();
  const msgEl = document.getElementById('dsToastMsg');
  const undoBtn = document.getElementById('dsToastUndo');

  if (msgEl) msgEl.textContent = message;

  if (undoBtn) {
    undoBtn.onclick = () => {
      try { onUndo?.(); } catch (e) {}
      toast.style.display = 'none';
    };
  }

  toast.style.display = 'flex';
  setTimeout(() => {
    // auto-hide after 10s (if still visible)
    if (toast.style.display !== 'none') toast.style.display = 'none';
  }, 10000);
}


function dsShowToast(message, opts) {
  opts = opts || {};
  const toast = dsEnsureToast();
  const msgEl = document.getElementById('dsToastMsg');
  const undoBtn = document.getElementById('dsToastUndo');
  const closeBtn = document.getElementById('dsToastClose');

  if (msgEl) msgEl.textContent = String(message || '');

  // Hide Undo for normal toasts
  if (undoBtn) {
    undoBtn.style.display = 'none';
    undoBtn.onclick = null;
  }

  // Make sure Close is visible
  if (closeBtn) closeBtn.style.display = 'inline-block';

  // Variants: success | error | info | warn
  const variant = String(opts.variant || 'info').toLowerCase();
  const bg =
    variant === 'success' ? '#065f46' :
    variant === 'error'   ? '#7f1d1d' :
    variant === 'warn'    ? '#92400e' :
                            '#111827';
  toast.style.background = bg;

  toast.style.display = 'flex';

  // Auto-hide unless sticky
  const sticky = !!opts.sticky;
  const duration = Number(opts.duration || 2200);
  if (!sticky) {
    setTimeout(() => {
      if (toast.style.display !== 'none') toast.style.display = 'none';
    }, Math.max(800, duration));
  }
}



// =============================
// Drawer controls + Status dropdown wiring
// =============================
document.addEventListener('DOMContentLoaded', () => {
  // Ensure manual leads are present as soon as DS is ready
  const mergeTimer = setInterval(() => {
    const DS = window.DS || {};
    if (DS.state && Array.isArray(DS.state.rawRows)) {
      dsMergeManualLeadsIntoState();
      clearInterval(mergeTimer);
      // refresh the accounts view so manual people show up
      if (typeof window.renderAccountsView === 'function') window.renderAccountsView();
    }
  }, 250);

  // Drawer: Add Person
  const addBtn = document.getElementById('drawerAddPersonBtn');
  if (addBtn && !addBtn.dataset.wired) {
    addBtn.dataset.wired = '1';
    addBtn.addEventListener('click', () => {
      const acct = window.DS_ACTIVE_ACCOUNT || {};
      const company = String(acct.company || document.getElementById('accountCompany')?.textContent || '').trim();
      if (!company) return;

      document.getElementById('ap_company').value = company;
      document.getElementById('ap_name').value = '';
      document.getElementById('ap_role').value = '';
      document.getElementById('ap_status').value = 'Unspecified';
      document.getElementById('ap_tags').value = '';
      document.getElementById('ap_cadence').value = '';
      document.getElementById('ap_lastTouchAt').value = '';
      document.getElementById('ap_notes').value = '';

      const err = document.getElementById('ap_error');
      if (err) { err.style.display = 'none'; err.textContent = ''; }

      const m = document.getElementById('addPersonModal');
      m.classList.remove('hidden');
      m.setAttribute('aria-hidden', 'false');
      setTimeout(() => document.getElementById('ap_name')?.focus(), 0);
    });
  }

  // Drawer: Delete Account (with optional Undo toast)
  const delBtn = document.getElementById('drawerDeleteAccountBtn');
  if (delBtn && !delBtn.dataset.wired) {
    delBtn.dataset.wired = '1';
    delBtn.addEventListener('click', () => {
      const company = String(document.getElementById('accountCompany')?.textContent || '').trim();
      if (!company) return;

      const ok = confirm(`Delete "${company}" from Deli?\n\nThis deletes the account and ALL associated people (local browser).`);
      if (!ok) return;

      // Snapshot for Undo (best-effort; still frontend-only)
      const snapshot = { company };
      try {
        // archived set before
        const key = 'DS_ARCHIVED_COMPANIES';
        snapshot.archived = JSON.parse(localStorage.getItem(key) || '[]');
      } catch (e) { snapshot.archived = []; }

      try {
        snapshot.manualAccounts = dsGetManualAccounts();
      } catch (e) { snapshot.manualAccounts = []; }

      try {
        snapshot.manualLeads = dsGetManualLeads();
      } catch (e) { snapshot.manualLeads = []; }

      try {
        const DS = window.DS || {};
        snapshot.stateRaw = Array.isArray(DS.state?.rawRows) ? DS.state.rawRows.slice() : [];
        snapshot.stateFiltered = Array.isArray(DS.state?.filtered) ? DS.state.filtered.slice() : [];
      } catch (e) {
        snapshot.stateRaw = [];
        snapshot.stateFiltered = [];
      }

      window.__DS_LAST_DELETE = snapshot;

      dsDeleteAccountEverywhere(company);

      // Show Undo
      dsShowUndoToast('Account deleted ‚Äî Undo?', () => {
        const snap = window.__DS_LAST_DELETE;
        if (!snap || !snap.company) return;

        const c = String(snap.company).trim();
        if (!c) return;

        // Un-archive
        try {
          const key = 'DS_ARCHIVED_COMPANIES';
          const prev = Array.isArray(snap.archived) ? snap.archived : [];
          localStorage.setItem(key, JSON.stringify(prev));
        } catch (e) {}

        // Restore manual accounts/leads (exact snapshot)
        try { dsSetManualAccounts(Array.isArray(snap.manualAccounts) ? snap.manualAccounts : []); } catch (e) {}
        try { dsSetManualLeads(Array.isArray(snap.manualLeads) ? snap.manualLeads : []); } catch (e) {}

        // Restore DS state arrays (best effort)
        try {
          const DS = window.DS || {};
          if (!DS.state) DS.state = {};
          DS.state.rawRows = Array.isArray(snap.stateRaw) ? snap.stateRaw.slice() : [];
          DS.state.filtered = Array.isArray(snap.stateFiltered) ? snap.stateFiltered.slice() : DS.state.rawRows;
        } catch (e) {}

        window.__DS_LAST_DELETE = null;

        window.renderAccountsView?.();
        window.renderListView?.();
        window.renderMapView?.();
      });
    });
  }

  // Person row controls (Account 360 table)
  // - Status drives heat + auto-updates lastTouchAt
  // - Role/name editable inline
  // - Delete per row
  document.addEventListener('change', (e) => {
    // Helper: refresh Account 360 drawer content in-place (keeps it open + in sync)
    function refreshActiveDrawer() {
      try {
        const active = window.DS_ACTIVE_ACCOUNT || null;
        const company = String(active?.company || document.getElementById('accountCompany')?.textContent || '').trim();
        if (!company || typeof openDrawerForAccount !== 'function') return;

        const DS = window.DS || {};
        const rows = (DS.state && Array.isArray(DS.state.rawRows)) ? DS.state.rawRows : [];
        const norm = (s) => String(s || '').trim().toLowerCase();
        const leads = rows.filter(r => norm(r.company ?? r.Company ?? '') === norm(company));

        // rollups (hot/warm) + latest touch
        const statusNorm = (s) => String(s || 'Unspecified').trim().toLowerCase();
        const hot = leads.filter(l => statusNorm(l.status ?? l.Status) === 'hot').length;
        const warm = leads.filter(l => statusNorm(l.status ?? l.Status) === 'warm').length;

        let lastMs = 0;
        leads.forEach(l => {
          const t = String(l.lastTouchAt ?? l.last_touch_at ?? l.last_touched ?? l.LastTouchAt ?? '').trim();
          const ms = Date.parse(t);
          if (!isNaN(ms) && ms > lastMs) lastMs = ms;
        });

        // Pull manual account meta if present
        let meta = {};
        try {
          if (typeof dsGetManualAccounts === 'function' && typeof dsNormCompany === 'function') {
            const list = dsGetManualAccounts();
            meta = list.find(a => dsNormCompany(a.company) === dsNormCompany(company)) || {};
          }
        } catch (e) {}

        const acctFresh = {
          company,
          website: meta.website || active?.website || '',
          industry: meta.industry || active?.industry || '',
          state: meta.state || active?.state || '',
          city: meta.city || active?.city || '',
          total: leads.length,
          counts: { hot, warm },
          leads,
          lastActivityMs: lastMs
        };

        window.openDrawerForAccount(acctFresh);
      } catch (err) {}
    }

    // Role dropdown
    const roleSel = e.target && e.target.classList && e.target.classList.contains('acct-role-select') ? e.target : null;
    if (roleSel) {
      const id = String(roleSel.getAttribute('data-lead-id') || '').trim();
      const nextRole = dsEnumRole(roleSel.value || '');
      if (!id || !nextRole) return;

      if (typeof patchLeadInState === 'function') {
        // Keep "title" in sync for legacy parts of the app that still read title
        patchLeadInState(id, { role: nextRole, title: nextRole });
      }

      window.renderAccountsView?.();
      window.renderListView?.();
      window.renderMapView?.();
      refreshActiveDrawer();
      return;
    }

    // Status dropdown (primary heat driver)
    const statusSel = e.target && e.target.classList && e.target.classList.contains('acct-status-select') ? e.target : null;
    if (statusSel) {
      const id = String(statusSel.getAttribute('data-lead-id') || '').trim();
      const next = dsNormStatus(statusSel.value || 'Unspecified');
      if (!id) return;

      const today = dsTodayISO();

      if (typeof patchLeadInState === 'function') {
        patchLeadInState(id, {
          status: next,
          // ‚úÖ last touch updates when you change status
          lastTouchAt: today,
          last_touched: today,
          last_touch_at: today
        });
      }

      window.renderAccountsView?.();
      window.renderListView?.();
      window.renderMapView?.();
      refreshActiveDrawer();
      return;
    }
  });

  // Name inline save (blur or Enter)
  document.addEventListener('keydown', (e) => {
    const inp = e.target && e.target.classList && e.target.classList.contains('acct-name-input') ? e.target : null;
    if (!inp) return;
    if (e.key !== 'Enter') return;
    e.preventDefault();
    inp.blur();
  });

  document.addEventListener('blur', (e) => {
    const inp = e.target && e.target.classList && e.target.classList.contains('acct-name-input') ? e.target : null;
    if (!inp) return;

    const id = String(inp.getAttribute('data-lead-id') || '').trim();
    const nextName = dsTitleCaseName(inp.value || '');
    if (!id) return;

    inp.value = nextName;
    patchLeadInState?.(id, { name: nextName });
    window.renderAccountsView?.();
    window.renderListView?.();
    window.renderMapView?.();
  }, true);

// ================================
// Lead 360 ‚Äî Delete Person (single source of truth)
// Flag to disable legacy delete handler (prevents double-delete)
window.__DS_PERSON_DELETE_SOT = true;
// ================================
document.addEventListener('click', (e) => {
  const btn = e.target?.closest?.('.acct-person-delete');
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const id = String(btn.getAttribute('data-lead-id') || '').trim();
  if (!id) {
    console.warn('Delete clicked but no data-lead-id found');
    return;
  }

  const ok = window.confirm('Delete this person from the account?');
  if (!ok) return;

  // üî• ONE delete path only
  window.deleteLeadEverywhere?.(id, { preserveAccount: true });

  // Re-render views
  try { window.renderAccountsView?.(); } catch {}
  try { window.renderListView?.(); } catch {}
  try { window.renderMapView?.(); } catch {}

  // Refresh Account 360 drawer if still open
  try {
    const drawer = document.getElementById('accountDrawer');
    if (drawer && drawer.classList.contains('open')) {
      const company = String(window.DS_ACTIVE_COMPANY || '').trim();
      if (!company) return;

      const rows = window.DS?.state?.rawRows || [];
      const leads = rows.filter(r =>
        String(r.company ?? r.Company ?? '').trim().toLowerCase() === company.toLowerCase()
      );

      window.openDrawerForAccount({
        company,
        leads,
        total: leads.length,
        counts: {
          hot: leads.filter(l => dsNormStatus(l.status) === 'Hot').length,
          warm: leads.filter(l => dsNormStatus(l.status) === 'Warm').length
        }
      });
    }
  } catch (err) {
    console.warn('Drawer refresh failed after delete', err);
  }
}, true);


  // Add Person modal wiring
  const modal = document.getElementById('addPersonModal');
  if (modal && !modal.dataset.wired) {
    modal.dataset.wired = '1';

    function close() {
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
    }

    // Enter submits (except inside textarea)
    modal.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      const tag = String(e.target?.tagName || '').toLowerCase();
      if (tag === 'textarea') return;
      // Allow normal behavior in selects (Enter can open/close)
      if (tag === 'select') return;

      e.preventDefault();
      document.getElementById('addPersonSaveBtn')?.click();
    });

    modal.addEventListener('click', (e) => {
      if (e.target && e.target.getAttribute && e.target.getAttribute('data-close') === '1') close();
    });

    document.getElementById('addPersonCloseBtn')?.addEventListener('click', close);
    document.getElementById('addPersonCancelBtn')?.addEventListener('click', close);

    document.getElementById('addPersonSaveBtn')?.addEventListener('click', () => {
      const companyRaw = String(document.getElementById('ap_company')?.value || '').trim();
      const nameRaw = String(document.getElementById('ap_name')?.value || '').trim();
      const roleRaw = String(document.getElementById('ap_role')?.value || '').trim();
      const statusRaw = String(document.getElementById('ap_status')?.value || 'Unspecified').trim() || 'Unspecified';
      const tagsRaw = String(document.getElementById('ap_tags')?.value || '');
      const cadenceRaw = String(document.getElementById('ap_cadence')?.value || '').trim();
      const lastTouchRaw = String(document.getElementById('ap_lastTouchAt')?.value || '').trim();
      const notesRaw = String(document.getElementById('ap_notes')?.value || '').trim();

      const err = document.getElementById('ap_error');
      const hideErr = () => { if (err) { err.textContent = ''; err.style.display = 'none'; } };
      const showErr = (msg) => { if (err) { err.textContent = msg; err.style.display = 'block'; } };

      hideErr();

      const company = companyRaw;
      const name = dsTitleCaseName(nameRaw);
      const role = dsEnumRole(roleRaw);
      const status = dsNormStatus(statusRaw);
      const tags = dsParseTagsCSV(tagsRaw);
      const cadence = cadenceRaw;
      const lastTouchAt = lastTouchRaw || dsTodayISO();
      const notes = notesRaw;

      if (!company) return;
      if (!name) { showErr('Name is required.'); document.getElementById('ap_name')?.focus(); return; }
      if (!role) { showErr('Role is required.'); document.getElementById('ap_role')?.focus(); return; }

      // Prevent duplicates (same company + same name + same role)
      try {
        const norm = (s) => String(s || '').trim().toLowerCase();
        const DS = window.DS || {};
        const rows = (DS.state && Array.isArray(DS.state.rawRows)) ? DS.state.rawRows : [];
        const dup = rows.find(r =>
          norm(r.company ?? r.Company ?? '') === norm(company) &&
          norm(r.name ?? r.Name ?? '') === norm(name) &&
          norm(r.role ?? r.Role ?? r.title ?? r.Title ?? '') === norm(role)
        );

        if (dup) {
          showErr('Duplicate detected: this person already exists for this account + role.');
          return;
        }
      } catch (e) {}

      const acct = window.DS_ACTIVE_ACCOUNT || {};

      const row = {
        // ‚úÖ locked storage shape (people)
        id: dsUuid(),
        company,
        name,
        role,            // locked enum
        status,          // primary heat driver
        tags,
        cadence,
        cadence_name: cadence,
        notes,
        lastTouchAt,
        last_touched: lastTouchAt,
        last_touch_at: lastTouchAt,

        // keep legacy-friendly fields (harmless)
        title: role,
        last_touched_date: lastTouchAt,

        // account meta (best effort)
        website: String(acct.website || '').trim(),
        city: String(acct.city || '').trim(),
        state: String(acct.state || '').trim().toUpperCase(),
        industry: String(acct.industry || '').trim()
      };

      // Persist manual lead
      const manual = dsGetManualLeads();
      manual.push(row);
      dsSetManualLeads(manual);

      // Merge into state immediately
      const DS = window.DS || {};
      if (!DS.state) DS.state = {};
      if (!Array.isArray(DS.state.rawRows)) DS.state.rawRows = [];
      if (!Array.isArray(DS.state.filtered)) DS.state.filtered = DS.state.rawRows;

      DS.state.rawRows.push(row);
      if (Array.isArray(DS.state.filtered)) DS.state.filtered.push(row);

      // highlight hook
      window.DS_LAST_ADDED_LEAD_ID = row.id;
      setTimeout(() => { if (window.DS_LAST_ADDED_LEAD_ID === row.id) window.DS_LAST_ADDED_LEAD_ID = ''; }, 4000);

      close();

      // Re-render
      window.renderAccountsView?.();
      window.renderListView?.();
      window.renderMapView?.();

      // Re-open drawer for active account so the new person appears immediately
      try {
        const active = window.DS_ACTIVE_ACCOUNT || null;
        const activeCompany =
          (active && active.company) ? String(active.company) :
          String(document.getElementById('accountCompany')?.textContent || '');
        const company2 = String(activeCompany || '').trim();
        if (company2 && typeof window.openDrawerForAccount === 'function') {
          // build a fresh acct object from DS state
          const rows = DS.state.rawRows || [];
          const leads = rows.filter(r => String(r.company ?? r.Company ?? '').trim().toLowerCase() === company2.toLowerCase()).map(r => ({
            id: r.id || r.ID || r.lead_id || r.uuid,
            name: String(r.name ?? r.Name ?? '').trim(),
            title: String(r.title ?? r.Title ?? '').trim(),
            role: dsEnumRole(r.role ?? r.Role ?? r.title ?? r.Title ?? ''),
            status: dsNormStatus(r.status ?? r.Status ?? 'Unspecified'),
            recencyMs: getLastActivityMs?.(r) || 0,
            recencyText: getLastTouchText?.(r) || '',
            lastTouch: getLastTouchText?.(r) || '',
            notes: String(r.notes ?? r.Notes ?? '').trim(),
            state: String(r.state ?? r.State ?? '').trim(),
            industry: String(r.industry ?? r.Industry ?? '').trim()
          }));

          const hot = leads.filter(l => String(l.status).toLowerCase() === 'hot').length;
          const warm = leads.filter(l => String(l.status).toLowerCase() === 'warm').length;
          let lastMs = 0;
          leads.forEach(l => { if (l.recencyMs && l.recencyMs > lastMs) lastMs = l.recencyMs; });

          window.openDrawerForAccount({
            company: company2,
            website: String(acct.website || '').trim(),
            industry: String(acct.industry || '').trim(),
            state: String(acct.state || '').trim(),
            city: String(acct.city || '').trim(),
            total: leads.length,
            counts: { hot, warm },
            leads,
            lastActivityMs: lastMs
          });

          setTimeout(() => {
            document.getElementById('accountLeadsTable')?.scrollIntoView({ block: 'start', behavior: 'smooth' });
            const rowEl = document.querySelector('.acct-person-row[data-lead-id="' + row.id + '"]');
            rowEl?.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }, 60);
        }
      } catch (e) {}
    });

    document.addEventListener('keydown', (evt) => {
      if (evt.key === 'Escape' && !modal.classList.contains('hidden')) close();
    });
  }
});


function dsGetManualAccounts() {
  try {
    const arr = JSON.parse(localStorage.getItem(DS_MANUAL_ACCOUNTS_KEY) || '[]');
    return Array.isArray(arr) ? arr : [];
  } catch (e) {
    return [];
  }
}

function dsSetManualAccounts(list) {
  try {
    localStorage.setItem(DS_MANUAL_ACCOUNTS_KEY, JSON.stringify(Array.isArray(list) ? list : []));
  } catch (e) {}
}

function dsNormCompany(s) {
  return String(s || '').trim().toLowerCase();
}

function dsUpsertManualAccount(acct) {
  const list = dsGetManualAccounts();
  const key = dsNormCompany(acct.company);
  const idx = list.findIndex(a => dsNormCompany(a.company) === key);
  if (idx >= 0) list[idx] = { ...list[idx], ...acct };
  else list.push(acct);
  dsSetManualAccounts(list);
}

function dsDeleteManualAccount(company) {
  const key = dsNormCompany(company);
  const list = dsGetManualAccounts().filter(a => dsNormCompany(a.company) !== key);
  dsSetManualAccounts(list);
}

function dsParseTags(str) {
  return String(str || '')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);
}

function dsNormalizeUrl(url) {
  const u = String(url || '').trim();
  if (!u) return '';
  if (u.startsWith('http://') || u.startsWith('https://')) return u;
  return 'https://' + u;
}

// =============================
// Add Account Modal
// =============================
// ================================
// Add Account dropdown hygiene
// ================================
const DS_INDUSTRY_ENUM = [
  'Healthcare',
  'Education',
  'Hospitality',
  'Construction',
  'Manufacturing',
  'Government',
  'Other',
  'Unknown'
];

const DS_US_STATES = [
  'AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT',
  'NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'
];

function dsPopulateAddAccountDropdowns() {
  const indSel = document.getElementById('aa_industry');
  const stSel = document.getElementById('aa_state');

  // Industry options: locked base + any existing industries in dataset (to avoid losing legacy values)
  if (indSel) {
    const keepFirst = indSel.querySelector('option[value=""]');
    indSel.innerHTML = '';
    if (keepFirst) indSel.appendChild(keepFirst);

    const set = new Set(DS_INDUSTRY_ENUM);

    const DS = window.DS || {};
    const accounts = (DS.state && Array.isArray(DS.state.accounts)) ? DS.state.accounts : [];
    accounts.forEach(a => {
      const v = String((a && a.industry) || '').trim();
      if (v) set.add(v);
    });

    Array.from(set)
      .sort((a,b) => a.localeCompare(b))
      .forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        indSel.appendChild(opt);
      });
  }

  // State options: US states + Unknown (and any existing state strings)
  if (stSel) {
    const keepFirst = stSel.querySelector('option[value=""]');
    stSel.innerHTML = '';
    if (keepFirst) stSel.appendChild(keepFirst);

    const set = new Set(DS_US_STATES);
    set.add('Unknown');

    const DS = window.DS || {};
    const accounts = (DS.state && Array.isArray(DS.state.accounts)) ? DS.state.accounts : [];
    accounts.forEach(a => {
      const v = String((a && a.state) || '').trim();
      if (v) set.add(v.toUpperCase());
    });

    // Sort with DC + states first, Unknown last
    const arr = Array.from(set).filter(Boolean);
    arr.sort((a,b) => {
      if (a === 'Unknown') return 1;
      if (b === 'Unknown') return -1;
      return a.localeCompare(b);
    });

    arr.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      stSel.appendChild(opt);
    });
  }
}


function dsOpenAddAccountModal() {
  const m = document.getElementById('addAccountModal');
  if (!m) return;

  // clear fields
  const ids = ['aa_company','aa_website','aa_city','aa_state','aa_industry','aa_tags','aa_notes'];
  ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

  // populate dropdowns (industry/state)
  dsPopulateAddAccountDropdowns();

  const err = document.getElementById('aa_error');
  if (err) { err.style.display = 'none'; err.textContent = ''; }

  m.classList.remove('hidden');
  m.setAttribute('aria-hidden', 'false');

  setTimeout(() => {
    const company = document.getElementById('aa_company');
    if (company) company.focus();
  }, 0);
}

function dsCloseAddAccountModal() {
  const m = document.getElementById('addAccountModal');
  if (!m) return;
  m.classList.add('hidden');
  m.setAttribute('aria-hidden', 'true');
}

function dsSaveAccountFromModal() {
  const company = String(document.getElementById('aa_company')?.value || '').trim();
  const website = String(document.getElementById('aa_website')?.value || '').trim();
  const city    = String(document.getElementById('aa_city')?.value || '').trim();
  const state   = String(document.getElementById('aa_state')?.value || '').trim();
  const industry= String(document.getElementById('aa_industry')?.value || '').trim();
  const tagsStr = String(document.getElementById('aa_tags')?.value || '').trim();
  const notes   = String(document.getElementById('aa_notes')?.value || '').trim();

  const err = document.getElementById('aa_error');
  function showErr(msg){
    if (!err) return;
    err.textContent = msg;
    err.style.display = 'block';
  }

  if (!company) {
    showErr('Company is required.');
    return;
  }

  const acct = {
    company,
    website,
    city,
    state,
    industry,
    tags: dsParseTags(tagsStr),
    notes,
    createdAt: new Date().toISOString()
  };

  dsUpsertManualAccount(acct);

  // refresh Accounts view
  if (typeof window.renderAccountsView === 'function') window.renderAccountsView();

  // auto-open Account 360 for this account (Option A)
  try {
    const fakeAcctForDrawer = {
      company: acct.company,
      website: acct.website || '',
      industry: acct.industry || '',
      state: acct.state || '',
      city: acct.city || '',
      total: 0,
      counts: { hot: 0, warm: 0 },
      leads: [],
      lastActivityMs: 0
    };

    if (typeof window.openDrawerForAccount === 'function') {
      window.openDrawerForAccount(fakeAcctForDrawer);
    } else if (typeof openAccountDrawer === 'function') {
      // fallback: open drawer shell at least
      openAccountDrawer();
      const companyEl = document.getElementById('accountCompany');
      if (companyEl) companyEl.textContent = acct.company;
    }
  } catch (e) {}

  dsCloseAddAccountModal();
}

// Wire modal events (safe to run multiple times)
document.addEventListener('DOMContentLoaded', () => {
  const addBtn = document.getElementById('addAccountBtn');
  if (addBtn && !addBtn.dataset.wired) {
    addBtn.dataset.wired = '1';
    addBtn.addEventListener('click', dsOpenAddAccountModal);
  }

  const modal = document.getElementById('addAccountModal');
  if (modal && !modal.dataset.wired) {
    modal.dataset.wired = '1';

    modal.addEventListener('click', (e) => {
      if (e.target && e.target.getAttribute && e.target.getAttribute('data-close') === '1') {
        dsCloseAddAccountModal();
      }
    });

    const x = document.getElementById('addAccountCloseBtn');
    if (x) x.addEventListener('click', dsCloseAddAccountModal);

    const cancel = document.getElementById('addAccountCancelBtn');
    if (cancel) cancel.addEventListener('click', dsCloseAddAccountModal);

    const save = document.getElementById('addAccountSaveBtn');
    if (save) save.addEventListener('click', dsSaveAccountFromModal);

    document.addEventListener('keydown', (evt) => {
      if (evt.key === 'Escape' && !modal.classList.contains('hidden')) dsCloseAddAccountModal();
    });
  }
});


function getArchivedCompaniesSet() {
  try {
    const arr = JSON.parse(localStorage.getItem('DS_ARCHIVED_COMPANIES') || '[]');
    const norm = (Array.isArray(arr) ? arr : []).map(s => String(s || '').trim().toLowerCase()).filter(Boolean);
    return new Set(norm);
  } catch (e) {
    return new Set();
  }
}

function getFilteredRows() {
  const DS = window.DS || {};
  // Base set: use current filtered if it exists, otherwise fall back to all raw rows.
  // This prevents List View filters from "breaking" when DS.state.filtered is empty/uninitialized.
  const base =
    (DS.state && Array.isArray(DS.state.filtered) && DS.state.filtered.length)
      ? DS.state.filtered
      : ((DS.state && Array.isArray(DS.state.rawRows)) ? DS.state.rawRows : []);

  const out = Array.isArray(base) ? base : [];
  const archived = getArchivedCompaniesSet();
  if (!archived.size) return out;

  return out.filter(r => {
    const c = String(r.company ?? r.Company ?? '').trim().toLowerCase();
    return !archived.has(c);
  });
}

// ================================
// COMPANY FILTER (true global filter)
// ================================
function normCompany(s) {
  return String(s || '').trim().toLowerCase();
}

function setCompanyFilter(companyName) {
  const DS = window.DS || {};
  if (!DS.state) DS.state = {};

  const company = String(companyName || '').trim();
  if (!company) return;

  // Save the current "base filtered" set once (so we can restore later)
  if (!Array.isArray(DS.state._filteredBase)) {
    DS.state._filteredBase = Array.isArray(DS.state.filtered)
      ? DS.state.filtered.slice()
      : [];
  }

  DS.state.companyFilter = company;

  const base = DS.state._filteredBase;
  DS.state.filtered = base.filter(r => {
    const c = r.company ?? r.Company ?? '';
    return normCompany(c) === normCompany(company);
  });

  // Re-render List immediately (Map will reflect DS.state.filtered if it redraws from state)
  if (typeof window.renderListView === 'function') {
    window.renderListView();
  }

  // Best-effort Map refresh (only if one of these exists)
  try {
    if (typeof window.renderMapView === 'function') window.renderMapView();
    else if (typeof window.renderMap === 'function') window.renderMap();
    else if (typeof window.updateMap === 'function') window.updateMap();
    else if (typeof window.refreshMap === 'function') window.refreshMap();
  } catch (e) {}
}

function clearCompanyFilter() {
  const DS = window.DS || {};
  if (!DS.state) return;

  DS.state.companyFilter = '';

  // Restore base filtered set if we have it
  if (Array.isArray(DS.state._filteredBase)) {
    DS.state.filtered = DS.state._filteredBase.slice();
  }

  // Clear saved base so next filter starts fresh
  DS.state._filteredBase = null;

  if (typeof window.renderListView === 'function') {
    window.renderListView();
  }

  try {
    if (typeof window.renderMapView === 'function') window.renderMapView();
    else if (typeof window.renderMap === 'function') window.renderMap();
    else if (typeof window.updateMap === 'function') window.updateMap();
    else if (typeof window.refreshMap === 'function') window.refreshMap();
  } catch (e) {}
}



// Apply List toolbar filters (search + chips), then sort
function computeListFilteredAndSorted() {
  const q = ($('#listSearch')?.value || '').trim().toLowerCase();

  // ‚≠ê NEW: tag-only filter for List view
  const tagQ = ($('#listTagFilter')?.value || '').trim().toLowerCase();

  const activeStatuses = $$('#listToolbar .chip.active[data-status]')
    .map(el => el.dataset.status.toLowerCase());
	
	// ‚≠ê NEW: active timezone chips (ET/CT/MT/PT/UNKNOWN)
const activeTZs = $$('#listToolbar .chip.active[data-tz]')
  .map(el => (el.dataset.tz || '').toUpperCase())
  .filter(Boolean);


  let rows = getFilteredRows();
  
  // ‚úÖ Force List View to mirror Map filters exactly
rows = Array.isArray(rows) ? rows : [];


  // Status chip filter (normalized)
  if (activeStatuses.length) {
    rows = rows.filter(r => {
      const s = statusKey(getCI(r, 'status'));
      return activeStatuses.includes(s);
    });
  }
  
  // ‚≠ê Timezone chip filter (based on State ‚Üí TZ mapping)
if (activeTZs.length) {
  rows = rows.filter(r => {
    const tz = getTimezoneByState(getCI(r, 'state'));
    return activeTZs.includes(String(tz || 'UNKNOWN').toUpperCase());
  });
}




  // Global search (name, company, city, state, tags, etc.)
  if (q) {
    rows = rows.filter(r => {
      const hay = [
        getCI(r, 'name'),
        getCI(r, 'role'),
        getCI(r, 'company'),
        getCI(r, 'city'),
        getCI(r, 'state'),
        getCI(r, 'tags'),
        getCI(r, 'industry'),
        getCI(r, 'notes'),
        getCI(r, 'cadence_name'),
        getCI(r, 'lead_type'),
        getCI(r, 'website')
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  // ‚≠ê Tag-only filter: matches JUST on tags column
  if (tagQ) {
    rows = rows.filter(r => {
      const tags = String(getCI(r, 'tags') || '').toLowerCase();
      return tags.includes(tagQ);
    });
  }

  // ---- SORTING ----
  const { key, dir } = SORT;
  const asc = dir === 'asc' ? 1 : -1;

  rows = rows.slice().sort((a, b) => {
    // Status uses custom rank
    if (key === 'status') {
      return (
        asc *
        (statusRankVal(getCI(a, 'status')) -
          statusRankVal(getCI(b, 'status')))
      );
    }


    // LinkedIn uses custom rank (blank first in ASC)
    if (key === 'linkedin') {
      return asc * (linkedinRankVal(getCI(a, 'linkedin')) - linkedinRankVal(getCI(b, 'linkedin')));
    }

    const col = COLUMNS.find(c => c.key === key);
    const avRaw = getCI(a, key);
    const bvRaw = getCI(b, key);

    // Nulls last
    const aNull = avRaw === null || avRaw === undefined || avRaw === '';
    const bNull = bvRaw === null || bvRaw === undefined || bvRaw === '';
    if (aNull && !bNull) return 1;
    if (!aNull && bNull) return -1;
    if (aNull && bNull) return 0;

    if (col && col.numeric) {
      const av = Number(avRaw);
      const bv = Number(bvRaw);
      return asc * ((av > bv) - (av < bv));
    }

    const av = String(avRaw).toLowerCase();
    const bv = String(bvRaw).toLowerCase();
    return asc * av.localeCompare(bv, undefined, {
      numeric: true,
      sensitivity: 'base'
    });
  });

  return rows;
}


  // Public render fn
function renderListView() {

  // SAFETY: DS must exist
  const DS = window.DS;
  if (!DS || !DS.state) {
    // Don't hard-error; DS is initialized asynchronously in some flows.
    return;
  }

  const rows = computeListFilteredAndSorted();
  if (!Array.isArray(rows)) return;

  renderListTable(rows, getFilteredRows());

  setTimeout(() => {
    try { restoreSelectedLeadIfAny(); } catch (e) { console.error(e); }
  }, 0);
}

window.renderListView = renderListView;

// Back-compat: some code paths still call window.renderList()
if (typeof window.renderList !== 'function') {
  window.renderList = renderListView;
}

// ================================
// LIST TOOLBAR WIRING (chips + search)
// ================================
function wireListToolbar() {
  const toolbar = document.getElementById('listToolbar');
  if (!toolbar) return;

  // Prevent double-wiring
  if (toolbar.dataset.wired === '1') return;
  toolbar.dataset.wired = '1';

  const searchEl = document.getElementById('listSearch');
  const tagEl    = document.getElementById('listTagFilter');
  const resetEl  = document.getElementById('listReset');

  const safeRender = () => {
    if (typeof window.renderListView === 'function') window.renderListView();
  };

  // Search boxes
  if (searchEl) searchEl.addEventListener('input', safeRender);
  if (tagEl)    tagEl.addEventListener('input', safeRender);

  // Status + TZ chips
  toolbar
    .querySelectorAll('button.chip[data-status], button.chip[data-tz]')
    .forEach((btn) => {
      btn.type = 'button';
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        btn.classList.toggle('active');
        safeRender();
      });
    });

  // Reset button
  if (resetEl) {
    resetEl.type = 'button';
    resetEl.addEventListener('click', (e) => {
      e.preventDefault();

      // Clear active chips
      toolbar.querySelectorAll('.chip.active')
        .forEach((b) => b.classList.remove('active'));

      // Clear search inputs
      if (searchEl) searchEl.value = '';
      if (tagEl) tagEl.value = '';

      safeRender();
    });
  }
}

// Wire once DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  wireListToolbar();
});

// Optional: expose for debugging
window.wireListToolbar = wireListToolbar;

</script>

// ================================
// ACCOUNTS VIEW (Expandable)
// ================================


<script>

window.renderAccountsView = function renderAccountsView() {
  const content = document.getElementById('accountsContent');
  if (!content) return;

  const DS = window.DS || {};
  const allRows = (DS.state && Array.isArray(DS.state.rawRows)) ? DS.state.rawRows : [];
  const filteredRows = (DS.state && Array.isArray(DS.state.filtered)) ? DS.state.filtered : [];
  let rows = (filteredRows && filteredRows.length) ? filteredRows : allRows;

  // Exclude archived (deleted) companies from Accounts view
  const archivedCompanies = getArchivedCompaniesSet();
  if (archivedCompanies && archivedCompanies.size) {
    rows = rows.filter(r => !archivedCompanies.has(String(r.company ?? r.Company ?? '').trim().toLowerCase()));
  }

  if (!rows.length) {
    const headerCountEl = document.getElementById('accountsHeaderCount');
    if (headerCountEl) headerCountEl.textContent = 'Showing 0 of 0 accounts';

    content.innerHTML = '<div style="padding:12px; color:#6b7280; font-size:13px;">No accounts.</div>';
    return;
  }


  // -------- helpers ----------
  const STATUS_ORDER = { converted: 0, hot: 1, warm: 2, 'follow-up': 3, followup: 3, research: 4, cold: 5, unspecified: 6 };

  function statusEmoji(s) {
    const v = String(s || 'Unspecified').trim().toLowerCase();
    if (v === 'converted') return 'üèÜ';
    if (v === 'hot') return 'üî•';
    if (v === 'warm') return 'üåû';
    if (v === 'cold') return 'üßä';
    if (v === 'research') return 'üîç';
    if (v === 'follow-up' || v === 'followup') return '‚è≥';
    return '‚ö™';
  }

  function safe(x) {
    return String(x ?? '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
  
    function normalizeUrl(url) {
    const u = String(url ?? '').trim();
    if (!u) return '';
    if (u.startsWith('http://') || u.startsWith('https://')) return u;
    return 'https://' + u;
  }

  function hrefSafe(url) {
    // Prevent quotes from breaking HTML attributes
    return normalizeUrl(url).replace(/"/g, '%22').replace(/'/g, '%27');
  }


  function mostCommonKey(countsObj) {
    let bestKey = '';
    let bestVal = -1;
    for (const [k, v] of Object.entries(countsObj || {})) {
      if (v > bestVal) { bestVal = v; bestKey = k; }
    }
    return bestKey;
  }

  function getName(r) {
    const n = r.name ?? r.Name ?? r.full_name ?? r.FullName ?? r.contact ?? r.Contact ?? '';
    return String(n || '').trim();
  }

  function getTitle(r) {
    const t = r.role ?? r.Role ?? r.title ?? r.Title ?? r.job_title ?? r.JobTitle ?? '';
    return String(t || '').trim();
  }

  function getState(r) {
    const s = r.state ?? r.State ?? r.st ?? r.ST ?? r.region_state ?? r.RegionState ?? '';
    return String(s || '').trim();
  }

  function getIndustry(r) {
    const v =
      r.industry ?? r.Industry ??
      r.vertical ?? r.Vertical ??
      r.icp_vertical ?? r.ICPVertical ??
      r.segment ?? r.Segment ??
      '';

    const raw = String(v || '').trim();
    if (raw) return raw;

    const tags = String(r.tags ?? r.Tags ?? '').trim();
    if (!tags) return '';
    const parts = tags.split(/[,|]/).map(x => x.trim()).filter(Boolean);

    const ignore = new Set(['ap', 'finance', 'treasury', 'controller', 'cfo', 'follow-up', 'followup']);
    const pick = parts.find(x => !ignore.has(x.toLowerCase()));
    return pick || (parts[0] || '');
  }

  function getLastActivityMs(r) {
    const d =
      r.lastTouchAt ?? r.last_touch_at ?? r.LastTouchAt ??
      r.last_touched ?? r.last_touch ?? r.LastTouch ??
      r.last_touch_date ?? r.LastTouchDate ??
      r.last_activity ?? r.LastActivity ??
      r.last_activity_date ?? r.LastActivityDate ??
      r.last_contacted ?? r.LastContacted ??
      '';

    const raw = String(d || '').trim();
    if (!raw) return null;

    const dt = new Date(raw);
    if (isNaN(dt.getTime())) return null;

    dt.setHours(0,0,0,0);
    return dt.getTime();
  }

  function getLastTouchText(r) {
    const d =
      r.lastTouchAt ?? r.last_touch_at ?? r.LastTouchAt ??
      r.last_touched ?? r.last_touch ?? r.LastTouch ??
      r.last_touch_date ?? r.LastTouchDate ??
      r.last_activity ?? r.LastActivity ??
      r.last_activity_date ?? r.LastActivityDate ??
      r.last_contacted ?? r.LastContacted ??
      '';
    const raw = String(d || '').trim();
    if (!raw) return 'Never';

    const dt = new Date(raw);
    if (!isNaN(dt.getTime())) {
      const today = new Date();
      today.setHours(0,0,0,0);
      dt.setHours(0,0,0,0);
      const diff = Math.round((today - dt) / 86400000);
      if (diff <= 0) return 'Last touch: 0d';
      return 'Last touch: ' + diff + 'd';
    }
    return 'Last touch: ' + raw;
  }

function normalizeRole(title) {
  const t = String(title || '').toLowerCase().trim();
  if (!t) return 'Finance'; // sensible default instead of ‚ÄúOther‚Äù

  if (t.includes('chief financial') || t === 'cfo' || t.includes(' cfo')) return 'CFO';
  if (t.includes('controller')) return 'Controller';
  if (t.includes('treasur')) return 'Treasury';

  // Any AP-ish phrasing collapses to AP
  if (t === 'ap' || t.includes('accounts payable') || t.includes('account payable') || t.includes('a/p')) return 'AP';

  // Everything else becomes Finance (keeps it clean + prevents ‚ÄúOther‚Äù junk)
  return 'Finance';
}

/* ==========================================================
   Account lookup helper (List View ‚Üí Account 360 Drawer)
   ========================================================== */
function dsGetAccountByCompany(company) {
  const key = String(company || '').trim().toLowerCase();
  if (!key) return null;

  const DS = window.DS || {};
  const rows = (DS.state && Array.isArray(DS.state.rawRows)) ? DS.state.rawRows : [];
  const matches = rows.filter(r => String(r.company ?? r.Company ?? '').trim().toLowerCase() === key);

  if (!matches.length) return null;

  const acct = {
    company: String(matches[0].company ?? matches[0].Company ?? '').trim(),
    website: String(matches[0].website ?? matches[0].Website ?? matches[0].url ?? matches[0].URL ?? '').trim(),
    counts: { hot: 0, warm: 0 },
    leads: []
  };

  for (const r of matches) {
    const statusRaw = String(r.status ?? r.Status ?? 'Unspecified').trim() || 'Unspecified';
    const statusK = statusKey(statusRaw);
    if (statusK === 'hot') acct.counts.hot += 1;
    if (statusK === 'warm') acct.counts.warm += 1;

    const id = String(r.id ?? r.ID ?? r.lead_id ?? r.leadId ?? r.uuid ?? '').trim();
    acct.leads.push({
      id,
      name: getName(r) || '‚Äî',
      role: (typeof dsEnumRole === 'function') ? (dsEnumRole(getTitle(r)) || '') : (getTitle(r) || ''),
      status: statusRaw,
      state: getState(r),
      industry: getIndustry(r),
      website: String(r.website ?? r.Website ?? '').trim(),
      recencyMs: getLastActivityMs(r) || 0,
      recencyText: getLastTouchText(r),
      notes: String(r.notes ?? r.Notes ?? '').trim()
    });
  }

  acct.state = getState(matches[0]) || (acct.leads[0]?.state || '‚Äî');
  acct.industry = getIndustry(matches[0]) || (acct.leads[0]?.industry || '‚Äî');

  return acct;
}

// Expose helper globally (works even if this script runs as a module)
window.dsGetAccountByCompany = dsGetAccountByCompany;


const coreRoles = ['CFO', 'Controller', 'Finance', 'Treasury', 'AP'];

/* ==========================================================
   v1 Coverage Strip (Account 360 drawer)
   - Shows which entry points have ‚â•1 lead
   - Click missing pill ‚Üí opens Add Person modal pre-filled to that role
   ========================================================== */
function dsBuildCoverage(acct){
  const leads = Array.isArray(acct?.leads) ? acct.leads : [];
  const counts = { CFO:0, Controller:0, Finance:0, Treasury:0, AP:0 };
  for (const l of leads) {
    const roleRaw = (l && (l.role ?? l.Role ?? l.title ?? l.Title)) || '';
    const role = dsEnumRole(roleRaw);
    if (counts.hasOwnProperty(role)) counts[role] += 1;
  }
  return counts;
}

function dsRenderCoverageStrip(acct){
  const strip = document.getElementById('coverageStrip');
  const sumEl = document.getElementById('coverageSummary');
  if (!strip) return;

  const counts = dsBuildCoverage(acct);
  let filled = 0;

  const pills = coreRoles.map(role => {
    const n = Number(counts[role] || 0);
    const isFilled = n > 0;
    if (isFilled) filled += 1;

    const cls = isFilled ? 'coverage-pill filled' : 'coverage-pill missing';
    const hint = isFilled ? 'Filled' : 'Missing ‚Äî click to add';
    const countText = isFilled ? (n === 1 ? '1 lead' : `${n} leads`) : '+ Add';

    return `
      <div class="${cls}" role="button" tabindex="0"
           data-role="${role}" data-missing="${isFilled ? '0' : '1'}"
           aria-label="${role}: ${hint}">
        <span class="dot" aria-hidden="true"></span>
        <span class="role">${role}</span>
        <span class="count">${countText}</span>
      </div>
    `;
  }).join('');

  strip.innerHTML = pills;

  if (sumEl) sumEl.textContent = `${filled}/5 filled`;
}

// Delegated click/keyboard handler for Coverage Strip
document.addEventListener('click', (e) => {
  const pill = e.target?.closest?.('.coverage-pill');
  if (!pill) return;
  const missing = String(pill.getAttribute('data-missing') || '') === '1';
  if (!missing) return;

  const role = String(pill.getAttribute('data-role') || '').trim();
  if (!role) return;

  // Open Add Person modal like the normal button, then prefill role
  document.getElementById('drawerAddPersonBtn')?.click();
  const sel = document.getElementById('ap_role');
  if (sel) sel.value = role;
});

document.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const pill = e.target?.closest?.('.coverage-pill');
  if (!pill) return;
  const missing = String(pill.getAttribute('data-missing') || '') === '1';
  if (!missing) return;

  e.preventDefault();
  pill.click();
});



  // -------- build accounts map ----------
  const map = new Map();

  for (const r of rows) {
    const company = String(r.company ?? r.Company ?? '').trim();
    if (!company) continue;

    const status = String(r.status ?? r.Status ?? 'Unspecified').trim() || 'Unspecified';
    const name = getName(r) || '‚Äî';
    const title = getTitle(r) || '';
    const role = normalizeRole(title);

    const st = getState(r);
    const industry = getIndustry(r);
	const website = String(r.website ?? r.Website ?? r.url ?? r.URL ?? r.site ?? r.Site ?? '').trim();

    const activityMs = getLastActivityMs(r);

    if (!map.has(company)) {
      map.set(company, {
       company,
       website: website || '',
       total: 0,

        counts: { hot: 0, warm: 0, cold: 0, converted: 0, research: 0, followup: 0, other: 0, unspecified: 0 },
        leads: [],
        lastActivityMs: null,
        hasHotWarm: false,

        stateCounts: {},
        industryCounts: {},
        state: '',
        industry: '',
        tz: 'UNKNOWN'
      });
    }

    const obj = map.get(company);
	if (website && !obj.website) obj.website = website;


    if (st) obj.stateCounts[st] = (obj.stateCounts[st] || 0) + 1;
    if (industry) obj.industryCounts[industry] = (obj.industryCounts[industry] || 0) + 1;

    if (activityMs && (!obj.lastActivityMs || activityMs > obj.lastActivityMs)) {
      obj.lastActivityMs = activityMs;
    }

    obj.total += 1;

    const s = status.toLowerCase();
    if (s === 'hot' || s === 'warm') obj.hasHotWarm = true;

    if (s === 'hot') obj.counts.hot += 1;
    else if (s === 'warm') obj.counts.warm += 1;
    else if (s === 'cold') obj.counts.cold += 1;
    else if (s === 'converted') obj.counts.converted += 1;
    else if (s === 'research') obj.counts.research += 1;
    else if (s === 'follow-up' || s === 'followup') obj.counts.followup += 1;
    else if (s === 'unspecified') obj.counts.unspecified += 1;
    else obj.counts.other += 1;

    obj.leads.push({
      id: String(r.id ?? r.ID ?? r.lead_id ?? r.leadId ?? r.uuid ?? '').trim(),
      company: company,

      name,
      title,
      role,
      status,

      tags: String(r.tags ?? r.Tags ?? '').trim(),
      cadence: String(r.cadence ?? r.Cadence ?? r.cadence_name ?? r.CadenceName ?? '').trim(),
      notes: String(r.notes ?? r.Notes ?? '').trim(),

      lastTouchAt: String(r.lastTouchAt ?? r.last_touch_at ?? r.last_touched ?? r.last_touch ?? r.LastTouchAt ?? r.LastTouch ?? '').trim(),
      lastTouch: getLastTouchText(r),

      // ‚úÖ these power the 360 drawer meta + ‚Äúindustry pill‚Äù reliability
      state: st,
      industry: industry,
      recencyMs: activityMs || 0,
      recencyText: getLastTouchText(r),
      notes: String(r.notes ?? r.Notes ?? '').trim()
    });
  }

  // Finalize account-level fields (state, industry, timezone)
  const today = new Date();
  today.setHours(0,0,0,0);
  const todayMs = today.getTime();

  for (const a of map.values()) {
    a.state = mostCommonKey(a.stateCounts) || '';
    a.industry = mostCommonKey(a.industryCounts) || '';

    try {
      if (a.state && typeof getTimezoneByState === 'function') {
        a.tz = getTimezoneByState(a.state) || 'UNKNOWN';
      } else {
        a.tz = 'UNKNOWN';
      }
    } catch (e) {
      a.tz = 'UNKNOWN';
    }

    let daysSince = 9999;
    if (a.lastActivityMs) daysSince = Math.round((todayMs - a.lastActivityMs) / 86400000);
    a.daysSinceActivity = daysSince;

    if (daysSince >= 14) {
      a.health = 'stalled';
      a.healthLabel = 'Stalled';
    } else if (a.hasHotWarm) {
      a.health = 'healthy';
      a.healthLabel = 'Healthy';
    } else {
      a.health = 'risk';
      a.healthLabel = 'At Risk';
    }

    a.healthTooltip = a.healthLabel + ' ‚Ä¢ Last activity: ' + (daysSince >= 9999 ? 'Never' : daysSince + 'd');
  }
  
    // -----------------------------
  // Merge Manual Accounts (even if they have 0 leads)
  // -----------------------------
  const manual = dsGetManualAccounts();
  for (const a of manual) {
    const company = String(a.company || '').trim();
    if (!company) continue;

    if (!map.has(company)) {
      map.set(company, {
        company,
        website: String(a.website || '').trim(),
        city: String(a.city || '').trim(),
        state: String(a.state || '').trim(),
        industry: String(a.industry || '').trim(),
        tags: Array.isArray(a.tags) ? a.tags : [],
        notes: String(a.notes || '').trim(),
        total: 0,
        counts: { hot: 0, warm: 0 },
        leads: [],
        lastActivityMs: 0
      });
    } else {
      // If derived account exists, fill missing account-level fields from manual entry
      const existing = map.get(company);
      if (existing) {
        if (!existing.website && a.website) existing.website = String(a.website || '').trim();
        if (!existing.city && a.city) existing.city = String(a.city || '').trim();
        if (!existing.state && a.state) existing.state = String(a.state || '').trim();
        if (!existing.industry && a.industry) existing.industry = String(a.industry || '').trim();
        if ((!existing.tags || !existing.tags.length) && Array.isArray(a.tags) && a.tags.length) existing.tags = a.tags;
        if (!existing.notes && a.notes) existing.notes = String(a.notes || '').trim();
      }
    }
  }


    // Sort preference (Account-first)
  const sortPref = String(localStorage.getItem('DS_ACCOUNTS_SORT') || 'recent').toLowerCase(); // 'recent' | 'hottest'

  const accounts = Array.from(map.values())
    .sort((a, b) => {
      if (sortPref === 'hottest') {
        const ah = Number(a.counts?.hot || 0);
        const aw = Number(a.counts?.warm || 0);
        const bh = Number(b.counts?.hot || 0);
        const bw = Number(b.counts?.warm || 0);

        const aHeat = (ah * 1000) + (aw * 100) + (Number(a.total || 0));
        const bHeat = (bh * 1000) + (bw * 100) + (Number(b.total || 0));
        if (bHeat !== aHeat) return bHeat - aHeat;

        // tie-breaker: most recent touch
        const aMs = a.lastActivityMs || 0;
        const bMs = b.lastActivityMs || 0;
        if (bMs !== aMs) return bMs - aMs;

        return a.company.localeCompare(b.company);
      }

      // Default: most recent touch
      const aMs = a.lastActivityMs || 0;
      const bMs = b.lastActivityMs || 0;
      if (bMs !== aMs) return bMs - aMs;
      return (b.total - a.total) || a.company.localeCompare(b.company);
    });

  
  // Cache for re-opening drawer after edits
  window.DS_ACCOUNTS_CACHE = accounts;
// -------- render toolbar + list ----------
  content.innerHTML =
    '<div id="accountsToolbar" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px;">' +

      '<input id="accountsSearch" type="search" placeholder="Search accounts‚Ä¶" ' +
        'style="width:320px; max-width:70vw; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px;" />' +

      '<input id="accountsTagFilter" type="search" placeholder="Industry / tag‚Ä¶" aria-label="Filter by industry or tag" ' +
        'style="min-width:160px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px;" />' +

      '<select id="accountsSort" aria-label="Sort accounts" ' +
        'style="padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; background:#fff;">' +
        '<option value="recent">Sort: Most recent touch</option>' +
        '<option value="hottest">Sort: Hottest accounts</option>' +
      '</select>' +

      '<span style="margin-left:6px; font-size:12px; color:#6b7280;">TZ:</span>' +
      '<button class="chip tz-chip" data-tz="ET">ET</button>' +
      '<button class="chip tz-chip" data-tz="CT">CT</button>' +
      '<button class="chip tz-chip" data-tz="MT">MT</button>' +
      '<button class="chip tz-chip" data-tz="PT">PT</button>' +
      '<button class="chip tz-chip" data-tz="UNKNOWN">Unknown</button>' +

      '<button class="chip" data-status="converted">üèÜ Converted</button>' +
      '<button class="chip" data-status="hot">üî• Hot</button>' +
      '<button class="chip" data-status="warm">üåû Warm</button>' +
      '<button class="chip" data-status="cold">üßä Cold</button>' +
      '<button class="chip" data-status="follow-up">‚è≥ Follow-Up</button>' +
      '<button class="chip" data-status="research">üîç Research</button>' +
      '<button class="chip" data-status="unspecified">‚ö™ Unspecified</button>' +

      '<button id="accountsReset" class="chip" style="margin-left:4px;">Reset</button>' +

      '<div id="accountsCount" style="margin-left:auto; font-size:12px; color:#6b7280;">Showing ' + accounts.length + ' of ' + accounts.length + ' accounts</div>' +
    '</div>' +

    '<div id="accountsList" style="display:flex; flex-direction:column; gap:8px;"></div>';

  // ‚úÖ DOM refs AFTER injection
  let listEl   = document.getElementById('accountsList');
  let searchEl = document.getElementById('accountsSearch');
  let tagEl    = document.getElementById('accountsTagFilter');
  let sortEl   = document.getElementById('accountsSort');
  let countEl  = document.getElementById('accountsCount');
  
    let headerCountEl = document.getElementById('accountsHeaderCount');

  // ‚úÖ Sort toggle (persists)
  try {
    const pref = String(localStorage.getItem('DS_ACCOUNTS_SORT') || 'recent').toLowerCase();
    if (sortEl) sortEl.value = (pref === 'hottest') ? 'hottest' : 'recent';
    sortEl?.addEventListener('change', () => {
      const v = String(sortEl.value || 'recent').toLowerCase();
      localStorage.setItem('DS_ACCOUNTS_SORT', v === 'hottest' ? 'hottest' : 'recent');
      window.renderAccountsView?.();
    });
  } catch (e) {}


  function buildExpandedTable(accountObj) {
    const leadsRaw = Array.isArray(accountObj.leads) ? accountObj.leads.slice() : [];

    // Sort: hottest first (Converted/Hot/Warm...), then most recent touch
    function statusOrder(status) {
      const k = String(status || 'Unspecified').trim().toLowerCase();
      return STATUS_ORDER[k] ?? 99;
    }
    function recencyMs(lead) {
      const ms = Number(lead.recencyMs || 0);
      if (ms) return ms;
      // fallback to lastTouchAt strings if present
      const t = String(lead.lastTouchAt || lead.last_touch_at || lead.last_touched || '').trim();
      const d = Date.parse(t);
      return isNaN(d) ? 0 : d;
    }

    const leads = leadsRaw
      .map(l => ({
        ...l,
        id: (l.id || l.ID || l.lead_id || l.leadId || l.uuid) || l.lead_id || l.uuid || '',
        role: dsEnumRole(l.role || l.Role || l.title || l.Title || ''),
        status: dsNormStatus(l.status || l.Status || 'Unspecified'),
        name: String(l.name || l.Name || '').trim() || '‚Äî',
        title: String(l.title || l.Title || '').trim(),
        lastTouch: String(l.lastTouch || l.recencyText || '').trim() || String(l.last_touch || '').trim() || '‚Äî',
        recencyMs: recencyMs(l)
      }))
      .sort((a,b) => {
        const oa = statusOrder(a.status);
        const ob = statusOrder(b.status);
        if (oa !== ob) return oa - ob;
        return (b.recencyMs || 0) - (a.recencyMs || 0);
      });

    const roleOptions = coreRoles.map(r => `<option value="${r}">${r}</option>`).join('');
    const statusOptions = ['Converted','Hot','Warm','Follow-Up','Research','Cold','Unspecified'];

    let html = '';
    html += '<div class="acct-leads-wrap">';
    html +=   '<table class="acct-leads-table">';
    html +=     '<thead><tr>' +
                  '<th style="width:24%;">Role</th>' +
                  '<th style="width:44%;">Name</th>' +
                  '<th style="width:20%;">Status</th>' +
                  '<th style="width:12%; text-align:right;">Recency</th>' +
                '</tr></thead>';
    html +=     '<tbody>';

    if (!leads.length) {
      html += '<tr><td colspan="4" class="muted" style="padding:12px 10px;">No people at this account yet.</td></tr>';
    } else {
      for (const lead of leads) {
        const leadId = String(lead.id || '').trim();
        const safeId = safe(leadId);
        const safeName = safe(lead.name || '‚Äî');
        const safeRecency = safe(lead.lastTouch || '‚Äî');
        const roleVal = dsEnumRole(lead.role || '');
        const statusVal = dsNormStatus(lead.status || 'Unspecified');

        html += '<tr class="acct-person-row" data-lead-id="' + safeId + '">';

        // Role (dropdown)
        html += '<td>';
        if (leadId) {
          html += '<select class="acct-role-select" data-lead-id="' + safeId + '">' +
                    `<option value="">Select role</option>` +
                    coreRoles.map(r => `<option value="${r}" ${(r===roleVal)?'selected':''}>${r}</option>`).join('') +
                  '</select>';
        } else {
          html += '<span style="font-weight:600;">' + safe(roleVal || '‚Äî') + '</span>';
        }
        html += '</td>';

        // Name (inline editable) + small subtitle if title exists and differs
        html += '<td>';
        if (leadId) {
          html += '<div class="acct-name-cell">' +
                    '<input class="acct-name-input" data-lead-id="' + safeId + '" type="text" value="' + safe(dsTitleCaseName(lead.name || '')) + '" />' +
                    '<button class="acct-person-delete" data-lead-id="' + safeId + '" title="Delete person" aria-label="Delete person">üóëÔ∏è</button>' +
                  '</div>';
        } else {
          html += '<div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">' +
                    '<span>' + safeName + '</span>' +
                  '</div>';
        }
        const title = String(lead.title || '').trim();
        if (title && title.toLowerCase() !== String(lead.name||'').toLowerCase()) {
          html += '<div class="muted" style="margin-top:2px; font-size:12px;">' + safe(title) + '</div>';
        }
        html += '</td>';

        // Status dropdown
        html += '<td>';
        if (leadId) {
          html += '<select class="acct-status-select" data-lead-id="' + safeId + '">' +
                    statusOptions.map(opt => `<option value="${opt}" ${(String(opt).toLowerCase()===String(statusVal).toLowerCase())?'selected':''}>${opt}</option>`).join('') +
                  '</select>';
        } else {
          html += statusEmoji(statusVal) + ' ' + safe(statusVal);
        }
        html += '</td>';

        // Recency
        html += '<td style="text-align:right; color:#6b7280; white-space:nowrap;">' + safeRecency + '</td>';

        html += '</tr>';
      }
    }

    html +=     '</tbody>';
    html +=   '</table>';
    html += '</div>';
    return html;
  }

  function rowHTML(a) {
    const c = a.counts || {};
    const companySafe = safe(a.company);

    const industry = safe(a.industry || '');
    const state = safe(a.state || '');

    const tzRaw = String(a.tz || '').toUpperCase();
    const tz = safe(tzRaw);
    const tzClass = 'tz-' + (tzRaw || 'UNKNOWN');
	
	const websiteRaw = (a.website && String(a.website).trim()) ? String(a.website).trim() : '';
    const websiteHref = websiteRaw ? hrefSafe(websiteRaw) : '';


    return (
      '<div class="acct-row" data-company="' + companySafe + '" data-open="false" ' +
        'style="text-align:left; width:100%; background:#fff; border:1px solid #e5e7eb; border-radius:14px;' +
               'padding:12px 14px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.06);">' +

        '<div class="acct-header" style="display:flex; justify-content:space-between; gap:12px; align-items:center;">' +
          '<div style="display:flex; align-items:center; gap:10px;">' +
            '<div class="acct-chevron" style="font-size:14px; color:#6b7280;">‚ñ∏</div>' +

            '<span title="' + safe(a.healthTooltip || "") + '" ' +
              'style="display:inline-block; width:10px; height:10px; border-radius:999px; background:' +
                (a.health === "healthy" ? "#16a34a" : (a.health === "stalled" ? "#ef4444" : "#f59e0b")) +
                '; margin-right:2px;">' +
            '</span>' +

            '<div style="display:flex; flex-direction:column; gap:4px;">' +

              '<div style="display:grid; grid-template-columns: 320px auto; column-gap:14px; align-items:center;">' +
                '<div style="font-weight:700; font-size:14px; color:#111827; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">' +
 companySafe +
'</div>' +
(industry ? ('<span class="acct-industry" style="white-space:nowrap;">' + industry + '</span>') : '') +
(websiteHref ? ('<a class="acct-website" href="' + websiteHref + '" target="_blank" rel="noopener noreferrer" ' +
  'style="white-space:nowrap; font-size:12px; color:#2563eb; text-decoration:none; margin-left:8px;" ' +
  'title="' + safe(websiteRaw) + '">üåê Website</a>') : '') +

              '</div>' +

              '<div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">' +
                (tz ? ('<span class="state-pill ' + tzClass + '">' + tz + '</span>') : '') +
                (state ? ('<span class="state-pill ' + tzClass + '">' + state + '</span>') : '') +
              '</div>' +

            '</div>' +
          '</div>' +

          '<div style="display:flex; align-items:center; gap:10px;">' +  '<div style="font-size:12px; color:#6b7280;">' + (a.total || 0) + ' leads</div>' +  '<button class="acct-delete-btn" data-company="' + companySafe + '" title="Delete account from Deli" ' +    'style="border:1px solid #e5e7eb; background:#fff; color:#ef4444; border-radius:10px; padding:6px 8px; font-size:12px; cursor:pointer;">üóëÔ∏è</button>' +'</div>' +
        '</div>' +

        '<div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:#111827;">' +
          '<span>üî• ' + (c.hot || 0) + '</span>' +
          '<span>üåû ' + (c.warm || 0) + '</span>' +
          '<span>üßä ' + (c.cold || 0) + '</span>' +
          '<span>üîç ' + (c.research || 0) + '</span>' +
          '<span>‚è≥ ' + (c.followup || 0) + '</span>' +
          '<span>üèÜ ' + (c.converted || 0) + '</span>' +
        '</div>' +

        '<div class="acct-expanded" style="display:none;"></div>' +
      '</div>'
    );
  }

  function getActiveSet(selector, attr) {
    const set = new Set();
    document.querySelectorAll(selector).forEach(el => {
      if (!el.classList.contains('active')) return;
      const v = el.getAttribute(attr);
      if (v) set.add(String(v).toUpperCase());
    });
    return set;
  }

  function matchesStatus(accountObj, activeStatuses) {
    if (!activeStatuses || activeStatuses.size === 0) return true;
    const c = accountObj.counts || {};
    const norm = (k) => String(k || '').toLowerCase().replace(/[^a-z]/g, '');

    for (const raw of activeStatuses) {
      const key = norm(raw);
      if ((c[key] || 0) > 0) return true;
    }
    return false;
  }

  function renderList() {
    const q = String(searchEl?.value || '').trim().toLowerCase();
    const tagQ = String(tagEl?.value || '').trim().toLowerCase();

    const activeTzs = getActiveSet('#accountsToolbar .chip[data-tz]', 'data-tz');
    const activeStatuses = getActiveSet('#accountsToolbar .chip[data-status]', 'data-status');

    const filtered = accounts.filter(a => {
      if (q) {
        const leadHay = (a.leads || []).map(l => [l.name, l.role, l.title].join(' ')).join(' ');
        const hay = [
          a.company || '',
          a.industry || '',
          a.state || '',
          a.tz || '',
          leadHay
        ].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }

      if (tagQ) {
        const industry = String(a.industry || '').toLowerCase();
        const state = String(a.state || '').toLowerCase();
        if (!industry.includes(tagQ) && !state.includes(tagQ)) return false;
      }

      if (activeTzs.size) {
        const tz = String(a.tz || 'UNKNOWN').toUpperCase();
        if (!activeTzs.has(tz)) return false;
      }

      if (!matchesStatus(a, activeStatuses)) return false;
      return true;
    });

       const totalAccounts = accounts.length;
    const countText = `Showing ${filtered.length} of ${totalAccounts} accounts`;

    if (countEl) countEl.textContent = countText;
    if (headerCountEl) headerCountEl.textContent = countText;


    if (!filtered.length) {
      listEl.innerHTML = '<div style="padding:12px; color:#6b7280; font-size:13px;">No matches.</div>';
      return;
    }

    listEl.innerHTML = filtered.map(rowHTML).join('');
  }

  renderList();

  // Delete account (archives company locally + removes its leads from current session)
  document.querySelectorAll('.acct-delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const company = String(btn.dataset.company || '').trim();
      if (!company) return;
      const ok = confirm(`Delete "${company}" from Deli?\n\nThis hides the account and removes its leads locally (persisted on this browser).`);
      if (!ok) return;

      // Persist archive list
      try {
        const key = 'DS_ARCHIVED_COMPANIES';
        const prev = JSON.parse(localStorage.getItem(key) || '[]');
        const set = new Set(Array.isArray(prev) ? prev.map(s => String(s||'').toLowerCase()) : []);
        set.add(company.toLowerCase());
        localStorage.setItem(key, JSON.stringify(Array.from(set)));
      } catch (err) {
        console.warn('Archive save failed', err);
      }

      // Remove from in-memory rows (so List/Map update immediately)
      const DS = window.DS || {};
      if (DS.state && Array.isArray(DS.state.rawRows)) {
        DS.state.rawRows = DS.state.rawRows.filter(r => String(r.company ?? r.Company ?? '').trim().toLowerCase() !== company.toLowerCase());
      }
      if (DS.state && Array.isArray(DS.state.filtered)) {
        DS.state.filtered = DS.state.filtered.filter(r => String(r.company ?? r.Company ?? '').trim().toLowerCase() !== company.toLowerCase());
      }

      // If the Account 360 drawer is open for this account, close it
      const drawer = document.getElementById('accountDrawer');
      if (drawer && drawer.classList.contains('open')) {
        const activeCompany = String(document.getElementById('accountCompany')?.textContent || '').trim();
        if (activeCompany && activeCompany.toLowerCase() === company.toLowerCase()) {
          closeAccountDrawer();
        }
      }

      // Re-render all views
      if (typeof window.renderAccountsView === 'function') window.renderAccountsView();
      if (typeof window.renderListView === 'function') window.renderListView();
      if (typeof window.renderMapView === 'function') window.renderMapView();
    });
  });

  searchEl?.addEventListener('input', renderList);
  tagEl?.addEventListener('input', renderList);

  document.querySelectorAll('#accountsToolbar .chip[data-status]').forEach(btn => {
    btn.addEventListener('click', () => { btn.classList.toggle('active'); renderList(); });
  });

  document.querySelectorAll('#accountsToolbar .chip[data-tz]').forEach(btn => {
    btn.addEventListener('click', () => { btn.classList.toggle('active'); renderList(); });
  });

  document.getElementById('accountsReset')?.addEventListener('click', () => {
    document.querySelectorAll('#accountsToolbar .chip.active').forEach(b => b.classList.remove('active'));
    if (searchEl) searchEl.value = '';
    if (tagEl) tagEl.value = '';
    renderList();
  });

  // Expand (chevron click) + Open Account Drawer (row click)
  if (listEl) {
    function setSelectedAccountRow(rowEl) {
      listEl.querySelectorAll('.acct-row.is-selected').forEach(r => r.classList.remove('is-selected'));
      if (rowEl) rowEl.classList.add('is-selected');
    }

function openDrawerForAccount(acct) {
  if (!acct) return;
    window.DS_ACTIVE_ACCOUNT = acct;
  window.DS_ACTIVE_COMPANY = acct.company || '';


  const companyEl = document.getElementById('accountCompany');
  const metaEl = document.getElementById('accountMeta');

  if (companyEl) companyEl.textContent = acct.company || '‚Äî';

  const leadCount = Array.isArray(acct.leads) ? acct.leads.length : 0;

  // Rollups you care about most
  const hotCount = Number(acct.counts?.hot || 0);
  const warmCount = Number(acct.counts?.warm || 0);

  const topState = acct.state || (acct.leads?.[0]?.state || '‚Äî');
  const topIndustry =
    acct.industry ||
    (acct.leads?.map(l => String(l.industry || '').trim()).find(Boolean) || '‚Äî');

  if (metaEl) {
    metaEl.textContent =
      `${topIndustry} ‚Ä¢ ${topState} ‚Ä¢ ${leadCount} lead${leadCount === 1 ? '' : 's'} ‚Ä¢ üî• ${hotCount} ‚Ä¢ üåû ${warmCount}`;
  }

  // Most recent lead activity + note
  let mostRecentLead = null;
  (acct.leads || []).forEach(l => {
    if (!mostRecentLead || (l.recencyMs || 0) > (mostRecentLead.recencyMs || 0)) mostRecentLead = l;
  });

  const recencyEl = document.getElementById('accountRecency');
  if (recencyEl) recencyEl.textContent = 'Last touched: ' + (mostRecentLead?.recencyText || '‚Äî');

  const noteEl = document.getElementById('accountLatestNote');
  if (noteEl) {
    const note = mostRecentLead?.notes?.trim();
    if (!note) noteEl.textContent = '‚Äî';
    else {
      const singleLine = note.replace(/\s+/g, ' ');
      noteEl.textContent =
        (mostRecentLead?.name ? mostRecentLead.name + ': ' : '') +
        (singleLine.length > 180 ? singleLine.slice(0, 180) + '‚Ä¶' : singleLine);
    }
  }

  // Leads table
  const tableEl = document.getElementById('accountLeadsTable');
  if (tableEl) tableEl.innerHTML = buildExpandedTable(acct);

  // Coverage strip
  try { dsRenderCoverageStrip(acct); } catch(e) {}

  openAccountDrawer();
}

// Expose Account 360 opener globally for delegated handlers
try { window.openDrawerForAccount = openDrawerForAccount; } catch(e) {}



// ================================
// Account 360 Person Row Controls (Delegated)
// ================================
(function wireAccountPersonControls(){
  if (window.__DS_PERSON_CONTROLS_WIRED) return;
  window.__DS_PERSON_CONTROLS_WIRED = true;

  function normLeadId(x){ return String(x || '').trim(); }

  function patchLeadEverywhere(leadId, partial){
    const id = normLeadId(leadId);
    if (!id) return;

    // Persist patch (works for imported + manual; manual also updated below)
    try { dsUpsertLeadPatch(id, partial); } catch(e){}

    // Update DS.state rows in-memory
    const DS = window.DS || {};
    const apply = (arr) => {
      if (!Array.isArray(arr)) return;
      arr.forEach(r => {
        const rid = normLeadId(r.id ?? r.ID ?? r.lead_id ?? r.leadId ?? r.uuid);
        if (rid !== id) return;
        Object.keys(partial || {}).forEach(k => { r[k] = partial[k]; });
      });
    };
    if (DS.state) {
      apply(DS.state.rawRows);
      apply(DS.state.filtered);
    }

    // Update manual leads storage shape (if present)
    try {
      const manual = dsGetManualLeads();
      let changed = false;
      manual.forEach(m => {
        const mid = normLeadId(m.id ?? m.ID ?? m.lead_id ?? m.leadId ?? m.uuid);
        if (mid !== id) return;
        Object.keys(partial || {}).forEach(k => { m[k] = partial[k]; });
        changed = true;
      });
      if (changed) dsSetManualLeads(manual);
    } catch(e){}
  }
  function deleteLeadEverywhere(leadId, opts){
    const id = normLeadId(leadId);
    if (!id) return;

    const options = opts || {};
    const preserveAccount = (options.preserveAccount !== false); // default: true

    const DS = window.DS || {};
    const rows = (DS.state && Array.isArray(DS.state.rawRows)) ? DS.state.rawRows : [];

    // --- Snapshot company BEFORE deletion (best-effort) ---
    let leadRow = null;
    let company = '';
    try {
      leadRow = rows.find(r => normLeadId(r.id ?? r.ID ?? r.lead_id ?? r.leadId ?? r.uuid) === id) || null;
      company = String(leadRow?.company ?? leadRow?.Company ?? '').trim();
    } catch (e) {}

    // --- Preserve Account: if this is the last person at the company, upsert a Manual Account anchor ---
    try {
      if (preserveAccount && company && typeof dsUpsertManualAccount === 'function') {
        const norm = (s) => String(s || '').trim().toLowerCase();
        const companyNorm = norm(company);

        const remainingCount =
          rows
            .filter(r => norm(r.company ?? r.Company ?? '') === companyNorm)
            .filter(r => normLeadId(r.id ?? r.ID ?? r.lead_id ?? r.leadId ?? r.uuid) !== id)
            .length;

        if (remainingCount === 0) {
          const activeAcct = window.DS_ACTIVE_ACCOUNT || {};

          // Keep whatever account meta you already have (drawer > lead row > blank)
          const acct = {
            company: company,
            website: String(activeAcct.website || leadRow?.website || leadRow?.Website || '').trim(),
            city: String(activeAcct.city || leadRow?.city || leadRow?.City || '').trim(),
            state: String(activeAcct.state || leadRow?.state || leadRow?.State || '').trim(),
            industry: String(activeAcct.industry || leadRow?.industry || leadRow?.Industry || '').trim(),
            tags: Array.isArray(activeAcct.tags) ? activeAcct.tags : (Array.isArray(leadRow?.tags) ? leadRow.tags : []),
            notes: String(activeAcct.notes || leadRow?.notes || leadRow?.Notes || '').trim(),
            preservedBy: 'delete-lead',
            preservedAt: new Date().toISOString()
          };

          dsUpsertManualAccount(acct);
        }
      }
    } catch (e) {}

    // --- Delete the person (manual lead removal OR mark deleted) ---
    try {
      const manual = dsGetManualLeads();
      const before = manual.length;
      const kept = manual.filter(m => normLeadId(m.id ?? m.ID ?? m.lead_id ?? m.leadId ?? m.uuid) !== id);
      if (kept.length !== before) {
        dsSetManualLeads(kept);
      } else {
        dsAddDeletedLeadId(id);
      }
    } catch(e){
      try { dsAddDeletedLeadId(id); } catch(_){}
    }

    // --- Remove from in-memory DS state immediately so UI updates without a full refresh ---
    try {
      if (DS.state && Array.isArray(DS.state.rawRows)) {
        DS.state.rawRows = DS.state.rawRows.filter(r => normLeadId(r.id ?? r.ID ?? r.lead_id ?? r.leadId ?? r.uuid) !== id);
      }
      if (DS.state && Array.isArray(DS.state.filtered)) {
        DS.state.filtered = DS.state.filtered.filter(r => normLeadId(r.id ?? r.ID ?? r.lead_id ?? r.leadId ?? r.uuid) !== id);
      }
    } catch (e) {}
  }
  
  // Expose helpers globally so delegated handlers elsewhere can call them safely
  try { window.patchLeadEverywhere = patchLeadEverywhere; } catch(e){}
  try { window.deleteLeadEverywhere = deleteLeadEverywhere; } catch(e){}

function refreshAfterEdit(){
    const company = String(window.DS_ACTIVE_COMPANY || '').trim();
    // Re-render Accounts list (rollups, sorting, counts)
    try { window.renderAccountsView?.(); } catch(e){}
    // If drawer is open, re-open it for the same company so Recent Activity + table refresh
    setTimeout(() => {
      const drawer = document.getElementById('accountDrawer');
      if (!drawer || !drawer.classList.contains('open')) return;
      const cache = window.DS_ACCOUNTS_CACHE;
      const acct = Array.isArray(cache) ? cache.find(a => String(a.company||'') === company) : null;
      if (acct && typeof window.openDrawerForAccount === 'function') window.openDrawerForAccount(acct);
    }, 0);
  }

  // Stop clicks on controls from bubbling into row open/close behavior
  document.addEventListener('click', (e) => {
    const ctl = e.target?.closest?.('.acct-role-select, .acct-status-select, .acct-name-input, .acct-person-delete');
    if (ctl) e.stopPropagation();
  }, true);

  // Role dropdown
  document.addEventListener('change', (e) => {
    const sel = e.target?.closest?.('.acct-role-select');
    if (!sel) return;
    const id = normLeadId(sel.getAttribute('data-lead-id'));
    const role = dsEnumRole(sel.value);
    if (!id) return;

    patchLeadEverywhere(id, { role, title: role });
    refreshAfterEdit();
  });

  // Status dropdown (also updates lastTouchAt)
  document.addEventListener('change', (e) => {
    const sel = e.target?.closest?.('.acct-status-select');
    if (!sel) return;

    const id = normLeadId(sel.getAttribute('data-lead-id'));
    if (!id) return;

    const status = dsNormStatus(sel.value);
    const today = dsTodayISO();

    // Keep both key shapes for compatibility
    patchLeadEverywhere(id, { status, lastTouchAt: today, last_touch_at: today, last_touched: today, last_touch: today });
    refreshAfterEdit();
  });

  // Name inline edit (blur + Enter)
  function commitName(input){
    const id = normLeadId(input.getAttribute('data-lead-id'));
    if (!id) return;
    const name = dsTitleCaseName(input.value);
    input.value = name; // normalize visible value
    patchLeadEverywhere(id, { name });
    refreshAfterEdit();
  }

  document.addEventListener('blur', (e) => {
    const input = e.target?.closest?.('.acct-name-input');
    if (!input) return;
    commitName(input);
  }, true);

  document.addEventListener('keydown', (e) => {
    const input = e.target?.closest?.('.acct-name-input');
    if (!input) return;
    if (e.key === 'Enter') {
      e.preventDefault();
      input.blur();
    }
  });

  // Delete person
  document.addEventListener('click', (e) => {
    const btn = e.target?.closest?.('.acct-person-delete');
    if (!btn) return;
    
    if (window.__DS_PERSON_DELETE_SOT) return; // new delete handler owns this
e.preventDefault();

    const id = normLeadId(btn.getAttribute('data-lead-id'));
    if (!id) return;

    const ok = window.confirm('Delete this person from the account?');
    if (!ok) return;

    deleteLeadEverywhere(id);
    refreshAfterEdit();
  });
})();


    function toggleExpanded(row) {
	  // Do not toggle when clicking website link
  if (event && event.target && event.target.closest('.acct-website')) {
    return;
  }
  // Do not toggle when clicking delete button
  if (event && event.target && event.target.closest('.acct-delete-btn')) {
    return;
  }

      const company = row.dataset.company;
      const isOpen = row.dataset.open === 'true';

      const chevron = row.querySelector('.acct-chevron');
      const exp = row.querySelector('.acct-expanded');
      if (!chevron || !exp) return;

      if (isOpen) {
        row.dataset.open = 'false';
        chevron.textContent = '‚ñ∏';
        exp.style.display = 'none';
        exp.innerHTML = '';
        return;
      }

      row.dataset.open = 'true';
      chevron.textContent = '‚ñæ';

      const acct = accounts.find(a => a.company === company);
      exp.innerHTML = acct ? buildExpandedTable(acct) : '';
      exp.style.display = 'block';
    }

    listEl.addEventListener('click', (e) => {
      const row = e.target.closest('.acct-row');
      if (!row) return;

      const company = row.dataset.company;
      const acct = accounts.find(a => a.company === company);

      if (e.target.closest('.acct-chevron')) {
        toggleExpanded(row);
        return;
      }

      setSelectedAccountRow(row);
      window.openDrawerForAccount(acct);
    });
  }
};
</script>


<script>
  // Redirect Start My Day ‚Üí Daily Queue
  // Normal mode: mixed stack
  // Event Mode: tag-locked stack (AFP / IOFM / etc.)
  document.addEventListener('DOMContentLoaded', () => {
    const normalBtn = document.getElementById('startMyDayBtn');
    const eventBtn  = document.getElementById('startMyDayEventBtn');
    const afpBtn    = document.getElementById('startMyDayAFPBtn'); // üèü new stadium button
    const tagSelect = document.getElementById('tagFilter'); // existing Tag filter dropdown

    // üöÄ Normal mode: ignore tags, just build the best next 20
    if (normalBtn) {
      normalBtn.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/daily-queue?autostart=1';
      });
    }

    // üéØ Event Mode: lock Daily Queue to the *current* tag
    if (eventBtn) {
      eventBtn.addEventListener('click', (e) => {
        e.preventDefault();

        if (!tagSelect) {
          alert('Set a Tag filter first (e.g. AFP Event or IOFM Event).');
          return;
        }

        const value = tagSelect.value || '';
        const trimmed = value.trim();

        if (!trimmed || trimmed.toLowerCase() === 'all') {
          alert('Choose a specific Tag (e.g. AFP Event or IOFM Event) before starting Event Mode.');
          return;
        }

        const url = '/daily-queue?autostart=1&tag=' + encodeURIComponent(trimmed);
        window.location.href = url;
      });
    }

    // üèü AFP Event Mode: hard-lock to "AFP Event" tag, regardless of current filter
    if (afpBtn) {
      afpBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const afpTag = 'AFP Event';
        const url = '/daily-queue?autostart=1&tag=' + encodeURIComponent(afpTag);
        window.location.href = url;
      });
    }
  });
</script>




<script>
(function () {
  // Grab the same filtered data used everywhere else
  function getPresentationLeads() {
    const DS = window.DS || {};
    const rows = (DS.state && (DS.state.filtered || DS.state.rawRows)) || [];
    return Array.isArray(rows) ? rows : [];
  }

  // Status funnel totals (Cold / Follow-Up / Warm / Hot / Converted)
  function bucketTotals(leads) {
    const DS = window.DS || {};
    const statusKey =
      typeof DS.statusKey === 'function'
        ? DS.statusKey
        : function fallbackStatusKey(s) {
            if (!s || typeof s !== 'string') return 'unspecified';
            const k = s.trim().toLowerCase();
            if (k.includes('convert'))  return 'converted';
            if (k.includes('hot'))      return 'hot';
            if (k.includes('warm'))     return 'warm';
            if (k.includes('cold'))     return 'cold';
            if (k.includes('research')) return 'research';
            if (k.includes('follow'))   return 'follow-up';
            return 'unspecified';
          };

    const totals = {
      cold: 0,
      follow: 0,
      warm: 0,
      hot: 0,
      converted: 0
    };

    leads.forEach((lead) => {
      const raw = lead.status || lead.Status || '';
      const key = statusKey(raw);

      switch (key) {
        case 'converted':
          totals.converted++;
          break;
        case 'hot':
          totals.hot++;
          break;
        case 'warm':
          totals.warm++;
          break;
        case 'follow-up':
          totals.follow++;
          break;
        case 'cold':
        case 'research':
          totals.cold++;
          break;
        default:
          // unspecified ‚Üí ignore in funnel
          break;
      }
    });

    return totals;
  }
  
    // üîé AFP Event Mode detector (Presentation Mode ‚Üí Event Mode)
  function isEventMode() {
    const tagSel = document.getElementById('tagFilter');
    const tag = tagSel ? tagSel.value.trim() : '';
    return tag === 'AFP Event';
  }


  // ---------- NEW: ICP Vertical Breakdown helpers ----------

  function buildIcpBreakdown(leads) {
    const DS = window.DS || {};
    const statusKey =
      typeof DS.statusKey === 'function'
        ? DS.statusKey
        : function fallbackStatusKey(s) {
            if (!s || typeof s !== 'string') return 'unspecified';
            const k = s.trim().toLowerCase();
            if (k.includes('convert'))  return 'converted';
            if (k.includes('hot'))      return 'hot';
            if (k.includes('warm'))     return 'warm';
            if (k.includes('cold'))     return 'cold';
            if (k.includes('research')) return 'research';
            if (k.includes('follow'))   return 'follow-up';
            return 'unspecified';
          };

    // Map industry strings to Finexio ICP verticals
    function industryKey(raw) {
      if (!raw || typeof raw !== 'string') return 'Other';
      const s = raw.toLowerCase();

      if (s.includes('educ'))               return 'Education';
      if (s.includes('health'))             return 'Healthcare';
      if (s.includes('gov'))                return 'Government';
      if (s.includes('hospitality')
          || s.includes('hotel')
          || s.includes('lodging')
          || s.includes('resort'))          return 'Hospitality';
      if (s.includes('construct')
          || s.includes('contractor')
          || s.includes('builder'))         return 'Construction';
      if (s.includes('manufact')
          || s.includes('factory')
          || s.includes('plant'))           return 'Manufacturing';

      return 'Other';
    }

    const buckets = {
      Education:     { total: 0, converted: 0 },
      Healthcare:    { total: 0, converted: 0 },
      Government:    { total: 0, converted: 0 },
      Hospitality:   { total: 0, converted: 0 },
      Construction:  { total: 0, converted: 0 },
      Manufacturing: { total: 0, converted: 0 },
      Other:         { total: 0, converted: 0 }
    };

    leads.forEach((lead) => {
      const rawIndustry =
        lead.industry ||
        lead.Industry ||
        lead.vertical ||
        lead.Vertical ||
        '';

      const vert = industryKey(rawIndustry);
      const statusRaw = lead.status || lead.Status || '';
      const key = statusKey(statusRaw);

      const bucket = buckets[vert] || buckets.Other;
      bucket.total++;
      if (key === 'converted') bucket.converted++;
    });

    const order = [
      'Education',
      'Healthcare',
      'Government',
      'Hospitality',
      'Construction',
      'Manufacturing',
      'Other'
    ];

const grandTotal = Object.values(buckets).reduce((sum, b) => sum + (b.total || 0), 0);

return order.map((name) => {
  const b = buckets[name];
  const pct = b.total > 0
    ? Math.round((b.converted / b.total) * 100)
    : 0;

  const share = grandTotal > 0
    ? Math.round((b.total / grandTotal) * 100)
    : 0;

  return {
    name,
    percent: pct,   // conversion rate within vertical
    leads: b.total, // count in vertical
    share           // % of total pipeline
  };
});

  }

  function renderIcpBreakdown(rows) {
    const container = document.getElementById('icp_tiles');
    if (!container) return;

    container.innerHTML = '';

    rows.forEach((row) => {
      const tile = document.createElement('div');
      tile.className = 'icp-tile';

      const label = row.leads === 1 ? '1 lead' : `${row.leads} leads`;

tile.innerHTML = `
  <div class="icp-name">${row.name.toUpperCase()}</div>
  <div class="icp-percent">${row.percent}%</div>
  <div class="icp-count">${label}</div>
  <div class="icp-share">${row.share}% of pipeline</div>
`;


      container.appendChild(tile);
    });
  }
  
    // ===== Presentation Mode: AI band notes =====
  function renderPresentationBandNotes(notes) {
    const safe = (v) => {
      if (!v) return 'No AI notes for this band yet.';
      const s = String(v).trim();
      return s || 'No AI notes for this band yet.';
    };

    const mapping = [
      { id: 'ai_note_cold_presentation',      key: 'cold' },
      { id: 'ai_note_followup_presentation',  key: 'followup' },
      { id: 'ai_note_warm_presentation',      key: 'warm' },
      { id: 'ai_note_hot_presentation',       key: 'hot' },
      { id: 'ai_note_converted_presentation', key: 'converted' }
    ];

    mapping.forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = safe(notes && notes[key]);
    });
  }
  
    // ===== Mini AI Summary for Presentation Mode =====
  function renderPresentationMiniSummary(data) {
    const line1El = document.getElementById('ai_summary_line1');
    const line2El = document.getElementById('ai_summary_line2');
    const line3El = document.getElementById('ai_summary_line3');
    const textEl  = document.getElementById('ai_summary_narrative');

    if (!line1El || !line2El || !line3El || !textEl || !data) return;

    const act     = (data.metrics && data.metrics.activity) || {};
    const pip     = (data.metrics && data.metrics.pipeline) || {};
    const byState = (data.metrics && data.metrics.perf_by_state) || [];
    const byInd   = (data.metrics && data.metrics.perf_by_industry) || [];

    const touched    = act.leads_contacted_window ?? act.leads_contacted ?? 0;
    const touches    = act.total_touches ?? 0;
    const upgrades   = pip.upgrades ?? 0;
    const downgrades = pip.downgrades ?? 0;

    // Strongest / weakest regions by traction_score (same logic as summary.js)
    let bestState = null;
    if (byState.length) {
      bestState = [...byState].sort(
        (a, b) => (b.traction_score || 0) - (a.traction_score || 0)
      )[0];
    }

    let weakestState = null;
    if (byState.length) {
      weakestState =
        [...byState]
          .filter((r) => (r.traction_score || 0) > 0)
          .sort((a, b) => (a.traction_score || 0) - (b.traction_score || 0))[0] ||
        null;
    }

    const bestName = bestState ? bestState.key : '‚Äî';
    const weakName = weakestState ? weakestState.key : '‚Äî';

    // Strongest industry by conversion pct (if available)
    let bestInd = null;
    if (byInd.length) {
      bestInd = [...byInd].sort(
        (a, b) => (b.conv_pct || 0) - (a.conv_pct || 0)
      )[0];
    }

    const inEventMode =
      typeof isEventMode === 'function' && isEventMode();

    // 3 KPI lines (different copy in Event Mode)
    if (inEventMode) {
      line1El.textContent = `üéØ AFP Event engagement: ${touched} leads touched`;
    } else {
      line1El.textContent = `üéØ ${touched} leads touched this cycle`;
    }

const range = data.range || {};
const leadsAdded = countLeadsAdded(
  data.leads || [],
  range.from,
  range.to
);


    line2El.textContent = `‚ûï ${leadsAdded} leads added | üìà ${upgrades} upgrades | üìâ ${downgrades} downgrades`;

    line3El.textContent = `üî• Strongest region: ${bestName} | Weakest: ${weakName}`;

    // Short narrative (3‚Äì4 sentences max)
    const parts = [];

if (inEventMode) {
  parts.push(
    `Across AFP Event accounts, you contacted ${touched} lead${touched === 1 ? '' : 's'} over ${touches} total touches in this window.`
  );
} else {
  parts.push(
    `You contacted ${touched} lead${touched === 1 ? '' : 's'} across ${touches} total touches in this window.`
  );
}

    if (upgrades || downgrades) {
      parts.push(
        `Status movement shows ${upgrades} upgrade${upgrades === 1 ? '' : 's'} and ${downgrades} downgrade${downgrades === 1 ? '' : 's'}.`
      );
    }

    if (bestInd && bestInd.key) {
      parts.push(
        `The strongest converting vertical is ${bestInd.key} at ${bestInd.conv_pct || 0}% conversion.`
      );
    }

    if (bestName !== '‚Äî' || weakName !== '‚Äî') {
      parts.push(
        `Regional traction is highest in ${bestName} and softer in ${weakName}, which can guide where you focus the next wave of outreach.`
      );
    }

    const narrative = parts.join(' ');
    textEl.textContent =
      narrative ||
      'No activity in this window yet ‚Äî once you log touches, AI-style insights will appear here.';
  }

  
    // üèÜ Converted-only Trophy Panel
  function renderPresentationTrophyPanel(summaryJson) {
    const totalEl   = document.getElementById('trophy_converted_total');
    const winsEl    = document.getElementById('trophy_top_wins');
    const insightEl = document.getElementById('trophy_insight');

    if (!totalEl || !winsEl || !insightEl) return;

    const DS = window.DS || {};
    const leads = Array.isArray(DS.presentationLeads) ? DS.presentationLeads : [];

    // Reuse the same statusKey logic as the funnel
    const statusKey =
      typeof DS.statusKey === 'function'
        ? DS.statusKey
        : function fallbackStatusKey(s) {
            if (!s || typeof s !== 'string') return 'unspecified';
            const k = s.trim().toLowerCase();
            if (k.includes('convert'))  return 'converted';
            if (k.includes('hot'))      return 'hot';
            if (k.includes('warm'))     return 'warm';
            if (k.includes('cold'))     return 'cold';
            if (k.includes('research')) return 'research';
            if (k.includes('follow'))   return 'follow-up';
            return 'unspecified';
          };

    const converted = leads.filter((lead) => {
      const raw = lead.status || lead.Status || '';
      return statusKey(raw) === 'converted';
    });

    // Big KPI
    totalEl.textContent = converted.length.toString();

    // Top wins list
    winsEl.innerHTML = '';

    if (!converted.length) {
      winsEl.innerHTML = `
        <div class="trophy-win trophy-win-empty">
          No converted wins in this view yet.
        </div>
      `;
      insightEl.textContent =
        'Once you log converted wins in this filtered window, a quick insight will appear here.';
      return;
    }

    // Score converted leads by AP Spend (or ARR fallback) to pick "top wins"
    const scored = converted.map((lead) => {
      const ap  = Number(lead.ap_spend || lead.AP_SPEND || 0) || 0;
      const arr = Number(lead.arr || lead.ARR || 0) || 0;
      const score = ap || arr;
      return { lead, score };
    });

    const hasScore = scored.some((s) => s.score > 0);
    const sorted = hasScore
      ? scored.slice().sort((a, b) => b.score - a.score)
      : scored;

    const top = sorted.slice(0, 3);

    top.forEach(({ lead }) => {
      const company =
        lead.company ||
        lead.Company ||
        lead.account ||
        lead['Company / Account'] ||
        'Unnamed company';

      const city =
        lead.city ||
        lead.City ||
        '';

      const state =
        lead.state ||
        lead.State ||
        lead['State/Province'] ||
        '';

      const location = [city, state].filter(Boolean).join(', ');

      const row = document.createElement('div');
      row.className = 'trophy-win';
      row.innerHTML = `
        <div class="trophy-win-company">üè¢ ${company}</div>
        <div class="trophy-win-location">
          ${location || 'Location not set'}
        </div>
      `;
      winsEl.appendChild(row);
    });

    // Insight line: reuse summary metrics (strongest industry + region)
    const byInd   = summaryJson.metrics?.perf_by_industry || [];
    const byState = summaryJson.metrics?.perf_by_state || [];

    let bestInd = null;
    if (byInd.length) {
      bestInd = [...byInd].sort(
        (a, b) => (b.conv_pct || 0) - (a.conv_pct || 0)
      )[0];
    }

    let bestState = null;
    if (byState.length) {
      bestState = [...byState].sort(
        (a, b) => (b.traction_score || 0) - (a.traction_score || 0)
      )[0];
    }

    const verticalPart = bestInd?.key || '';
    const regionPart   = bestState?.key || '';

    let text = '';
    if (verticalPart && regionPart) {
      text = `Most conversions in this view came from ${verticalPart} in ${regionPart}.`;
    } else if (verticalPart) {
      text = `Most conversions in this view came from ${verticalPart}.`;
    } else if (regionPart) {
      text = `Most conversions in this view were concentrated in ${regionPart}.`;
    } else {
      text = 'Conversions in this window are still too light to surface a clear pattern yet.';
    }

    insightEl.textContent = text;
  }



// ===== Pull AI summary + band notes from /summary and render into Presentation Mode =====
async function loadPresentationBandNotesFromSummary() {
  try {
    const fromInput = document.getElementById('startDate');
    const toInput   = document.getElementById('endDate');
    const tagSelect = document.getElementById('tagFilter');

    const from = fromInput?.value;
    const to   = toInput?.value;
    const tag  = tagSelect?.value && tagSelect.value !== 'All'
      ? tagSelect.value
      : '';

    // If there‚Äôs no date range, don‚Äôt try to pull AI notes
    if (!from || !to) {
      console.log('[Presentation AI] No date range selected; skipping /summary call.');
      return;
    }

    // Build /summary URL with same filters as the main bar
    const params = new URLSearchParams();
    params.set('from', from);
    params.set('to', to);
    if (tag) params.set('tag', tag);

    const url = `/summary?${params.toString()}`;
    console.log('[Presentation AI] Fetching summary from:', url);

    const res = await fetch(url);
    if (!res.ok) {
      console.warn('[Presentation AI] /summary returned non-OK status:', res.status);
      return;
    }

    const data = await res.json();
    console.log('[Presentation AI] Summary payload:', data);

    // 1) Mini 3-line AI block at the top
    try {
      renderPresentationMiniSummary(data);
    } catch (err) {
      console.warn('[Presentation AI] Mini summary render failed:', err);
    }

    // 2) Per-band notes (Cold / Follow-Up / Warm / Hot / Converted)
    try {
      const notes = (data && data.ai_band_notes) || {};
      renderPresentationBandNotes(notes);
      console.log('[Presentation AI] Band notes updated from /summary.');
    } catch (err) {
      console.warn('[Presentation AI] Band notes render failed:', err);
    }
  } catch (err) {
    console.error('[Presentation AI notes/summary failed]:', err);
  }
}  

function countLeadsAdded(leads, from, to) {
  if (!Array.isArray(leads)) return 0;

  const start = new Date(from + "T00:00:00");
  const end   = new Date(to   + "T23:59:59");

  return leads.filter(l => {
    if (!l.created_at) return false;
    const d = new Date(l.created_at);
    return d >= start && d <= end;
  }).length;
}







  // ---------- Open / close handlers ----------

  async function openPresentationMode() {
    const leads  = getPresentationLeads();
    const totals = bucketTotals(leads);

    // Make the current presentation dataset available to the trophy panel
    window.DS = window.DS || {};
    window.DS.presentationLeads = leads;

    const total        = leads.length;
    const addedInRange = total; // later we can refine to ‚Äúnew in range‚Äù

    // ---- Title + Date Range (AFP-aware) ----
    const elRange = document.getElementById('pipeline_range');

    // Format the date range
    const from = document.getElementById('startDate')?.value;
    const to   = document.getElementById('endDate')?.value || from;

    function formatDate(d) {
      if (!d) return '';
      const obj = new Date(d + 'T00:00:00');
      return obj.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric'
      });
    }

    const inEventMode =
      typeof isEventMode === 'function' && isEventMode();

    if (elRange) {
      if (from) {
        const fromTxt = formatDate(from);
        const toTxt   = to ? formatDate(to) : fromTxt;
        const prefix  = inEventMode ? 'AFP Event ‚Ä¢ ' : '';
        elRange.textContent = `${prefix}${fromTxt} ‚Äì ${toTxt}`;
      } else {
        elRange.textContent = inEventMode
          ? 'AFP Event (no date range selected)'
          : '';
      }
    }

    // Update title line with correct label + total
    const titleEl = document.querySelector('.presentation-title');
    if (titleEl) {
      const headingLabel = inEventMode ? 'AFP Event Pipeline' : 'Current Pipeline';
      titleEl.innerHTML = `${headingLabel} (<span id="pipeline_total">${total}</span> Prospects)`;
    }

    // ---- Funnel bands (counts + percentages) ----
    const elCold   = document.getElementById('funnel_cold');
    const elFollow = document.getElementById('funnel_followup');
    const elWarm   = document.getElementById('funnel_warm');
    const elHot    = document.getElementById('funnel_hot');
    const elConv   = document.getElementById('funnel_converted');

    const elColdPct   = document.getElementById('funnel_cold_pct');
    const elFollowPct = document.getElementById('funnel_followup_pct');
    const elWarmPct   = document.getElementById('funnel_warm_pct');
    const elHotPct    = document.getElementById('funnel_hot_pct');
    const elConvPct   = document.getElementById('funnel_converted_pct');

    if (elCold)   elCold.textContent   = totals.cold;
    if (elFollow) elFollow.textContent = totals.follow;
    if (elWarm)   elWarm.textContent   = totals.warm;
    if (elHot)    elHot.textContent    = totals.hot;
    if (elConv)   elConv.textContent   = totals.converted;

    const funnelTotal =
      totals.cold + totals.follow + totals.warm + totals.hot + totals.converted;

    function formatPct(count) {
      if (!funnelTotal) return '0%';
      const pct = Math.round((count / funnelTotal) * 100);
      return `${pct}%`;
    }

    if (elColdPct)   elColdPct.textContent   = formatPct(totals.cold);
    if (elFollowPct) elFollowPct.textContent = formatPct(totals.follow);
    if (elWarmPct)   elWarmPct.textContent   = formatPct(totals.warm);
    if (elHotPct)    elHotPct.textContent    = formatPct(totals.hot);
    if (elConvPct)   elConvPct.textContent   = formatPct(totals.converted);

    // NEW: update ICP tiles
    const icpRows = buildIcpBreakdown(leads);
    renderIcpBreakdown(icpRows);

    // üß† NEW: pull AI notes for each band (now AFP-aware via tag parameter)
    await loadPresentationBandNotesFromSummary();

    // Show overlay
    const overlay = document.getElementById('presentation-overlay');
    if (overlay) overlay.classList.remove('hidden');
  }



  function closePresentationMode() {
    const overlay = document.getElementById('presentation-overlay');
    if (overlay) overlay.classList.add('hidden');
  }
  

  // üëâ When you click a funnel band, we close Presentation Mode,
  //    jump to List View, and auto-filter to that status.
function drillDownToStatus(statusLabel) {
  // 1) Switch to List View
  const listBtn = document.getElementById('btnListView');
  if (listBtn) listBtn.click();

  // 2) After List View is visible, activate the right status chips
  setTimeout(() => {
    // Clear active chips
    document
      .querySelectorAll('#listToolbar .chip[data-status]')
      .forEach((btn) => btn.classList.remove('active'));

    // Normalize the funnel label ‚Üí chip keys
    const label = String(statusLabel || '').trim().toLowerCase();
    let targets = [];

    if (label === 'cold') {
      // Cold funnel represents Cold + Research
      targets = ['cold', 'research'];
    } else if (label === 'follow-up' || label === 'followup' || label === 'follow up') {
      targets = ['follow-up'];
    } else if (label === 'warm') {
      targets = ['warm'];
    } else if (label === 'hot') {
      targets = ['hot'];
    } else if (label === 'converted') {
      targets = ['converted'];
    } else {
      // fallback: try the normalized label directly
      targets = [label];
    }

    // Activate chips
    targets.forEach((key) => {
      const chip = document.querySelector(`#listToolbar .chip[data-status="${key}"]`);
      if (chip) chip.classList.add('active');
    });

    // Clear search box so we see the full slice
    const search = document.getElementById('listSearch');
    if (search) search.value = '';

    // Re-render
    if (typeof window.renderListView === 'function') {
      window.renderListView();
    }

    // Scroll table to top
    const wrap = document.getElementById('leadTableWrap');
    if (wrap) wrap.scrollTop = 0;
  }, 60);
}



  document.addEventListener('DOMContentLoaded', () => {
    const launchBtn = document.getElementById('launchPresentation');
    const closeBtn  = document.getElementById('presentation-close');
    const overlay   = document.getElementById('presentation-overlay');

    if (launchBtn) {
      launchBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await openPresentationMode();
        } catch (err) {
          console.error('Error opening presentation mode:', err);
        }
      });
    }

    // Close when clicking the ‚úñ button
    if (closeBtn) {
      closeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closePresentationMode();
      });
    }

    // Optional: click on dim background closes too
    if (overlay) {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          closePresentationMode();
        }
      });
    }

    // Escape key closes Presentation Mode
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closePresentationMode();
      }
    });

    // ‚≠ê NEW: Wire funnel bands ‚Üí drill-down into List View
    document
      .querySelectorAll('.funnel-band[data-status]')
      .forEach((band) => {
        band.addEventListener('click', () => {
          const status = band.getAttribute('data-status');
          if (!status) return;

          // Close Presentation overlay
          closePresentationMode();

          // Drill down into the right slice in List View
          drillDownToStatus(status);
        });
      });
  });





  // Optional: expose globally if needed
  window.openPresentationMode = openPresentationMode;
})();

console.log("‚úÖ index.html script fully loaded");
</script>

<script>
  // Fallback: hide the logo while Presentation Mode is open
  (function () {
    const logo = document.getElementById('logo');
    const overlay = document.getElementById('presentation-overlay');
    if (!logo || !overlay) return;

    const sync = () => {
      const isOpen = !overlay.classList.contains('hidden');
      logo.style.display = isOpen ? 'none' : '';
    };

    sync();

    const mo = new MutationObserver(sync);
    mo.observe(overlay, { attributes: true, attributeFilter: ['class'] });
  })();
</script>

<!-- ============================= -->
<!-- Account View Drawer (UI only) -->
<!-- ============================= -->

<!-- ============================= -->
<!-- Add Account Modal (Account-first creation) -->
<!-- ============================= -->
<div id="addAccountModal" class="ds-modal hidden" aria-hidden="true">
  <div class="ds-modal-backdrop" data-close="1"></div>

  <div class="ds-modal-card" role="dialog" aria-modal="true" aria-label="Add Account">
    <div class="ds-modal-head">
      <div style="font-weight:700;">Add Account</div>
      <button type="button" id="addAccountCloseBtn" class="ds-modal-x" aria-label="Close">‚úï</button>
    </div>

    <div class="ds-modal-body">
      <div class="ds-field">
        <label class="ds-label">Company <span style="color:#ef4444;">*</span></label>
        <input id="aa_company" class="ds-input" type="text" placeholder="e.g., Eli Lilly and Company" />
      </div>

      <div class="ds-grid2">
        <div class="ds-field">
          <label class="ds-label">Website</label>
          <input id="aa_website" class="ds-input" type="text" placeholder="e.g., elililly.com" />
        </div>
        <div class="ds-field">
          <label class="ds-label">Industry</label>
          <select id="aa_industry" class="ds-input">
            <option value="">Select industry‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="ds-grid3">
        <div class="ds-field">
          <label class="ds-label">City</label>
          <input id="aa_city" class="ds-input" type="text" placeholder="City" />
        </div>
        <div class="ds-field">
          <label class="ds-label">State</label>
          <select id="aa_state" class="ds-input">
            <option value="">Select state‚Ä¶</option>
          </select>
        </div>
        <div class="ds-field">
          <label class="ds-label">Tags</label>
          <input id="aa_tags" class="ds-input" type="text" placeholder="Comma-separated tags" />
        </div>
      </div>

      <div class="ds-field">
        <label class="ds-label">Notes</label>
        <textarea id="aa_notes" class="ds-textarea" placeholder="Optional account notes"></textarea>
      </div>

      <div id="aa_error" style="display:none; margin-top:8px; color:#b91c1c; font-size:12px;"></div>
    </div>

    <div class="ds-modal-foot">
      <button type="button" id="addAccountCancelBtn" class="ds-btn">Cancel</button>
      <button type="button" id="addAccountSaveBtn" class="ds-btn primary">Save Account</button>
    </div>
  </div>
</div>


<div id="accountDrawer" class="account-drawer hidden">
  <div class="account-drawer-header">
    <div>
      <h2 id="accountCompany">Company Name</h2>
      <div id="accountMeta" class="muted">
        Vertical ‚Ä¢ State ‚Ä¢ 0 Leads
      </div>
    </div>
     <button id="closeAccountDrawer" type="button" aria-label="Close drawer">‚úï</button>
  </div>

  <div class="account-drawer-actions" style="display:flex; gap:10px; flex-wrap:wrap;">
    <button id="drawerAddPersonBtn" type="button">‚ûï Add Person</button>
    <button id="drawerDeleteAccountBtn" type="button" style="border:1px solid #ef4444; color:#ef4444; background:#fff;">
      üóëÔ∏è Delete Account
    </button>
  </div>


  <!-- ‚úÖ NEW: scroll container so bottom sections never get cut off -->

  <div class="account-drawer-content">
    <!-- ‚úÖ v1 Coverage Strip -->
    <div class="account-drawer-section">
      <div class="ds-section-head">
        <h4 style="margin:0;">Coverage</h4>
        <div id="coverageSummary" class="muted" style="font-size:12px;">0/5 filled</div>
      </div>
      <div id="coverageStrip" class="coverage-strip" aria-label="Coverage by entry point"></div>
      <div class="muted" style="margin-top:8px; font-size:12px;">
        Click a missing role to add a person pre-filled to that entry point.
      </div>
    </div>
    <div class="account-drawer-section">
      <h4>Recent Activity</h4>
      <div id="accountRecency">Last touched: ‚Äî</div>
      <div id="accountLatestNote" class="muted">‚Äî</div>
    </div>

    <div class="account-drawer-section">
      <h4>Leads at This Account</h4>
      <div id="accountLeadsTable"></div>
    </div>

    <div class="account-drawer-section collapsed">
      <h4>Status History</h4>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- Add Person Modal (inside Account 360) -->
<!-- ============================= -->
<div id="addPersonModal" class="ds-modal hidden" aria-hidden="true">
  <div class="ds-modal-backdrop" data-close="1"></div>

  <div class="ds-modal-card" role="dialog" aria-modal="true" aria-label="Add Person">
    <div class="ds-modal-head">
      <div style="font-weight:700;">Add Person</div>
      <button type="button" id="addPersonCloseBtn" class="ds-modal-x" aria-label="Close">‚úï</button>
    </div>

    <div class="ds-modal-body">
      <input type="hidden" id="ap_company" />

      <div class="ds-field">
        <label class="ds-label">Name <span style="color:#ef4444;">*</span></label>
        <input id="ap_name" class="ds-input" type="text" placeholder="e.g., Jane Smith" />
      </div>

      <div class="ds-grid2">
        <div class="ds-field">
          <label class="ds-label">Role <span style="color:#ef4444;">*</span></label>
          <select id="ap_role" class="ds-input">
            <option value="">Select role</option>
            <option value="CFO">CFO</option>
            <option value="Controller">Controller</option>
            <option value="Finance">Finance</option>
            <option value="Treasury">Treasury</option>
            <option value="AP">AP</option>
          </select>
        </div>

        <div class="ds-field">
          <label class="ds-label">Status</label>
          <select id="ap_status" class="ds-input">
            <option value="Unspecified" selected>Unspecified</option>
            <option value="Converted">Converted</option>
            <option value="Hot">Hot</option>
            <option value="Warm">Warm</option>
            <option value="Follow-Up">Follow-Up</option>
            <option value="Research">Research</option>
            <option value="Cold">Cold</option>
          </select>
        </div>
      </div>

      <div class="ds-grid2">
        <div class="ds-field">
          <label class="ds-label">Tags</label>
          <input id="ap_tags" class="ds-input" type="text" placeholder="Comma-separated tags" />
        </div>
        <div class="ds-field">
          <label class="ds-label">Cadence</label>
          <input id="ap_cadence" class="ds-input" type="text" placeholder="Cadence name" />
        </div>
      </div>

      <div class="ds-field">
        <label class="ds-label">Last Touch</label>
        <input id="ap_lastTouchAt" class="ds-input" type="date" />
      </div>

      <div class="ds-field">
        <label class="ds-label">Notes</label>
        <textarea id="ap_notes" class="ds-textarea" placeholder="Optional notes"></textarea>
      </div>

      <div id="ap_error" style="display:none; margin-top:8px; color:#b91c1c; font-size:12px;"></div>
    </div>

    <div class="ds-modal-foot">
      <button type="button" id="addPersonCancelBtn" class="ds-btn">Cancel</button>
      <button type="button" id="addPersonSaveBtn" class="ds-btn primary">Save Person</button>
    </div>
  </div>
</div>




</body>
</html>

	